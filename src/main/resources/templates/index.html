<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redmine å·¥ä½œè² è¼‰çµ±è¨ˆç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .filter-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .filter-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.95em;
        }

        .form-group select,
        .form-group input[type="date"] {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
        }

        .form-group select:focus,
        .form-group input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-search {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            align-self: end;
        }

        .btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            align-self: end;
        }

        .btn-2d {
            padding: 12px 30px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-2d:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .statistics-section {
            padding: 30px;
            display: none;
        }

        .statistics-section.show {
            display: block;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: 700;
        }

        .chart-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .table-section {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-closed {
            background: #28a745;
            color: white;
        }

        .badge-open {
            background: #ffc107;
            color: #333;
        }

        .project-accordion {
            margin-top: 20px;
        }

        .project-item {
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .project-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .project-header:hover {
            background: linear-gradient(135deg, #5a73e6 0%, #6a419e 100%);
        }

        .project-title-section {
            flex: 1;
        }

        .project-title {
            font-size: 1.1em;
            font-weight: 600;
            margin: 0 0 5px 0;
        }

        .project-duration {
            margin-top: 3px;
        }

        .duration-text {
            font-size: 0.85em;
            opacity: 0.9;
            background: rgba(255, 255, 255, 0.15);
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .project-summary {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9em;
        }

        .project-cost {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .project-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
        }

        .expand-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }

        .project-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: white;
        }

        .project-content.expanded {
            max-height: 2000px;
        }

        .issues-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .issues-table th {
            background: #f8f9fa;
            color: #495057;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            border-bottom: 2px solid #e9ecef;
        }

        .issues-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }

        .issues-table tbody tr:hover {
            background: #f8f9fa;
        }

        .issue-subject {
            max-width: 300px;
            word-wrap: break-word;
        }

        .section-title {
            padding: 20px 0;
            color: #495057;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .filter-form {
                grid-template-columns: 1fr;
            }

            .stats-cards {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }

            .project-header {
                padding: 12px 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .project-title-section {
                width: 100%;
            }

            .project-summary {
                width: 100%;
                justify-content: space-between;
            }

            .project-title {
                font-size: 1em;
                margin-bottom: 3px;
            }

            .duration-text {
                font-size: 0.75em;
                padding: 1px 6px;
            }

            .issues-table {
                font-size: 0.8em;
            }

            .issues-table th,
            .issues-table td {
                padding: 8px 6px;
            }

            .issue-subject {
                max-width: 150px;
            }

            .project-cost,
            .project-count {
                font-size: 0.8em;
                padding: 3px 8px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Redmine å·¥ä½œè² è¼‰çµ±è¨ˆç³»çµ±</h1>
            <p>å·¥ä½œè² è¼‰åˆ†æèˆ‡è¦–è¦ºåŒ–å¹³å°</p>
        </div>

        <div class="filter-section">
            <form id="workloadForm" action="/workload" method="post" class="filter-form">
                <div class="form-group">
                    <label for="groupName">éƒ¨é–€ç¾¤çµ„</label>
                    <select id="groupName" name="groupName" required onchange="loadUsers()">
                        <option value="">è«‹é¸æ“‡éƒ¨é–€</option>
                        <option th:each="group : ${groups}" 
                                th:value="${group}" 
                                th:text="${group}"
                                th:selected="${group == selectedGroup}"></option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="userFullname">ä½¿ç”¨è€… (å¯é¸)</label>
                    <select id="userFullname" name="userFullname">
                        <option value="">ğŸ¢ å…¨éƒ¨æˆå“¡ (æ•´å€‹éƒ¨é–€)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="startDate">é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate" name="startDate" 
                           th:value="${selectedStartDate != null ? selectedStartDate : defaultStartDate}" 
                           required>
                </div>

                <div class="form-group">
                    <label for="endDate">çµæŸæ—¥æœŸ</label>
                    <input type="date" id="endDate" name="endDate" 
                           th:value="${selectedEndDate != null ? selectedEndDate : defaultEndDate}" 
                           required>
                </div>

                <div class="form-group">
                    <label for="timeGranularity">æ™‚é–“é¡†ç²’åº¦</label>
                    <select id="timeGranularity" name="timeGranularity">
                        <option value="daily">ğŸ“… æ¯æ—¥</option>
                        <option value="weekly">ğŸ“Š æ¯é€±</option>
                        <option value="monthly">ğŸ“ˆ æ¯æœˆ</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn-search">ğŸ” æŸ¥è©¢çµ±è¨ˆ</button>
                    <button type="button" class="btn-2d" onclick="submit2DAnalysis()">ğŸ“Š 2Dåˆ†æ</button>
                </div>
            </form>
        </div>

        <div class="statistics-section" th:classappend="${statistics != null ? 'show' : ''}">
            <div class="stats-cards" th:if="${statistics != null}">
                <div class="stat-card">
                    <h3>ç¸½å·¥æ™‚ä¼°è¨ˆ</h3>
                    <div class="value" th:text="${statistics.totalEstimatedHours} + ' hrs'">0 hrs</div>
                </div>
                <div class="stat-card">
                    <h3>æ—¥å‡å·¥æ™‚</h3>
                    <div class="value" th:text="${statistics.avgHoursPerDay} + ' hrs'">0 hrs</div>
                </div>
                <div class="stat-card">
                    <h3>ç¸½è­°é¡Œæ•¸</h3>
                    <div class="value" th:text="${statistics.totalIssues}">0</div>
                </div>
                <div class="stat-card">
                    <h3>å·²å®Œæˆ</h3>
                    <div class="value" th:text="${statistics.closedIssues}">0</div>
                </div>
                <div class="stat-card">
                    <h3>é€²è¡Œä¸­</h3>
                    <div class="value" th:text="${statistics.openIssues}">0</div>
                </div>
                <div class="stat-card">
                    <h3>å®Œæˆç‡</h3>
                    <div class="value" th:text="${#numbers.formatDecimal(statistics.completionRate, 1, 1)} + '%'">0%</div>
                </div>
            </div>

            <div class="chart-section" th:if="${statistics != null && statistics.totalIssues > 0}">
                <h2>ğŸ“ˆ å·¥ä½œè² è¼‰åœ–è¡¨åˆ†æ</h2>
                <div class="chart-container">
                    <canvas id="workloadChart"></canvas>
                </div>
            </div>

            <div class="table-section" th:if="${statistics != null && statistics.workloadList.size() > 0}">
                <h2 class="section-title" th:text="${isGroupQuery ? 'ğŸ‘¥ éƒ¨é–€æˆå“¡å·¥ä½œæ¸…å–®' : 'ğŸ“‹ å°ˆæ¡ˆå·¥ä½œæ¸…å–®'}">ğŸ“‹ å·¥ä½œæ¸…å–®</h2>
                <div class="project-accordion" id="projectAccordion">
                    <!-- ä½¿ç”¨ JavaScript å‹•æ…‹ç”Ÿæˆåˆ†çµ„ -->
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
        function loadUsers() {
            const groupName = document.getElementById('groupName').value;
            const userSelect = document.getElementById('userFullname');
            
            if (!groupName) {
                userSelect.innerHTML = '<option value="">ğŸ¢ å…¨éƒ¨æˆå“¡ (è«‹å…ˆé¸æ“‡éƒ¨é–€)</option>';
                return;
            }

            fetch(`/api/users/${encodeURIComponent(groupName)}`)
                .then(response => response.json())
                .then(users => {
                    userSelect.innerHTML = '<option value="">ğŸ¢ å…¨éƒ¨æˆå“¡ (æ•´å€‹éƒ¨é–€)</option>';
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user;
                        option.textContent = 'ğŸ‘¤ ' + user;
                        
                        const selectedUser = /*[[${selectedUser}]]*/ '';
                        if (user === selectedUser) {
                            option.selected = true;
                        }
                        
                        userSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    userSelect.innerHTML = '<option value="">âŒ è¼‰å…¥å¤±æ•—</option>';
                });
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.addEventListener('DOMContentLoaded', function() {
            const selectedGroup = /*[[${selectedGroup}]]*/ '';
            if (selectedGroup) {
                loadUsers();
            }

            // ç¹ªè£½åœ–è¡¨å’Œç”Ÿæˆå°ˆæ¡ˆåˆ—è¡¨
            const statistics = /*[[${statistics}]]*/ null;
            if (statistics && statistics.workloadList && statistics.workloadList.length > 0) {
                drawChart(statistics);
                generateProjectAccordion(statistics);
            }
        });

        // ç¹ªè£½å·¥ä½œè² è¼‰åœ–è¡¨
        function drawChart(statistics) {
            const ctx = document.getElementById('workloadChart');
            if (!ctx) return;

            // ä¾å°ˆæ¡ˆçµ±è¨ˆå·¥æ™‚
            const projectData = {};
            statistics.workloadList.forEach(item => {
                if (!projectData[item.projectName]) {
                    projectData[item.projectName] = 0;
                }
                projectData[item.projectName] += parseFloat(item.estimatedHours || 0);
            });

            const labels = Object.keys(projectData);
            const data = Object.values(projectData);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ä¼°è¨ˆå·¥æ™‚ (å°æ™‚)',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'å„å°ˆæ¡ˆå·¥æ™‚åˆ†å¸ƒ',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' hrs';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ç”Ÿæˆå°ˆæ¡ˆæ‰‹é¢¨ç´å¼åˆ—è¡¨
        function generateProjectAccordion(statistics) {
            const accordion = document.getElementById('projectAccordion');
            if (!accordion) return;

            const isGroupQuery = /*[[${isGroupQuery}]]*/ false;
            
            if (isGroupQuery) {
                // ç¾¤çµ„æŸ¥è©¢ï¼šæŒ‰ä½¿ç”¨è€…åˆ†çµ„
                generateUserAccordion(statistics, accordion);
            } else {
                // å€‹äººæŸ¥è©¢ï¼šæŒ‰å°ˆæ¡ˆåˆ†çµ„
                generateProjectGroups(statistics, accordion);
            }
        }

        // æŒ‰ä½¿ç”¨è€…åˆ†çµ„é¡¯ç¤º
        function generateUserAccordion(statistics, accordion) {
            const userGroups = {};
            statistics.workloadList.forEach(item => {
                if (!userGroups[item.userFullname]) {
                    userGroups[item.userFullname] = {
                        issues: [],
                        totalHours: 0,
                        totalIssues: 0,
                        earliestStart: null,
                        latestEnd: null
                    };
                }
                userGroups[item.userFullname].issues.push(item);
                userGroups[item.userFullname].totalHours += parseFloat(item.estimatedHours || 0);
                userGroups[item.userFullname].totalIssues++;

                // è¨ˆç®—æœ€æ—©é–‹å§‹æ™‚é–“å’Œæœ€æ™šçµæŸæ™‚é–“
                const startDate = new Date(item.startDate);
                const endDate = new Date(item.dueDate);
                
                if (!userGroups[item.userFullname].earliestStart || startDate < userGroups[item.userFullname].earliestStart) {
                    userGroups[item.userFullname].earliestStart = startDate;
                }
                
                if (!userGroups[item.userFullname].latestEnd || endDate > userGroups[item.userFullname].latestEnd) {
                    userGroups[item.userFullname].latestEnd = endDate;
                }
            });

            // ç”Ÿæˆä½¿ç”¨è€…æ‰‹é¢¨ç´ HTML
            let accordionHTML = '';
            Object.keys(userGroups).forEach((userName, index) => {
                const user = userGroups[userName];
                
                const startDateStr = user.earliestStart ? user.earliestStart.toLocaleDateString('zh-TW') : 'æœªè¨­å®š';
                const endDateStr = user.latestEnd ? user.latestEnd.toLocaleDateString('zh-TW') : 'æœªè¨­å®š';
                
                accordionHTML += `
                    <div class="project-item">
                        <div class="project-header" onclick="toggleProject(${index})">
                            <div class="project-title-section">
                                <h3 class="project-title">ğŸ‘¤ ${userName}</h3>
                                <div class="project-duration">
                                    <span class="duration-text">ğŸ“… ${startDateStr} ~ ${endDateStr}</span>
                                </div>
                            </div>
                            <div class="project-summary">
                                <span class="project-cost">ğŸ’° ${user.totalHours.toFixed(1)} hrs</span>
                                <span class="project-count">ğŸ“‹ ${user.totalIssues} å€‹è­°é¡Œ</span>
                                <span class="expand-icon" id="icon-${index}">â–¼</span>
                            </div>
                        </div>
                        <div class="project-content" id="content-${index}">
                            <table class="issues-table">
                                <thead>
                                    <tr>
                                        <th>è­°é¡Œç·¨è™Ÿ</th>
                                        <th>å°ˆæ¡ˆåç¨±</th>
                                        <th>è­°é¡Œä¸»æ—¨</th>
                                        <th>é–‹å§‹æ—¥æœŸ</th>
                                        <th>çµæŸæ—¥æœŸ</th>
                                        <th>ä¼°è¨ˆå·¥æ™‚</th>
                                        <th>æ—¥å‡å·¥æ™‚</th>
                                        <th>ç‹€æ…‹</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                
                // æŒ‰è­°é¡Œç·¨è™Ÿæ’åº
                user.issues.sort((a, b) => parseInt(a.issueId) - parseInt(b.issueId));
                
                user.issues.forEach(issue => {
                    const statusClass = issue.isClosed ? 'badge-closed' : 'badge-open';
                    accordionHTML += `
                        <tr>
                            <td>#${issue.issueId}</td>
                            <td>${issue.projectName}</td>
                            <td class="issue-subject">${issue.issueSubject}</td>
                            <td>${issue.startDate}</td>
                            <td>${issue.dueDate}</td>
                            <td>${issue.estimatedHours} hrs</td>
                            <td>${issue.avgHoursPerDay} hrs</td>
                            <td><span class="badge ${statusClass}">${issue.statusName}</span></td>
                        </tr>`;
                });
                
                accordionHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            });

            accordion.innerHTML = accordionHTML;
        }

        // æŒ‰å°ˆæ¡ˆåˆ†çµ„é¡¯ç¤º
        function generateProjectGroups(statistics, accordion) {
            const projectGroups = {};
            statistics.workloadList.forEach(item => {
                if (!projectGroups[item.projectName]) {
                    projectGroups[item.projectName] = {
                        issues: [],
                        totalHours: 0,
                        totalIssues: 0,
                        earliestStart: null,
                        latestEnd: null
                    };
                }
                projectGroups[item.projectName].issues.push(item);
                projectGroups[item.projectName].totalHours += parseFloat(item.estimatedHours || 0);
                projectGroups[item.projectName].totalIssues++;

                // è¨ˆç®—æœ€æ—©é–‹å§‹æ™‚é–“å’Œæœ€æ™šçµæŸæ™‚é–“
                const startDate = new Date(item.startDate);
                const endDate = new Date(item.dueDate);
                
                if (!projectGroups[item.projectName].earliestStart || startDate < projectGroups[item.projectName].earliestStart) {
                    projectGroups[item.projectName].earliestStart = startDate;
                }
                
                if (!projectGroups[item.projectName].latestEnd || endDate > projectGroups[item.projectName].latestEnd) {
                    projectGroups[item.projectName].latestEnd = endDate;
                }
            });

            // ç”Ÿæˆå°ˆæ¡ˆ HTML
            let accordionHTML = '';
            Object.keys(projectGroups).forEach((projectName, index) => {
                const project = projectGroups[projectName];
                
                // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
                const startDateStr = project.earliestStart ? project.earliestStart.toLocaleDateString('zh-TW') : 'æœªè¨­å®š';
                const endDateStr = project.latestEnd ? project.latestEnd.toLocaleDateString('zh-TW') : 'æœªè¨­å®š';
                
                accordionHTML += `
                    <div class="project-item">
                        <div class="project-header" onclick="toggleProject(${index})">
                            <div class="project-title-section">
                                <h3 class="project-title">ğŸ“ ${projectName}</h3>
                                <div class="project-duration">
                                    <span class="duration-text">ğŸ“… ${startDateStr} ~ ${endDateStr}</span>
                                </div>
                            </div>
                            <div class="project-summary">
                                <span class="project-cost">ğŸ’° ${project.totalHours.toFixed(1)} hrs</span>
                                <span class="project-count">ğŸ“‹ ${project.totalIssues} å€‹è­°é¡Œ</span>
                                <span class="expand-icon" id="icon-${index}">â–¼</span>
                            </div>
                        </div>
                        <div class="project-content" id="content-${index}">
                            <table class="issues-table">
                                <thead>
                                    <tr>
                                        <th>è­°é¡Œç·¨è™Ÿ</th>
                                        <th>è­°é¡Œä¸»æ—¨</th>
                                        <th>é–‹å§‹æ—¥æœŸ</th>
                                        <th>çµæŸæ—¥æœŸ</th>
                                        <th>ä¼°è¨ˆå·¥æ™‚</th>
                                        <th>æ—¥å‡å·¥æ™‚</th>
                                        <th>ç‹€æ…‹</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                
                // æŒ‰è­°é¡Œç·¨è™Ÿæ’åº
                project.issues.sort((a, b) => parseInt(a.issueId) - parseInt(b.issueId));
                
                project.issues.forEach(issue => {
                    const statusClass = issue.isClosed ? 'badge-closed' : 'badge-open';
                    accordionHTML += `
                        <tr>
                            <td>#${issue.issueId}</td>
                            <td class="issue-subject">${issue.issueSubject}</td>
                            <td>${issue.startDate}</td>
                            <td>${issue.dueDate}</td>
                            <td>${issue.estimatedHours} hrs</td>
                            <td>${issue.avgHoursPerDay} hrs</td>
                            <td><span class="badge ${statusClass}">${issue.statusName}</span></td>
                        </tr>`;
                });
                
                accordionHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            });

            accordion.innerHTML = accordionHTML;
        }

        // åˆ‡æ›å°ˆæ¡ˆå±•é–‹/æ”¶åˆ
        function toggleProject(index) {
            const content = document.getElementById(`content-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
                icon.textContent = 'â–¼';
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
                icon.textContent = 'â–²';
            }
        }

        // 2Dåˆ†ææäº¤å‡½æ•¸
        function submit2DAnalysis() {
            const form = document.getElementById('workloadForm');
            const groupName = document.getElementById('groupName').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!groupName || !startDate || !endDate) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
                return;
            }

            // é©—è­‰æ—¥æœŸç¯„åœ
            if (new Date(startDate) > new Date(endDate)) {
                alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸï¼');
                return;
            }

            // å‰µå»ºæ–°çš„è¡¨å–®ä¸¦æäº¤åˆ°2Dåˆ†æé é¢
            const form2D = document.createElement('form');
            form2D.method = 'POST';
            form2D.action = '/workload2d';

            // è¤‡è£½è¡¨å–®æ•¸æ“š
            const formData = new FormData(form);
            for (let [key, value] of formData.entries()) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form2D.appendChild(input);
            }

            document.body.appendChild(form2D);
            form2D.submit();
        }
    </script>
</body>
</html>
