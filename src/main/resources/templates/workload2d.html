<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redmine å·¥ä½œè² è¼‰ 2D åˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .back-btn {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: white;
            color: #667eea;
        }

        .info-section {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .info-item label {
            font-weight: 600;
            color: #495057;
            display: block;
            margin-bottom: 5px;
        }

        .info-item span {
            color: #667eea;
            font-weight: 600;
        }

        .analysis-section {
            padding: 30px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .workload-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 12px;
        }

        .workload-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .workload-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            vertical-align: middle;
        }

        .workload-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .workload-table tbody tr:hover {
            background-color: #e3f2fd;
        }

        /* è­°é¡Œè³‡è¨Šæ¬„ä½ */
        .issue-info {
            text-align: left !important;
            min-width: 200px;
            max-width: 300px;
        }

        .issue-title {
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }

        .issue-details {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        /* æ—¥æœŸæ¬„ä½æ¨£å¼ */
        .date-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            min-width: 40px;
            max-width: 40px;
        }

        .workload-cell {
            min-width: 40px;
            max-width: 40px;
            font-weight: 600;
        }

        /* å·¥ä½œé‡æ•¸å€¼çš„é¡è‰²ç·¨ç¢¼ */
        .workload-zero {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .workload-normal {
            background-color: #d4edda;
            color: #155724;
        }

        .workload-high {
            background-color: #ffeaa7;
            color: #d63031;
            font-weight: bold;
            border: 2px solid #fdcb6e;
        }

        .workload-overdue {
            background-color: #f8d7da;
            color: #721c24;
        }

        .weekend {
            background-color: #e9ecef;
            color: #6c757d;
        }

        /* æˆæœ¬è¨ˆç®—æ¬„ä½æ¨£å¼ */
        .cost-include {
            width: 80px;
            text-align: center;
            vertical-align: middle;
            background: #f8f9fa;
            border-right: 2px solid #dee2e6;
        }

        .cost-include input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }

        /* indeterminate ç‹€æ…‹çš„æ¨£å¼ */
        .cost-include input[type="checkbox"]:indeterminate {
            opacity: 0.7;
        }

        .cost-include label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            margin-left: 5px;
        }

        /* è¢«æ’é™¤æˆæœ¬è¨ˆç®—çš„è¡Œæ¨£å¼ */
        .excluded-from-cost {
            opacity: 0.6;
            background-color: #f8d7da !important;
        }

        .excluded-from-cost .issue-info {
            color: #721c24;
        }

        /* æˆæœ¬è¨ˆç®—çµ±è¨ˆå€åŸŸ */
        .cost-summary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cost-summary .cost-item {
            text-align: center;
        }

        .cost-summary .cost-value {
            font-size: 1.5em;
            font-weight: 700;
            display: block;
        }

        .cost-summary .cost-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 2em;
            }

            .back-btn {
                left: 15px;
                padding: 8px 15px;
                font-size: 14px;
            }

            .info-section {
                padding: 15px;
            }

            .analysis-section {
                padding: 15px;
            }

            .workload-table {
                font-size: 10px;
            }

            .workload-table th,
            .workload-table td {
                padding: 6px 4px;
            }
        }

        /* Loading è¦†è“‹å±¤æ¨£å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        .loading-spinner {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .loading-subtext {
            font-size: 14px;
            color: #666;
        }

        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: #f0f0f0;
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* è¨ˆç®—ä¸­çš„ checkbox æ¨£å¼ */
        .calculating {
            pointer-events: none;
            opacity: 0.6;
        }

        .legend {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .month-header {
            text-align: center;
        }

        /* åˆ†å±¤å±•é–‹ç›¸é—œæ¨£å¼ */
        .expandable-row {
            cursor: pointer;
            user-select: none;
        }

        .expandable-row:hover {
            background-color: #e3f2fd !important;
        }

        .expand-icon {
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.3s ease;
            font-weight: bold;
            color: #667eea;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .user-summary {
            background-color: #e8f4fd !important;
            font-weight: bold;
            color: #1976d2;
        }

        .project-summary {
            background-color: #f3f9ff !important;
            font-weight: 600;
            color: #1565c0;
        }

        .issue-detail {
            background-color: #fafafa;
            color: #424242;
        }

        .collapsed {
            display: none;
        }

        .level-0 { padding-left: 10px !important; }
        .level-1 { padding-left: 30px !important; }
        .level-2 { padding-left: 50px !important; }
    </style>
</head>
<body>
    <!-- Loading è¦†è“‹å±¤ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">è¨ˆç®—ä¸­...</div>
            <div class="loading-subtext" id="loadingSubtext">æ­£åœ¨æ›´æ–°å·¥ä½œé‡è³‡æ–™</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <a href="/" class="back-btn">â† è¿”å›é¦–é </a>
            <h1>Redmine å·¥ä½œè² è¼‰ 2D åˆ†æ</h1>
            <p>è­°é¡Œå·¥ä½œé‡æ—¥æœŸåˆ†ä½ˆè¦–è¦ºåŒ–åˆ†æ</p>
        </div>

        <div class="info-section">
            <div class="info-grid">
                <div class="info-item">
                    <label>ç¾¤çµ„åç¨±ï¼š</label>
                    <span th:text="${selectedGroup}"></span>
                </div>
                <div class="info-item">
                    <label>ä½¿ç”¨è€…ï¼š</label>
                    <span th:text="${selectedUsers != null and !selectedUsers.isEmpty() ? 
                                   (selectedUsers.size() == 1 ? selectedUsers[0] : 
                                   (selectedUsers.size() + 'äºº: ' + #strings.listJoin(selectedUsers, ', '))) : 
                                   'å…¨ç¾¤çµ„'}"></span>
                </div>
                <div class="info-item">
                    <label>åˆ†ææœŸé–“ï¼š</label>
                    <span th:text="${selectedStartDate + ' ~ ' + selectedEndDate}"></span>
                </div>
                <div class="info-item">
                    <label>æ™‚é–“é¡†ç²’åº¦ï¼š</label>
                    <span th:text="${timeGranularity == 'daily' ? 'ğŸ“… æ¯æ—¥' : (timeGranularity == 'weekly' ? 'ğŸ“Š æ¯é€±' : 'ğŸ“ˆ æ¯æœˆ')}"></span>
                </div>
                <div class="info-item">
                    <label>è­°é¡Œæ•¸é‡ï¼š</label>
                    <span th:text="${analysis2D != null ? analysis2D.size() : 0}"></span>
                </div>
            </div>
        </div>

        <div class="analysis-section">
            <!-- æˆæœ¬è¨ˆç®—çµ±è¨ˆ -->
            <div class="cost-summary" th:if="${analysis2D != null and !analysis2D.isEmpty()}">
                <div class="cost-item">
                    <span class="cost-value" id="includedHours">è¨ˆç®—ä¸­...</span>
                    <span class="cost-label">ç´å…¥è¨ˆç®—å·¥æ™‚</span>
                </div>
                <div class="cost-item">
                    <span class="cost-value" id="excludedHours">0</span>
                    <span class="cost-label">æ’é™¤è¨ˆç®—å·¥æ™‚</span>
                </div>
                <div class="cost-item">
                    <span class="cost-value" id="totalHours">è¨ˆç®—ä¸­...</span>
                    <span class="cost-label">ç¸½å·¥æ™‚</span>
                </div>
                <div class="cost-item">
                    <span class="cost-value" id="includedItems">è¨ˆç®—ä¸­...</span>
                    <span class="cost-label">ç´å…¥é …ç›®æ•¸</span>
                </div>
            </div>

            <div th:if="${analysis2D != null and !analysis2D.isEmpty()}">
                <div class="table-container">
                    <table class="workload-table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="cost-include">
                                    <input type="checkbox" id="selectAll" checked onchange="toggleSelectAll(this)" title="å…¨é¸/å…¨ä¸é¸">
                                    <label for="selectAll">æˆæœ¬è¨ˆç®—</label>
                                </th>
                                <th rowspan="2" class="issue-info">è­°é¡Œè³‡è¨Š</th>
                                <!-- æ¯æ—¥æ¨¡å¼ï¼šå‹•æ…‹é¡¯ç¤ºæœŸé–“å…§çš„æ‰€æœ‰æœˆä»½ -->
                                <th th:if="${timeGranularity == 'daily'}" 
                                    th:text="${#temporals.format(startDate, 'yyyyå¹´MMæœˆ')} + 
                                             (${startDate.month != endDate.month} ? (' ~ ' + ${#temporals.format(endDate, 'MMæœˆ')}) : '')" 
                                    th:attr="colspan=${daysBetween}" 
                                    class="month-header"></th>
                                <!-- æ¯é€±æ¨¡å¼ -->
                                <th th:if="${timeGranularity == 'weekly'}" 
                                    th:text="${#temporals.format(startDate, 'yyyyå¹´')} + ' é€±æ¬¡åˆ†æ (' + 
                                             ${#temporals.format(startDate, 'MMæœˆ')} + 
                                             (${startDate.month != endDate.month} ? (' ~ ' + ${#temporals.format(endDate, 'MMæœˆ')}) : '') + ')'" 
                                    th:attr="colspan=${weekCount}" class="month-header"></th>
                                <!-- æ¯æœˆæ¨¡å¼ -->
                                <th th:if="${timeGranularity == 'monthly'}" 
                                    th:text="${#temporals.format(startDate, 'yyyyå¹´')} + ' æœˆä»½åˆ†æ (' + 
                                             ${#temporals.format(startDate, 'MMæœˆ')} + 
                                             (${startDate.month != endDate.month} ? (' ~ ' + ${#temporals.format(endDate, 'MMæœˆ')}) : '') + ')'" 
                                    th:attr="colspan=${monthCount}" class="month-header"></th>
                            </tr>
                            <tr>
                                <!-- æ¯æ—¥æ¨¡å¼ï¼šå‹•æ…‹ç”Ÿæˆå¾é–‹å§‹æ—¥æœŸåˆ°çµæŸæ—¥æœŸçš„æ‰€æœ‰æ—¥æœŸæ¬„ä½ -->
                                <th th:if="${timeGranularity == 'daily'}" 
                                    th:each="i : ${#numbers.sequence(0, daysBetween - 1)}" 
                                    th:with="currentDate=${startDate.plusDays(i)}"
                                    th:text="${currentDate.dayOfMonth}"
                                    th:classappend="${currentDate.dayOfWeek.value == 6 or currentDate.dayOfWeek.value == 7} ? 'weekend' : ''"
                                    class="date-header">
                                </th>
                                
                                <!-- æ¯é€±æ¨¡å¼ï¼šä½¿ç”¨å¾Œç«¯è¨ˆç®—çš„é€±æ¬¡åˆ—è¡¨ -->
                                <th th:if="${timeGranularity == 'weekly'}" 
                                    th:each="weekNumber : ${weekNumbers}"
                                    th:text="'W' + ${weekNumber}"
                                    class="date-header">
                                </th>
                                
                                <!-- æ¯æœˆæ¨¡å¼ï¼šå‹•æ…‹ç”Ÿæˆæœˆä»½æ¬„ä½ -->
                                <th th:if="${timeGranularity == 'monthly'}" 
                                    th:each="i : ${#numbers.sequence(0, monthCount - 1)}"
                                    th:with="currentMonth=${startDate.plusMonths(i)}"
                                    th:text="${currentMonth.monthValue} + 'æœˆ'"
                                    class="date-header">
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- åˆ†å±¤é¡¯ç¤ºï¼šä½¿ç”¨è€… -> å°ˆæ¡ˆ -> è­°é¡Œ -->
                            <tr th:each="item, itemStat : ${analysis2D}" 
                                th:class="${item.issueId == -1} ? 'user-summary expandable-row' : 
                                          (${item.issueId == -2} ? 'project-summary expandable-row collapsed' : 'issue-detail collapsed')"
                                th:attr="data-user=${item.userFullname}, 
                                         data-project=${item.projectName},
                                         data-level=${item.issueId == -1} ? '0' : (${item.issueId == -2} ? '1' : '2'),
                                         data-parent=${item.issueId == -2} ? ${item.userFullname} : (${item.issueId > 0} ? ${item.userFullname + '_' + item.projectName} : '')"
                                th:onclick="${item.issueId == -1 or item.issueId == -2} ? 'toggleExpand(this)' : null">
                                
                                <td class="cost-include">
                                    <input type="checkbox" 
                                           th:id="'cost_' + ${item.userFullname} + '_' + ${item.projectName} + '_' + ${item.issueId}"
                                           th:attr="data-user=${item.userFullname}, 
                                                    data-project=${item.projectName}, 
                                                    data-issue=${item.issueId},
                                                    data-hours=${item.estimatedHours}"
                                           th:title="${item.issueId == -1} ? ('åŒ…å«ä½¿ç”¨è€… ' + ${item.userFullname} + ' çš„æˆæœ¬è¨ˆç®—') : 
                                                     (${item.issueId == -2} ? ('åŒ…å«å°ˆæ¡ˆ ' + ${item.projectName} + ' çš„æˆæœ¬è¨ˆç®—') : 
                                                     ('åŒ…å«è­°é¡Œ #' + ${item.issueId} + ' çš„æˆæœ¬è¨ˆç®—'))"
                                           checked 
                                           onchange="toggleCostCalculation(this)"
                                           onclick="event.stopPropagation();">
                                </td>
                                
                                <td class="issue-info" 
                                    th:class="${item.issueId == -1} ? 'issue-info level-0' : 
                                              (${item.issueId == -2} ? 'issue-info level-1' : 'issue-info level-2')">
                                    
                                    <!-- ä½¿ç”¨è€…ç¸½è¨ˆè¡Œ -->
                                    <div th:if="${item.issueId == -1}">
                                        <span class="expand-icon">â–¶</span>
                                        <span class="issue-title" th:text="'ğŸ‘¤ ' + ${item.userFullname}"></span>
                                        <div class="issue-details">
                                            <span th:id="'user-hours-' + ${item.userFullname.replaceAll(' ', '_')}"
                                                  th:attr="data-user=${item.userFullname}, 
                                                           data-original-hours=${item.estimatedHours}"
                                                  th:text="${item.issueSubject}"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- å°ˆæ¡ˆç¸½è¨ˆè¡Œ -->
                                    <div th:if="${item.issueId == -2}">
                                        <span class="expand-icon">â–¶</span>
                                        <span class="issue-title" th:text="'ğŸ“ ' + ${item.projectName}"></span>
                                        <div class="issue-details">
                                            <span th:id="'project-hours-' + ${item.userFullname.replaceAll(' ', '_')} + '_' + ${item.projectName.replaceAll(' ', '_')}"
                                                  th:attr="data-user=${item.userFullname}, 
                                                           data-project=${item.projectName}, 
                                                           data-original-hours=${item.estimatedHours}"
                                                  th:text="${item.issueSubject}"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- è­°é¡Œè©³ç´°è¡Œ -->
                                    <div th:if="${item.issueId > 0}">
                                        <div class="issue-title" th:text="'ğŸ“‹ ' + ${item.issueId} + ' - ' + ${item.issueSubject}"></div>
                                        <div class="issue-details">
                                            <span th:text="'æœŸé–“: ' + ${#temporals.format(item.startDate, 'yyyy-MM-dd')} + ' ~ ' + ${#temporals.format(item.dueDate, 'yyyy-MM-dd')}"></span><br/>
                                            <span th:text="'é ä¼°: ' + ${item.estimatedHours} + ' å°æ™‚'"></span><br/>
                                            <span id="'period-hours-' + ${item.issueId}" class="period-hours">å€é–“: è¨ˆç®—ä¸­...</span>
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- æ¯æ—¥æ¨¡å¼ï¼šé¡¯ç¤ºæ¯æ—¥å·¥ä½œé‡ -->
                                <td th:if="${timeGranularity == 'daily'}"
                                    th:each="day, iterStat : ${item.dailyWorkloads}"
                                    th:text="${day.status}"
                                    th:attr="data-user=${item.userFullname},
                                             data-project=${item.projectName},
                                             data-issue=${item.issueId},
                                             data-period-index=${iterStat.index},
                                             data-original-workload=${day.status},
                                             data-weekend=${day.weekend},
                                             data-overdue=${day.overdue}"
                                    th:class="${'workload-cell ' + (day.weekend ? 'weekend' : 
                                               (day.status == '0.0' ? 'workload-zero' : 
                                               (day.overdue ? 'workload-overdue' : 
                                               (T(java.lang.Double).parseDouble(day.status) >= 8.0 ? 'workload-high' : 'workload-normal'))))}">
                                </td>
                                
                                <!-- æ¯é€±/æ¯æœˆæ¨¡å¼ï¼šé¡¯ç¤ºé€±æœŸå·¥ä½œé‡ -->
                                <td th:if="${timeGranularity != 'daily'}"
                                    th:each="period, iterStat : ${item.periodWorkloads}"
                                    th:text="${period.status}"
                                    th:attr="data-user=${item.userFullname},
                                             data-project=${item.projectName},
                                             data-issue=${item.issueId},
                                             data-period-index=${iterStat.index},
                                             data-original-workload=${period.status}"
                                    th:class="${'workload-cell ' + 
                                               (period.status == '0.0' ? 'workload-zero' : 
                                               (T(java.lang.Double).parseDouble(period.status) >= 8.0 ? 'workload-high' : 'workload-normal'))}">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div th:if="${analysis2D == null or analysis2D.isEmpty()}" class="no-data">
                <h3>æŸ¥ç„¡è³‡æ–™</h3>
                <p>è«‹èª¿æ•´æŸ¥è©¢æ¢ä»¶å¾Œé‡æ–°æœå°‹</p>
            </div>
        </div>
    </div>

    <script>
        // å‹•æ…‹èª¿æ•´è¡¨æ ¼æ¨£å¼
        document.addEventListener('DOMContentLoaded', function() {
            const table = document.querySelector('.workload-table');
            if (table) {
                // ç‚ºè¡¨æ ¼æ·»åŠ æ»¾å‹•æç¤º
                const container = table.closest('.table-container');
                if (container.scrollWidth > container.clientWidth) {
                    container.style.border = '2px solid #667eea';
                    container.title = 'è¡¨æ ¼å¯å·¦å³æ»¾å‹•æŸ¥çœ‹æ›´å¤šå…§å®¹';
                }
            }
            
            // åˆå§‹åŒ–ï¼šåªé¡¯ç¤ºä½¿ç”¨è€…ç¸½è¨ˆè¡Œ
            initializeExpandState();
        });

        // åˆå§‹åŒ–å±•é–‹ç‹€æ…‹ï¼šé è¨­åªé¡¯ç¤ºä½¿ç”¨è€…ç¸½è¨ˆ
        function initializeExpandState() {
            const allRows = document.querySelectorAll('tbody tr');
            allRows.forEach(row => {
                const level = row.getAttribute('data-level');
                if (level === '1' || level === '2') {
                    row.classList.add('collapsed');
                }
            });
        }

        // åˆ‡æ›å±•é–‹/æ”¶åˆç‹€æ…‹
        function toggleExpand(clickedRow) {
            const level = clickedRow.getAttribute('data-level');
            const icon = clickedRow.querySelector('.expand-icon');
            const isExpanded = icon.classList.contains('expanded');
            
            if (level === '0') {
                // ä½¿ç”¨è€…å±¤ç´šï¼šåˆ‡æ›è©²ä½¿ç”¨è€…ä¸‹çš„æ‰€æœ‰å°ˆæ¡ˆ
                toggleUserProjects(clickedRow, !isExpanded);
            } else if (level === '1') {
                // å°ˆæ¡ˆå±¤ç´šï¼šåˆ‡æ›è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰è­°é¡Œ
                toggleProjectIssues(clickedRow, !isExpanded);
            }
            
            // æ›´æ–°åœ–ç¤º
            if (isExpanded) {
                icon.classList.remove('expanded');
                icon.textContent = 'â–¶';
            } else {
                icon.classList.add('expanded');
                icon.textContent = 'â–¼';
            }
        }

        // åˆ‡æ›ä½¿ç”¨è€…ä¸‹çš„å°ˆæ¡ˆé¡¯ç¤º
        function toggleUserProjects(userRow, expand) {
            const userName = userRow.getAttribute('data-user');
            const allRows = document.querySelectorAll('tbody tr');
            
            allRows.forEach(row => {
                const rowUser = row.getAttribute('data-user');
                const rowLevel = row.getAttribute('data-level');
                
                if (rowUser === userName && rowLevel === '1') {
                    // å°ˆæ¡ˆè¡Œ
                    if (expand) {
                        row.classList.remove('collapsed');
                    } else {
                        row.classList.add('collapsed');
                        // åŒæ™‚æ”¶åˆè©²å°ˆæ¡ˆä¸‹çš„è­°é¡Œ
                        const projectName = row.getAttribute('data-project');
                        hideProjectIssues(userName, projectName);
                        // é‡ç½®å°ˆæ¡ˆçš„å±•é–‹åœ–ç¤º
                        const projectIcon = row.querySelector('.expand-icon');
                        if (projectIcon) {
                            projectIcon.classList.remove('expanded');
                            projectIcon.textContent = 'â–¶';
                        }
                    }
                }
            });
        }

        // åˆ‡æ›å°ˆæ¡ˆä¸‹çš„è­°é¡Œé¡¯ç¤º
        function toggleProjectIssues(projectRow, expand) {
            const userName = projectRow.getAttribute('data-user');
            const projectName = projectRow.getAttribute('data-project');
            const allRows = document.querySelectorAll('tbody tr');
            
            allRows.forEach(row => {
                const rowUser = row.getAttribute('data-user');
                const rowProject = row.getAttribute('data-project');
                const rowLevel = row.getAttribute('data-level');
                
                if (rowUser === userName && rowProject === projectName && rowLevel === '2') {
                    if (expand) {
                        row.classList.remove('collapsed');
                    } else {
                        row.classList.add('collapsed');
                    }
                }
            });
        }

        // éš±è—å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰è­°é¡Œ
        function hideProjectIssues(userName, projectName) {
            const allRows = document.querySelectorAll('tbody tr');
            
            allRows.forEach(row => {
                const rowUser = row.getAttribute('data-user');
                const rowProject = row.getAttribute('data-project');
                const rowLevel = row.getAttribute('data-level');
                
                if (rowUser === userName && rowProject === projectName && rowLevel === '2') {
                    row.classList.add('collapsed');
                }
            });
        }

        // === Loading ç®¡ç†åŠŸèƒ½ ===
        
        function showLoading(text = 'è¨ˆç®—ä¸­...', subtext = 'æ­£åœ¨æ›´æ–°å·¥ä½œé‡è³‡æ–™') {
            const overlay = document.getElementById('loadingOverlay');
            const textElement = document.getElementById('loadingText');
            const subtextElement = document.getElementById('loadingSubtext');
            const progressBar = document.getElementById('progressBar');
            
            textElement.textContent = text;
            subtextElement.textContent = subtext;
            progressBar.style.width = '0%';
            
            overlay.style.display = 'flex';
            
            // ç¦ç”¨æ‰€æœ‰ checkbox
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.classList.add('calculating'));
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
            
            // é‡æ–°å•Ÿç”¨æ‰€æœ‰ checkbox
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.classList.remove('calculating'));
        }
        
        function updateProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
        }

        // === æˆæœ¬è¨ˆç®—åŠŸèƒ½ ===
        
        // åˆ‡æ›å–®å€‹é …ç›®çš„æˆæœ¬è¨ˆç®— - éšå±¤å¼å‹¾é¸é‚è¼¯ï¼ˆç•°æ­¥ç‰ˆæœ¬ï¼‰
        async function toggleCostCalculation(checkbox) {
            console.log('=== toggleCostCalculation è¢«èª¿ç”¨ ===');
            
            const issueId = checkbox.getAttribute('data-issue');
            const userName = checkbox.getAttribute('data-user');
            const projectName = checkbox.getAttribute('data-project');
            const isChecked = checkbox.checked;
            
            console.log('é …ç›®è³‡è¨Š:', { issueId, userName, projectName, isChecked });
            
            // é¡¯ç¤º Loading
            showLoading('æ›´æ–°ä¸­...', 'æ­£åœ¨é‡æ–°è¨ˆç®—å·¥ä½œé‡');
            
            try {
                // ä½¿ç”¨ setTimeout è®“ UI æœ‰æ™‚é–“æ›´æ–°
                await new Promise(resolve => setTimeout(resolve, 50));
                
                updateProgress(20);
                
                // æ ¹æ“šé …ç›®é¡å‹è™•ç†éšå±¤å¼å‹¾é¸
                if (issueId === '-1') {
                    // äººå“¡å±¤ç´šï¼šå–æ¶ˆå‹¾é¸è©²äººå“¡ä¸‹çš„æ‰€æœ‰å°ˆæ¡ˆå’Œ ISSUE
                    await handleUserLevelToggleAsync(userName, isChecked);
                } else if (issueId === '-2') {
                    // å°ˆæ¡ˆå±¤ç´šï¼šå–æ¶ˆå‹¾é¸è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰ ISSUE
                    await handleProjectLevelToggleAsync(userName, projectName, isChecked);
                } else {
                    // ISSUE å±¤ç´šï¼šæ›´æ–°å–®å€‹ ISSUE çš„è¦–è¦ºæ¨£å¼ï¼Œä¸¦æ›´æ–°çˆ¶å±¤ç‹€æ…‹
                    toggleRowCostExclusion(checkbox);
                    
                    // æ›´æ–°å°ˆæ¡ˆå±¤ç´šçš„ç‹€æ…‹
                    updateProjectCheckboxState(userName, projectName);
                    
                    // æ›´æ–°äººå“¡å±¤ç´šçš„ç‹€æ…‹
                    updateParentCheckboxState(userName);
                }
                
                updateProgress(50);
                
                // åˆ†æ­¥åŸ·è¡Œé‡æ–°è¨ˆç®—
                await updateCostStatisticsAsync();
                updateProgress(70);
                
                await updateSummaryRowsHoursAsync();
                updateProgress(90);
                
                // æ›´æ–°å…¨é¸ç‹€æ…‹
                updateSelectAllState();
                updateProgress(100);
                
                console.log('=== toggleCostCalculation å®Œæˆ ===');
                
            } catch (error) {
                console.error('è¨ˆç®—éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
            } finally {
                // å»¶é²ä¸€é»å†éš±è— Loadingï¼Œè®“ç”¨æˆ¶çœ‹åˆ° 100% å®Œæˆ
                setTimeout(() => {
                    hideLoading();
                }, 200);
            }
        }

        // è™•ç†äººå“¡å±¤ç´šçš„å‹¾é¸/å–æ¶ˆå‹¾é¸ï¼ˆç•°æ­¥ç‰ˆæœ¬ï¼‰
        async function handleUserLevelToggleAsync(userName, isChecked) {
            console.log(`è™•ç†äººå“¡å±¤ç´š: ${userName}, å‹¾é¸=${isChecked}`);
            
            let updatedCount = 0;
            const batchSize = 50; // æ¯æ‰¹è™•ç†çš„é …ç›®æ•¸é‡
            
            // æ‰¾åˆ°è©²äººå“¡çš„ checkbox ä¸¦æ›´æ–°è¦–è¦ºæ¨£å¼
            const userCheckbox = document.querySelector(`input[data-user="${userName}"][data-issue="-1"]`);
            if (userCheckbox) {
                toggleRowCostExclusion(userCheckbox);
                updatedCount++;
            }
            
            // æ‰¾åˆ°è©²äººå“¡ä¸‹çš„æ‰€æœ‰å°ˆæ¡ˆ checkbox
            const projectCheckboxes = document.querySelectorAll(`input[data-user="${userName}"][data-issue="-2"]`);
            
            for (let i = 0; i < projectCheckboxes.length; i++) {
                const projectCheckbox = projectCheckboxes[i];
                
                if (projectCheckbox.checked !== isChecked) {
                    projectCheckbox.checked = isChecked;
                    toggleRowCostExclusion(projectCheckbox);
                    updatedCount++;
                }
                
                // åŒæ™‚æ›´æ–°è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰ ISSUE
                const projectName = projectCheckbox.getAttribute('data-project');
                const issueCheckboxes = document.querySelectorAll(
                    `input[data-user="${userName}"][data-project="${projectName}"][data-issue]:not([data-issue="-1"]):not([data-issue="-2"])`
                );
                
                for (let j = 0; j < issueCheckboxes.length; j++) {
                    const issueCheckbox = issueCheckboxes[j];
                    if (issueCheckbox.checked !== isChecked) {
                        issueCheckbox.checked = isChecked;
                        toggleRowCostExclusion(issueCheckbox);
                        updatedCount++;
                    }
                    
                    // æ¯è™•ç†ä¸€æ‰¹é …ç›®å°±æš«åœä¸€ä¸‹ï¼Œè®“ UI æœ‰æ©Ÿæœƒæ›´æ–°
                    if (updatedCount % batchSize === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
            }
            
            console.log(`äººå“¡ ${userName} çš„æ‰€æœ‰é …ç›®å·²æ›´æ–°ç‚º: ${isChecked}, å…±æ›´æ–° ${updatedCount} å€‹é …ç›®`);
        }

        // è™•ç†å°ˆæ¡ˆå±¤ç´šçš„å‹¾é¸/å–æ¶ˆå‹¾é¸ï¼ˆç•°æ­¥ç‰ˆæœ¬ï¼‰
        async function handleProjectLevelToggleAsync(userName, projectName, isChecked) {
            console.log(`è™•ç†å°ˆæ¡ˆå±¤ç´š: ${userName}/${projectName}, å‹¾é¸=${isChecked}`);
            
            let updatedCount = 0;
            const batchSize = 50;
            
            // æ‰¾åˆ°è©²å°ˆæ¡ˆçš„ checkbox ä¸¦æ›´æ–°è¦–è¦ºæ¨£å¼
            const projectCheckbox = document.querySelector(
                `input[data-user="${userName}"][data-project="${projectName}"][data-issue="-2"]`
            );
            if (projectCheckbox) {
                toggleRowCostExclusion(projectCheckbox);
                updatedCount++;
            }
            
            // æ‰¾åˆ°è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰ ISSUE checkbox
            const issueCheckboxes = document.querySelectorAll(
                `input[data-user="${userName}"][data-project="${projectName}"][data-issue]:not([data-issue="-1"]):not([data-issue="-2"])`
            );
            
            for (let i = 0; i < issueCheckboxes.length; i++) {
                const issueCheckbox = issueCheckboxes[i];
                if (issueCheckbox.checked !== isChecked) {
                    issueCheckbox.checked = isChecked;
                    toggleRowCostExclusion(issueCheckbox);
                    updatedCount++;
                    
                    // æ‰¹æ¬¡è™•ç†
                    if (updatedCount % batchSize === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
            }
            
            console.log(`å°ˆæ¡ˆ ${userName}/${projectName} ä¸‹çš„æ‰€æœ‰ ISSUE å·²æ›´æ–°ç‚º: ${isChecked}, å…±æ›´æ–° ${updatedCount} å€‹é …ç›®`);
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°äººå“¡å±¤ç´šçš„ç‹€æ…‹
            updateParentCheckboxState(userName);
        }

        // è™•ç†äººå“¡å±¤ç´šçš„å‹¾é¸/å–æ¶ˆå‹¾é¸
        function handleUserLevelToggle(userName, isChecked) {
            console.log(`è™•ç†äººå“¡å±¤ç´š: ${userName}, å‹¾é¸=${isChecked}`);
            
            let updatedCount = 0;
            
            // æ‰¾åˆ°è©²äººå“¡çš„ checkbox ä¸¦æ›´æ–°è¦–è¦ºæ¨£å¼
            const userCheckbox = document.querySelector(`input[data-user="${userName}"][data-issue="-1"]`);
            if (userCheckbox) {
                toggleRowCostExclusion(userCheckbox);
                updatedCount++;
            }
            
            // æ‰¾åˆ°è©²äººå“¡ä¸‹çš„æ‰€æœ‰å°ˆæ¡ˆ checkbox
            const projectCheckboxes = document.querySelectorAll(`input[data-user="${userName}"][data-issue="-2"]`);
            projectCheckboxes.forEach(projectCheckbox => {
                if (projectCheckbox.checked !== isChecked) {
                    projectCheckbox.checked = isChecked;
                    toggleRowCostExclusion(projectCheckbox);
                    updatedCount++;
                }
                
                // åŒæ™‚æ›´æ–°è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰ ISSUE
                const projectName = projectCheckbox.getAttribute('data-project');
                const issueCheckboxes = document.querySelectorAll(
                    `input[data-user="${userName}"][data-project="${projectName}"][data-issue]:not([data-issue="-1"]):not([data-issue="-2"])`
                );
                issueCheckboxes.forEach(issueCheckbox => {
                    if (issueCheckbox.checked !== isChecked) {
                        issueCheckbox.checked = isChecked;
                        toggleRowCostExclusion(issueCheckbox);
                        updatedCount++;
                    }
                });
            });
            
            console.log(`äººå“¡ ${userName} çš„æ‰€æœ‰é …ç›®å·²æ›´æ–°ç‚º: ${isChecked}, å…±æ›´æ–° ${updatedCount} å€‹é …ç›®`);
        }

        // è™•ç†å°ˆæ¡ˆå±¤ç´šçš„å‹¾é¸/å–æ¶ˆå‹¾é¸
        function handleProjectLevelToggle(userName, projectName, isChecked) {
            console.log(`è™•ç†å°ˆæ¡ˆå±¤ç´š: ${userName}/${projectName}, å‹¾é¸=${isChecked}`);
            
            let updatedCount = 0;
            
            // æ‰¾åˆ°è©²å°ˆæ¡ˆçš„ checkbox ä¸¦æ›´æ–°è¦–è¦ºæ¨£å¼
            const projectCheckbox = document.querySelector(
                `input[data-user="${userName}"][data-project="${projectName}"][data-issue="-2"]`
            );
            if (projectCheckbox) {
                toggleRowCostExclusion(projectCheckbox);
                updatedCount++;
            }
            
            // æ‰¾åˆ°è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰ ISSUE checkbox
            const issueCheckboxes = document.querySelectorAll(
                `input[data-user="${userName}"][data-project="${projectName}"][data-issue]:not([data-issue="-1"]):not([data-issue="-2"])`
            );
            
            issueCheckboxes.forEach(issueCheckbox => {
                if (issueCheckbox.checked !== isChecked) {
                    issueCheckbox.checked = isChecked;
                    toggleRowCostExclusion(issueCheckbox);
                    updatedCount++;
                }
            });
            
            console.log(`å°ˆæ¡ˆ ${userName}/${projectName} ä¸‹çš„æ‰€æœ‰ ISSUE å·²æ›´æ–°ç‚º: ${isChecked}, å…±æ›´æ–° ${updatedCount} å€‹é …ç›®`);
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°äººå“¡å±¤ç´šçš„ç‹€æ…‹
            updateParentCheckboxState(userName);
        }

        // æ›´æ–°å°ˆæ¡ˆå±¤ç´š checkbox çš„ç‹€æ…‹ï¼ˆç•¶ ISSUE æ”¹è®Šæ™‚ï¼‰
        function updateProjectCheckboxState(userName, projectName) {
            // æª¢æŸ¥è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰ ISSUE ç‹€æ…‹
            const issueCheckboxes = document.querySelectorAll(
                `input[data-user="${userName}"][data-project="${projectName}"][data-issue]:not([data-issue="-1"]):not([data-issue="-2"])`
            );
            const projectCheckbox = document.querySelector(
                `input[data-user="${userName}"][data-project="${projectName}"][data-issue="-2"]`
            );
            
            if (!projectCheckbox || issueCheckboxes.length === 0) return;
            
            let checkedCount = 0;
            let totalCount = issueCheckboxes.length;
            
            issueCheckboxes.forEach(cb => {
                if (cb.checked) checkedCount++;
            });
            
            console.log(`å°ˆæ¡ˆ ${userName}/${projectName}: ${checkedCount}/${totalCount} å€‹ ISSUE å·²å‹¾é¸`);
            
            // æ ¹æ“šå­é …ç›®ç‹€æ…‹æ›´æ–°å°ˆæ¡ˆ checkbox
            if (checkedCount === totalCount) {
                // å…¨éƒ¨å‹¾é¸
                projectCheckbox.checked = true;
                projectCheckbox.indeterminate = false;
                console.log('  -> å°ˆæ¡ˆç‹€æ…‹: å…¨é¸');
            } else if (checkedCount === 0) {
                // å…¨éƒ¨æœªå‹¾é¸
                projectCheckbox.checked = false;
                projectCheckbox.indeterminate = false;
                console.log('  -> å°ˆæ¡ˆç‹€æ…‹: æœªé¸');
            } else {
                // éƒ¨åˆ†å‹¾é¸ - é€™æ˜¯é—œéµï¼ä¸è¦å–æ¶ˆå°ˆæ¡ˆçš„ checkedï¼Œè€Œæ˜¯è¨­ç‚º indeterminate
                projectCheckbox.checked = true; // ä¿æŒå‹¾é¸ç‹€æ…‹
                projectCheckbox.indeterminate = true; // ä½†é¡¯ç¤ºç‚ºéƒ¨åˆ†é¸å–
                console.log('  -> å°ˆæ¡ˆç‹€æ…‹: éƒ¨åˆ†é¸å–');
            }
            
            toggleRowCostExclusion(projectCheckbox);
        }

        // æ›´æ–°äººå“¡å±¤ç´š checkbox çš„ç‹€æ…‹ï¼ˆç•¶å°ˆæ¡ˆæ”¹è®Šæ™‚ï¼‰
        function updateParentCheckboxState(userName) {
            // æª¢æŸ¥è©²äººå“¡ä¸‹çš„æ‰€æœ‰ ISSUE ç‹€æ…‹ï¼ˆä¸åªæ˜¯å°ˆæ¡ˆï¼‰
            const allIssueCheckboxes = document.querySelectorAll(
                `input[data-user="${userName}"][data-issue]:not([data-issue="-1"]):not([data-issue="-2"])`
            );
            const userCheckbox = document.querySelector(`input[data-user="${userName}"][data-issue="-1"]`);
            
            if (!userCheckbox || allIssueCheckboxes.length === 0) return;
            
            let checkedCount = 0;
            let totalCount = allIssueCheckboxes.length;
            
            allIssueCheckboxes.forEach(cb => {
                if (cb.checked) checkedCount++;
            });
            
            console.log(`äººå“¡ ${userName}: ${checkedCount}/${totalCount} å€‹ ISSUE å·²å‹¾é¸`);
            
            // æ ¹æ“šå­é …ç›®ç‹€æ…‹æ›´æ–°äººå“¡ checkbox
            if (checkedCount === totalCount) {
                // å…¨éƒ¨å‹¾é¸
                userCheckbox.checked = true;
                userCheckbox.indeterminate = false;
                console.log('  -> äººå“¡ç‹€æ…‹: å…¨é¸');
            } else if (checkedCount === 0) {
                // å…¨éƒ¨æœªå‹¾é¸
                userCheckbox.checked = false;
                userCheckbox.indeterminate = false;
                console.log('  -> äººå“¡ç‹€æ…‹: æœªé¸');
            } else {
                // éƒ¨åˆ†å‹¾é¸
                userCheckbox.checked = true; // ä¿æŒå‹¾é¸ç‹€æ…‹
                userCheckbox.indeterminate = true; // ä½†é¡¯ç¤ºç‚ºéƒ¨åˆ†é¸å–
                console.log('  -> äººå“¡ç‹€æ…‹: éƒ¨åˆ†é¸å–');
            }
            
            toggleRowCostExclusion(userCheckbox);
        }

        // åˆ‡æ›è¡Œçš„è¦–è¦ºæ¨£å¼
        function toggleRowCostExclusion(checkbox) {
            const row = checkbox.closest('tr');
            if (checkbox.checked) {
                // å®Œå…¨å‹¾é¸ï¼šç§»é™¤æ’é™¤æ¨£å¼
                row.classList.remove('excluded-from-cost');
            } else if (checkbox.indeterminate) {
                // éƒ¨åˆ†é¸å–ï¼šä¹Ÿç§»é™¤æ’é™¤æ¨£å¼ï¼ˆå› ç‚ºä»æœ‰éƒ¨åˆ†å…§å®¹è¢«è¨ˆå…¥ï¼‰
                row.classList.remove('excluded-from-cost');
            } else {
                // å®Œå…¨æœªå‹¾é¸ï¼šæ·»åŠ æ’é™¤æ¨£å¼
                row.classList.add('excluded-from-cost');
            }
        }

        // æ›´æ–°æˆæœ¬çµ±è¨ˆ - ç´”å‰ç«¯è¨ˆç®—ï¼ˆç•°æ­¥ç‰ˆæœ¬ï¼‰
        async function updateCostStatisticsAsync() {
            console.log('=== updateCostStatisticsAsync é–‹å§‹ ===');
            
            // é‡æ–°æƒææ‰€æœ‰ checkbox ä¸¦è¨ˆç®—
            const allCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]');
            console.log('æ‰¾åˆ° checkbox æ•¸é‡:', allCheckboxes.length);
            
            let includedHours = 0;
            let excludedHours = 0;
            let totalHours = 0;
            let includedItems = 0;
            let totalItems = 0;
            const batchSize = 100; // æ¯æ‰¹è™•ç†çš„æ•¸é‡

            // åˆ†æ‰¹è™•ç† checkbox
            for (let i = 0; i < allCheckboxes.length; i += batchSize) {
                const endIndex = Math.min(i + batchSize, allCheckboxes.length);
                
                for (let j = i; j < endIndex; j++) {
                    const checkbox = allCheckboxes[j];
                    const hoursAttr = checkbox.getAttribute('data-hours');
                    const issueId = checkbox.getAttribute('data-issue');
                    
                    // ç¢ºä¿æ˜¯æœ‰æ•ˆçš„å·¥æ™‚æ•¸æ“š
                    if (hoursAttr && issueId) {
                        const hours = parseFloat(hoursAttr) || 0;
                        const issueIdNum = parseInt(issueId);
                        
                        // è¨ˆç®—æ‰€æœ‰å±¤ç´šçš„å·¥æ™‚ï¼ˆåŒ…æ‹¬äººå“¡ã€å°ˆæ¡ˆã€ISSUEï¼‰
                        if (hours > 0) {
                            // åªæœ‰å¯¦éš› ISSUE (issueId > 0) æ‰è¨ˆå…¥é …ç›®æ•¸
                            if (issueIdNum > 0) {
                                totalHours += hours;
                                totalItems++;
                                
                                // æ ¹æ“š checkbox ç•¶å‰ç‹€æ…‹æ±ºå®šç´å…¥æˆ–æ’é™¤
                                if (checkbox.checked) {
                                    includedHours += hours;
                                    includedItems++;
                                } else {
                                    excludedHours += hours;
                                }
                            }
                        }
                    }
                }
                
                // æ¯è™•ç†ä¸€æ‰¹å°±æš«åœï¼Œè®“ UI æœ‰æ©Ÿæœƒæ›´æ–°
                if (endIndex < allCheckboxes.length) {
                    await new Promise(resolve => setTimeout(resolve, 5));
                }
            }

            console.log('è¨ˆç®—çµæœ:', {
                includedHours: includedHours.toFixed(1),
                excludedHours: excludedHours.toFixed(1),
                totalHours: totalHours.toFixed(1),
                includedItems: includedItems,
                totalItems: totalItems
            });

            // ç«‹å³æ›´æ–° DOM é¡¯ç¤º
            const includedElement = document.getElementById('includedHours');
            const excludedElement = document.getElementById('excludedHours');
            const totalElement = document.getElementById('totalHours');
            const itemsElement = document.getElementById('includedItems');
            
            if (includedElement) {
                includedElement.textContent = includedHours.toFixed(1) + ' hrs';
            }
            if (excludedElement) {
                excludedElement.textContent = excludedHours.toFixed(1) + ' hrs';
            }
            if (totalElement) {
                totalElement.textContent = totalHours.toFixed(1) + ' hrs';
            }
            if (itemsElement) {
                itemsElement.textContent = includedItems + ' / ' + totalItems;
            }
            
            console.log('=== updateCostStatisticsAsync å®Œæˆ ===');
        }

        // æ›´æ–°æˆæœ¬çµ±è¨ˆ - ç´”å‰ç«¯è¨ˆç®—
        function updateCostStatistics() {
            console.log('=== updateCostStatistics é–‹å§‹ ===');
            
            // é‡æ–°æƒææ‰€æœ‰ checkbox ä¸¦è¨ˆç®—
            const allCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]');
            console.log('æ‰¾åˆ° checkbox æ•¸é‡:', allCheckboxes.length);
            
            let includedHours = 0;
            let excludedHours = 0;
            let totalHours = 0;
            let includedItems = 0;
            let totalItems = 0;

            // éæ­·æ¯å€‹ checkboxï¼Œæ ¹æ“šç•¶å‰ç‹€æ…‹è¨ˆç®—
            allCheckboxes.forEach((checkbox, index) => {
                const hoursAttr = checkbox.getAttribute('data-hours');
                const issueId = checkbox.getAttribute('data-issue');
                
                console.log(`Checkbox ${index}:`, {
                    hoursAttr: hoursAttr,
                    issueId: issueId,
                    checked: checkbox.checked
                });
                
                // ç¢ºä¿æ˜¯æœ‰æ•ˆçš„å·¥æ™‚æ•¸æ“š
                if (hoursAttr && issueId) {
                    const hours = parseFloat(hoursAttr) || 0;
                    const issueIdNum = parseInt(issueId);
                    
                    console.log(`  -> è§£æå¾Œ: hours=${hours}, issueIdNum=${issueIdNum}`);
                    
                    // è¨ˆç®—æ‰€æœ‰å±¤ç´šçš„å·¥æ™‚ï¼ˆåŒ…æ‹¬äººå“¡ã€å°ˆæ¡ˆã€ISSUEï¼‰
                    if (hours > 0) {
                        // åªæœ‰å¯¦éš› ISSUE (issueId > 0) æ‰è¨ˆå…¥é …ç›®æ•¸
                        if (issueIdNum > 0) {
                            totalHours += hours;
                            totalItems++;
                            
                            // æ ¹æ“š checkbox ç•¶å‰ç‹€æ…‹æ±ºå®šç´å…¥æˆ–æ’é™¤
                            if (checkbox.checked) {
                                includedHours += hours;
                                includedItems++;
                                console.log(`  -> [ISSUE] ç´å…¥è¨ˆç®—: ${hours} hrs`);
                            } else {
                                excludedHours += hours;
                                console.log(`  -> [ISSUE] æ’é™¤è¨ˆç®—: ${hours} hrs`);
                            }
                        } else if (issueIdNum === -1 || issueIdNum === -2) {
                            // äººå“¡å’Œå°ˆæ¡ˆå±¤ç´šçš„ç¸½è¨ˆä¸è¨ˆå…¥çµ±è¨ˆï¼ˆé¿å…é‡è¤‡è¨ˆç®—ï¼‰
                            // å› ç‚ºå®ƒå€‘çš„å·¥æ™‚å·²ç¶“åŒ…å«åœ¨ä¸‹å±¤ ISSUE ä¸­
                            console.log(`  -> [ç¸½è¨ˆè¡Œ] è·³é: ${hours} hrs (issueId=${issueIdNum})`);
                        }
                    }
                }
            });

            console.log('è¨ˆç®—çµæœ:', {
                includedHours: includedHours.toFixed(1),
                excludedHours: excludedHours.toFixed(1),
                totalHours: totalHours.toFixed(1),
                includedItems: includedItems,
                totalItems: totalItems
            });

            // ç«‹å³æ›´æ–° DOM é¡¯ç¤º
            const includedElement = document.getElementById('includedHours');
            const excludedElement = document.getElementById('excludedHours');
            const totalElement = document.getElementById('totalHours');
            const itemsElement = document.getElementById('includedItems');
            
            console.log('DOM å…ƒç´ æª¢æŸ¥:', {
                includedElement: !!includedElement,
                excludedElement: !!excludedElement,
                totalElement: !!totalElement,
                itemsElement: !!itemsElement
            });
            
            if (includedElement) {
                const newValue = includedHours.toFixed(1) + ' hrs';
                console.log('æ›´æ–° includedHours:', includedElement.textContent, '->', newValue);
                includedElement.textContent = newValue;
                // å¼·åˆ¶é‡ç¹ª
                includedElement.style.display = 'none';
                includedElement.offsetHeight; // è§¸ç™¼ reflow
                includedElement.style.display = '';
            }
            if (excludedElement) {
                const newValue = excludedHours.toFixed(1) + ' hrs';
                console.log('æ›´æ–° excludedHours:', excludedElement.textContent, '->', newValue);
                excludedElement.textContent = newValue;
                // å¼·åˆ¶é‡ç¹ª
                excludedElement.style.display = 'none';
                excludedElement.offsetHeight;
                excludedElement.style.display = '';
            }
            if (totalElement) {
                const newValue = totalHours.toFixed(1) + ' hrs';
                console.log('æ›´æ–° totalHours:', totalElement.textContent, '->', newValue);
                totalElement.textContent = newValue;
                // å¼·åˆ¶é‡ç¹ª
                totalElement.style.display = 'none';
                totalElement.offsetHeight;
                totalElement.style.display = '';
            }
            if (itemsElement) {
                const newValue = includedItems + ' / ' + totalItems;
                console.log('æ›´æ–° includedItems:', itemsElement.textContent, '->', newValue);
                itemsElement.textContent = newValue;
                // å¼·åˆ¶é‡ç¹ª
                itemsElement.style.display = 'none';
                itemsElement.offsetHeight;
                itemsElement.style.display = '';
            }
            
            console.log('=== updateCostStatistics å®Œæˆ ===');
            
            // åŒæ™‚æ›´æ–°æ‰€æœ‰ç¸½è¨ˆè¡Œçš„å·¥æ™‚é¡¯ç¤º
            updateSummaryRowsHours();
        }

        // æ›´æ–°å°ˆæ¡ˆå’Œäººå“¡ç¸½è¨ˆè¡Œçš„å·¥æ™‚é¡¯ç¤ºï¼ˆç•°æ­¥ç‰ˆæœ¬ï¼‰
        async function updateSummaryRowsHoursAsync() {
            console.log('=== updateSummaryRowsHoursAsync é–‹å§‹ ===');
            
            // å…ˆé‡æ–°è¨ˆç®—å€é–“å·¥æ™‚ï¼Œç¢ºä¿ä½¿ç”¨æœ€æ–°çš„å€é–“æ•¸æ“š
            await calculatePeriodHoursAsync();
            
            // 1. æ”¶é›†æ¯å€‹äººå“¡çš„å·¥æ™‚æ•¸æ“š
            const userHours = {};
            
            // 2. æ”¶é›†æ¯å€‹å°ˆæ¡ˆçš„å·¥æ™‚æ•¸æ“š
            const projectHours = {};
            
            // æƒææ‰€æœ‰ ISSUE checkbox
            const allIssueCheckboxes = document.querySelectorAll('tbody input[type="checkbox"][data-issue]:not([data-issue="-1"]):not([data-issue="-2"])');
            const batchSize = 100;
            
            // åˆ†æ‰¹è™•ç† checkbox
            for (let i = 0; i < allIssueCheckboxes.length; i += batchSize) {
                const endIndex = Math.min(i + batchSize, allIssueCheckboxes.length);
                
                for (let j = i; j < endIndex; j++) {
                    const checkbox = allIssueCheckboxes[j];
                    const userName = checkbox.getAttribute('data-user');
                    const projectName = checkbox.getAttribute('data-project');
                    const issueId = checkbox.getAttribute('data-issue');
                    // ä½¿ç”¨å€é–“å…§å¯¦éš›å·¥æ™‚è€Œä¸æ˜¯é ä¼°å·¥æ™‚
                    const hours = calculateIssueActualPeriodHours(issueId);
                    const isChecked = checkbox.checked;
                    
                    if (issueId && parseInt(issueId) > 0 && hours > 0) {
                        // åˆå§‹åŒ–äººå“¡æ•¸æ“š
                        if (!userHours[userName]) {
                            userHours[userName] = { total: 0, included: 0, excluded: 0, totalCount: 0, includedCount: 0 };
                        }
                        
                        // åˆå§‹åŒ–å°ˆæ¡ˆæ•¸æ“š
                        const projectKey = `${userName}|${projectName}`;
                        if (!projectHours[projectKey]) {
                            projectHours[projectKey] = { total: 0, included: 0, excluded: 0, totalCount: 0, includedCount: 0 };
                        }
                        
                        // ç´¯è¨ˆå·¥æ™‚
                        userHours[userName].total += hours;
                        userHours[userName].totalCount++;
                        projectHours[projectKey].total += hours;
                        projectHours[projectKey].totalCount++;
                        
                        if (isChecked) {
                            userHours[userName].included += hours;
                            userHours[userName].includedCount++;
                            projectHours[projectKey].included += hours;
                            projectHours[projectKey].includedCount++;
                        } else {
                            userHours[userName].excluded += hours;
                            projectHours[projectKey].excluded += hours;
                        }
                    }
                }
                
                // æ¯è™•ç†ä¸€æ‰¹å°±æš«åœï¼Œè®“ UI æœ‰æ©Ÿæœƒæ›´æ–°
                if (endIndex < allIssueCheckboxes.length) {
                    await new Promise(resolve => setTimeout(resolve, 5));
                }
            }
            
            console.log('äººå“¡å·¥æ™‚çµ±è¨ˆ:', userHours);
            console.log('å°ˆæ¡ˆå·¥æ™‚çµ±è¨ˆ:', projectHours);
            
            // 3. æ›´æ–°äººå“¡ç¸½è¨ˆè¡Œçš„é¡¯ç¤º
            for (const userName in userHours) {
                const data = userHours[userName];
                const userSpan = document.querySelector(`span[data-user="${userName}"][data-original-hours]:not([data-project])`);
                
                if (userSpan) {
                    let displayText;
                    
                    if (data.includedCount === data.totalCount) {
                        // å…¨é¸
                        displayText = `ç¸½å·¥æ™‚: ${data.included.toFixed(1)} å°æ™‚`;
                    } else if (data.includedCount === 0) {
                        // å…¨ä¸é¸
                        displayText = `ç¸½å·¥æ™‚: 0.0 å°æ™‚ (æ’é™¤ ${data.excluded.toFixed(1)} å°æ™‚)`;
                    } else {
                        // éƒ¨åˆ†é¸å–
                        displayText = `ç¸½å·¥æ™‚: ${data.included.toFixed(1)} å°æ™‚ (æ’é™¤ ${data.excluded.toFixed(1)} å°æ™‚)`;
                    }
                    
                    console.log(`æ›´æ–°äººå“¡ ${userName}: ${userSpan.textContent} -> ${displayText}`);
                    userSpan.textContent = displayText;
                }
            }
            
            // 4. æ›´æ–°å°ˆæ¡ˆç¸½è¨ˆè¡Œçš„é¡¯ç¤º
            for (const projectKey in projectHours) {
                const [userName, projectName] = projectKey.split('|');
                const data = projectHours[projectKey];
                const projectSpan = document.querySelector(`span[data-user="${userName}"][data-project="${projectName}"][data-original-hours]`);
                
                if (projectSpan) {
                    let displayText;
                    
                    if (data.includedCount === data.totalCount) {
                        // å…¨é¸
                        displayText = `ç¸½å·¥æ™‚: ${data.included.toFixed(1)} å°æ™‚`;
                    } else if (data.includedCount === 0) {
                        // å…¨ä¸é¸
                        displayText = `ç¸½å·¥æ™‚: 0.0 å°æ™‚ (æ’é™¤ ${data.excluded.toFixed(1)} å°æ™‚)`;
                    } else {
                        // éƒ¨åˆ†é¸å–
                        displayText = `ç¸½å·¥æ™‚: ${data.included.toFixed(1)} å°æ™‚ (æ’é™¤ ${data.excluded.toFixed(1)} å°æ™‚)`;
                    }
                    
                    console.log(`æ›´æ–°å°ˆæ¡ˆ ${userName}/${projectName}: ${projectSpan.textContent} -> ${displayText}`);
                    projectSpan.textContent = displayText;
                }
            }
            
            console.log('=== updateSummaryRowsHoursAsync å®Œæˆ ===');
            
            // åŒæ™‚æ›´æ–°æ¯æ—¥/æ¯é€±/æ¯æœˆçš„å·¥ä½œé‡é¡¯ç¤º
            await updateWorkloadCellsAsync();
        }

        // æ›´æ–°å°ˆæ¡ˆå’Œäººå“¡ç¸½è¨ˆè¡Œçš„å·¥æ™‚é¡¯ç¤º
        function updateSummaryRowsHours() {
            console.log('=== updateSummaryRowsHours é–‹å§‹ ===');
            
            // 1. æ”¶é›†æ¯å€‹äººå“¡çš„å·¥æ™‚æ•¸æ“š
            const userHours = {};
            
            // 2. æ”¶é›†æ¯å€‹å°ˆæ¡ˆçš„å·¥æ™‚æ•¸æ“š
            const projectHours = {};
            
            // æƒææ‰€æœ‰ ISSUE checkbox
            const allIssueCheckboxes = document.querySelectorAll('tbody input[type="checkbox"][data-issue]:not([data-issue="-1"]):not([data-issue="-2"])');
            
            allIssueCheckboxes.forEach(checkbox => {
                const userName = checkbox.getAttribute('data-user');
                const projectName = checkbox.getAttribute('data-project');
                const issueId = checkbox.getAttribute('data-issue');
                const hours = parseFloat(checkbox.getAttribute('data-hours')) || 0;
                const isChecked = checkbox.checked;
                
                if (issueId && parseInt(issueId) > 0 && hours > 0) {
                    // åˆå§‹åŒ–äººå“¡æ•¸æ“š
                    if (!userHours[userName]) {
                        userHours[userName] = { total: 0, included: 0, excluded: 0, totalCount: 0, includedCount: 0 };
                    }
                    
                    // åˆå§‹åŒ–å°ˆæ¡ˆæ•¸æ“š
                    const projectKey = `${userName}|${projectName}`;
                    if (!projectHours[projectKey]) {
                        projectHours[projectKey] = { total: 0, included: 0, excluded: 0, totalCount: 0, includedCount: 0 };
                    }
                    
                    // ç´¯è¨ˆå·¥æ™‚
                    userHours[userName].total += hours;
                    userHours[userName].totalCount++;
                    projectHours[projectKey].total += hours;
                    projectHours[projectKey].totalCount++;
                    
                    if (isChecked) {
                        userHours[userName].included += hours;
                        userHours[userName].includedCount++;
                        projectHours[projectKey].included += hours;
                        projectHours[projectKey].includedCount++;
                    } else {
                        userHours[userName].excluded += hours;
                        projectHours[projectKey].excluded += hours;
                    }
                }
            });
            
            console.log('äººå“¡å·¥æ™‚çµ±è¨ˆ:', userHours);
            console.log('å°ˆæ¡ˆå·¥æ™‚çµ±è¨ˆ:', projectHours);
            
            // 3. æ›´æ–°äººå“¡ç¸½è¨ˆè¡Œçš„é¡¯ç¤º
            for (const userName in userHours) {
                const data = userHours[userName];
                const userSpan = document.querySelector(`span[data-user="${userName}"][data-original-hours]:not([data-project])`);
                
                if (userSpan) {
                    const originalHours = parseFloat(userSpan.getAttribute('data-original-hours')) || 0;
                    let displayText;
                    
                    if (data.includedCount === data.totalCount) {
                        // å…¨é¸
                        displayText = `ç¸½å·¥æ™‚: ${data.included.toFixed(1)} å°æ™‚`;
                    } else if (data.includedCount === 0) {
                        // å…¨ä¸é¸
                        displayText = `ç¸½å·¥æ™‚: 0.0 å°æ™‚ (æ’é™¤ ${data.excluded.toFixed(1)} å°æ™‚)`;
                    } else {
                        // éƒ¨åˆ†é¸å–
                        displayText = `ç¸½å·¥æ™‚: ${data.included.toFixed(1)} å°æ™‚ (æ’é™¤ ${data.excluded.toFixed(1)} å°æ™‚)`;
                    }
                    
                    console.log(`æ›´æ–°äººå“¡ ${userName}: ${userSpan.textContent} -> ${displayText}`);
                    userSpan.textContent = displayText;
                }
            }
            
            // 4. æ›´æ–°å°ˆæ¡ˆç¸½è¨ˆè¡Œçš„é¡¯ç¤º
            for (const projectKey in projectHours) {
                const [userName, projectName] = projectKey.split('|');
                const data = projectHours[projectKey];
                const projectSpan = document.querySelector(`span[data-user="${userName}"][data-project="${projectName}"][data-original-hours]`);
                
                if (projectSpan) {
                    const originalHours = parseFloat(projectSpan.getAttribute('data-original-hours')) || 0;
                    let displayText;
                    
                    if (data.includedCount === data.totalCount) {
                        // å…¨é¸
                        displayText = `ç¸½å·¥æ™‚: ${data.included.toFixed(1)} å°æ™‚`;
                    } else if (data.includedCount === 0) {
                        // å…¨ä¸é¸
                        displayText = `ç¸½å·¥æ™‚: 0.0 å°æ™‚ (æ’é™¤ ${data.excluded.toFixed(1)} å°æ™‚)`;
                    } else {
                        // éƒ¨åˆ†é¸å–
                        displayText = `ç¸½å·¥æ™‚: ${data.included.toFixed(1)} å°æ™‚ (æ’é™¤ ${data.excluded.toFixed(1)} å°æ™‚)`;
                    }
                    
                    console.log(`æ›´æ–°å°ˆæ¡ˆ ${userName}/${projectName}: ${projectSpan.textContent} -> ${displayText}`);
                    projectSpan.textContent = displayText;
                }
            }
            
            console.log('=== updateSummaryRowsHours å®Œæˆ ===');
            
            // åŒæ™‚æ›´æ–°æ¯æ—¥/æ¯é€±/æ¯æœˆçš„å·¥ä½œé‡é¡¯ç¤º
            updateWorkloadCells();
        }

        // æ›´æ–°æ¯æ—¥/æ¯é€±/æ¯æœˆå·¥ä½œé‡å–®å…ƒæ ¼ï¼ˆç•°æ­¥ç‰ˆæœ¬ï¼‰
        async function updateWorkloadCellsAsync() {
            console.log('=== updateWorkloadCellsAsync é–‹å§‹ ===');
            
            // ç²å–æ‰€æœ‰å·¥ä½œé‡å–®å…ƒæ ¼
            const allWorkloadCells = document.querySelectorAll('td.workload-cell[data-period-index]');
            console.log('æ‰¾åˆ°å·¥ä½œé‡å–®å…ƒæ ¼æ•¸é‡:', allWorkloadCells.length);
            
            // æŒ‰äººå“¡å’Œå°ˆæ¡ˆçµ„ç¹”æ•¸æ“šçµæ§‹
            const userPeriodData = {};      // äººå“¡å±¤ç´šçš„æ™‚é–“æ®µæ•¸æ“š
            const projectPeriodData = {};   // å°ˆæ¡ˆå±¤ç´šçš„æ™‚é–“æ®µæ•¸æ“š
            const batchSize = 200;          // æ¯æ‰¹è™•ç†çš„å–®å…ƒæ ¼æ•¸é‡
            
            // ç¬¬ä¸€æ­¥ï¼šåˆ†æ‰¹æ”¶é›†æ‰€æœ‰ ISSUE çš„æ™‚é–“æ®µæ•¸æ“š
            for (let i = 0; i < allWorkloadCells.length; i += batchSize) {
                const endIndex = Math.min(i + batchSize, allWorkloadCells.length);
                
                for (let j = i; j < endIndex; j++) {
                    const cell = allWorkloadCells[j];
                    const issueId = cell.getAttribute('data-issue');
                    const issueIdNum = parseInt(issueId);
                    
                    // åªè™•ç†å¯¦éš› ISSUE (issueId > 0)
                    if (issueIdNum > 0) {
                        const userName = cell.getAttribute('data-user');
                        const projectName = cell.getAttribute('data-project');
                        const periodIndex = cell.getAttribute('data-period-index');
                        const workload = parseFloat(cell.getAttribute('data-original-workload')) || 0;
                        
                        // æ‰¾åˆ°å°æ‡‰çš„ checkbox
                        const checkbox = document.querySelector(
                            `input[data-user="${userName}"][data-project="${projectName}"][data-issue="${issueId}"]`
                        );
                        
                        if (checkbox && workload > 0) {
                            const isChecked = checkbox.checked;
                            
                            // åˆå§‹åŒ–äººå“¡æ™‚é–“æ®µæ•¸æ“š
                            const userKey = userName;
                            if (!userPeriodData[userKey]) {
                                userPeriodData[userKey] = {};
                            }
                            if (!userPeriodData[userKey][periodIndex]) {
                                userPeriodData[userKey][periodIndex] = 0;
                            }
                            
                            // åˆå§‹åŒ–å°ˆæ¡ˆæ™‚é–“æ®µæ•¸æ“š
                            const projectKey = `${userName}|${projectName}`;
                            if (!projectPeriodData[projectKey]) {
                                projectPeriodData[projectKey] = {};
                            }
                            if (!projectPeriodData[projectKey][periodIndex]) {
                                projectPeriodData[projectKey][periodIndex] = 0;
                            }
                            
                            // åªç´¯è¨ˆå·²å‹¾é¸çš„ ISSUE å·¥ä½œé‡
                            if (isChecked) {
                                userPeriodData[userKey][periodIndex] += workload;
                                projectPeriodData[projectKey][periodIndex] += workload;
                            }
                        }
                    }
                }
                
                // æ¯è™•ç†ä¸€æ‰¹å°±æš«åœï¼Œè®“ UI æœ‰æ©Ÿæœƒæ›´æ–°
                if (endIndex < allWorkloadCells.length) {
                    await new Promise(resolve => setTimeout(resolve, 5));
                }
            }
            
            console.log('äººå“¡æ™‚é–“æ®µæ•¸æ“š:', userPeriodData);
            console.log('å°ˆæ¡ˆæ™‚é–“æ®µæ•¸æ“š:', projectPeriodData);
            
            // ç¬¬äºŒæ­¥ï¼šåˆ†æ‰¹æ›´æ–°äººå“¡ç¸½è¨ˆè¡Œçš„å·¥ä½œé‡å–®å…ƒæ ¼
            const userCells = document.querySelectorAll('td.workload-cell[data-user][data-issue="-1"][data-period-index]');
            for (let i = 0; i < userCells.length; i += batchSize) {
                const endIndex = Math.min(i + batchSize, userCells.length);
                
                for (let j = i; j < endIndex; j++) {
                    const cell = userCells[j];
                    const userName = cell.getAttribute('data-user');
                    const periodIndex = cell.getAttribute('data-period-index');
                    
                    const newWorkload = userPeriodData[userName] && userPeriodData[userName][periodIndex] 
                        ? userPeriodData[userName][periodIndex] 
                        : 0;
                    
                    const currentWorkload = parseFloat(cell.textContent) || 0;
                    if (Math.abs(currentWorkload - newWorkload) > 0.01) {
                        console.log(`æ›´æ–°äººå“¡ ${userName} æ™‚æ®µ ${periodIndex}: ${currentWorkload} -> ${newWorkload}`);
                        cell.textContent = newWorkload.toFixed(1);
                        updateWorkloadCellStyle(cell, newWorkload);
                    }
                }
                
                if (endIndex < userCells.length) {
                    await new Promise(resolve => setTimeout(resolve, 5));
                }
            }
            
            // ç¬¬ä¸‰æ­¥ï¼šåˆ†æ‰¹æ›´æ–°å°ˆæ¡ˆç¸½è¨ˆè¡Œçš„å·¥ä½œé‡å–®å…ƒæ ¼
            const projectCells = document.querySelectorAll('td.workload-cell[data-user][data-project][data-issue="-2"][data-period-index]');
            for (let i = 0; i < projectCells.length; i += batchSize) {
                const endIndex = Math.min(i + batchSize, projectCells.length);
                
                for (let j = i; j < endIndex; j++) {
                    const cell = projectCells[j];
                    const userName = cell.getAttribute('data-user');
                    const projectName = cell.getAttribute('data-project');
                    const periodIndex = cell.getAttribute('data-period-index');
                    
                    const projectKey = `${userName}|${projectName}`;
                    const newWorkload = projectPeriodData[projectKey] && projectPeriodData[projectKey][periodIndex] 
                        ? projectPeriodData[projectKey][periodIndex] 
                        : 0;
                    
                    const currentWorkload = parseFloat(cell.textContent) || 0;
                    if (Math.abs(currentWorkload - newWorkload) > 0.01) {
                        console.log(`æ›´æ–°å°ˆæ¡ˆ ${userName}/${projectName} æ™‚æ®µ ${periodIndex}: ${currentWorkload} -> ${newWorkload}`);
                        cell.textContent = newWorkload.toFixed(1);
                        updateWorkloadCellStyle(cell, newWorkload);
                    }
                }
                
                if (endIndex < projectCells.length) {
                    await new Promise(resolve => setTimeout(resolve, 5));
                }
            }
            
            console.log('=== updateWorkloadCellsAsync å®Œæˆ ===');
        }

        // æ›´æ–°æ¯æ—¥/æ¯é€±/æ¯æœˆå·¥ä½œé‡å–®å…ƒæ ¼
        function updateWorkloadCells() {
            console.log('=== updateWorkloadCells é–‹å§‹ ===');
            
            // ç²å–æ‰€æœ‰å·¥ä½œé‡å–®å…ƒæ ¼
            const allWorkloadCells = document.querySelectorAll('td.workload-cell[data-period-index]');
            console.log('æ‰¾åˆ°å·¥ä½œé‡å–®å…ƒæ ¼æ•¸é‡:', allWorkloadCells.length);
            
            // æŒ‰äººå“¡å’Œå°ˆæ¡ˆçµ„ç¹”æ•¸æ“šçµæ§‹
            const userPeriodData = {};      // äººå“¡å±¤ç´šçš„æ™‚é–“æ®µæ•¸æ“š
            const projectPeriodData = {};   // å°ˆæ¡ˆå±¤ç´šçš„æ™‚é–“æ®µæ•¸æ“š
            
            // ç¬¬ä¸€æ­¥ï¼šæ”¶é›†æ‰€æœ‰ ISSUE çš„æ™‚é–“æ®µæ•¸æ“š
            allWorkloadCells.forEach(cell => {
                const issueId = cell.getAttribute('data-issue');
                const issueIdNum = parseInt(issueId);
                
                // åªè™•ç†å¯¦éš› ISSUE (issueId > 0)
                if (issueIdNum > 0) {
                    const userName = cell.getAttribute('data-user');
                    const projectName = cell.getAttribute('data-project');
                    const periodIndex = cell.getAttribute('data-period-index');
                    const workload = parseFloat(cell.getAttribute('data-original-workload')) || 0;
                    
                    // æ‰¾åˆ°å°æ‡‰çš„ checkbox
                    const checkbox = document.querySelector(
                        `input[data-user="${userName}"][data-project="${projectName}"][data-issue="${issueId}"]`
                    );
                    
                    if (checkbox && workload > 0) {
                        const isChecked = checkbox.checked;
                        
                        // åˆå§‹åŒ–äººå“¡æ™‚é–“æ®µæ•¸æ“š
                        const userKey = userName;
                        if (!userPeriodData[userKey]) {
                            userPeriodData[userKey] = {};
                        }
                        if (!userPeriodData[userKey][periodIndex]) {
                            userPeriodData[userKey][periodIndex] = 0;
                        }
                        
                        // åˆå§‹åŒ–å°ˆæ¡ˆæ™‚é–“æ®µæ•¸æ“š
                        const projectKey = `${userName}|${projectName}`;
                        if (!projectPeriodData[projectKey]) {
                            projectPeriodData[projectKey] = {};
                        }
                        if (!projectPeriodData[projectKey][periodIndex]) {
                            projectPeriodData[projectKey][periodIndex] = 0;
                        }
                        
                        // åªç´¯è¨ˆå·²å‹¾é¸çš„ ISSUE å·¥ä½œé‡
                        if (isChecked) {
                            userPeriodData[userKey][periodIndex] += workload;
                            projectPeriodData[projectKey][periodIndex] += workload;
                        }
                    }
                }
            });
            
            console.log('äººå“¡æ™‚é–“æ®µæ•¸æ“š:', userPeriodData);
            console.log('å°ˆæ¡ˆæ™‚é–“æ®µæ•¸æ“š:', projectPeriodData);
            
            // ç¬¬äºŒæ­¥ï¼šæ›´æ–°äººå“¡ç¸½è¨ˆè¡Œçš„å·¥ä½œé‡å–®å…ƒæ ¼
            for (const userName in userPeriodData) {
                const periodData = userPeriodData[userName];
                
                for (const periodIndex in periodData) {
                    const workload = periodData[periodIndex];
                    const cell = document.querySelector(
                        `td.workload-cell[data-user="${userName}"][data-issue="-1"][data-period-index="${periodIndex}"]`
                    );
                    
                    if (cell) {
                        const oldValue = cell.textContent;
                        const newValue = workload.toFixed(1);
                        console.log(`æ›´æ–°äººå“¡ ${userName} æ™‚æ®µ ${periodIndex}: ${oldValue} -> ${newValue}`);
                        
                        // æ›´æ–°æ–‡å­—å…§å®¹
                        cell.textContent = newValue;
                        
                        // æ›´æ–°æ¨£å¼é¡åˆ¥
                        updateWorkloadCellStyle(cell, workload);
                    }
                }
            }
            
            // ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°å°ˆæ¡ˆç¸½è¨ˆè¡Œçš„å·¥ä½œé‡å–®å…ƒæ ¼
            for (const projectKey in projectPeriodData) {
                const [userName, projectName] = projectKey.split('|');
                const periodData = projectPeriodData[projectKey];
                
                for (const periodIndex in periodData) {
                    const workload = periodData[periodIndex];
                    const cell = document.querySelector(
                        `td.workload-cell[data-user="${userName}"][data-project="${projectName}"][data-issue="-2"][data-period-index="${periodIndex}"]`
                    );
                    
                    if (cell) {
                        const oldValue = cell.textContent;
                        const newValue = workload.toFixed(1);
                        console.log(`æ›´æ–°å°ˆæ¡ˆ ${userName}/${projectName} æ™‚æ®µ ${periodIndex}: ${oldValue} -> ${newValue}`);
                        
                        // æ›´æ–°æ–‡å­—å…§å®¹
                        cell.textContent = newValue;
                        
                        // æ›´æ–°æ¨£å¼é¡åˆ¥
                        updateWorkloadCellStyle(cell, workload);
                    }
                }
            }
            
            console.log('=== updateWorkloadCells å®Œæˆ ===');
        }

        // æ›´æ–°å·¥ä½œé‡å–®å…ƒæ ¼çš„æ¨£å¼é¡åˆ¥
        function updateWorkloadCellStyle(cell, workload) {
            // ç§»é™¤èˆŠçš„æ¨£å¼é¡åˆ¥
            cell.classList.remove('workload-zero', 'workload-normal', 'workload-high', 'workload-overdue');
            
            // æ ¹æ“šå·¥ä½œé‡æ·»åŠ æ–°çš„æ¨£å¼é¡åˆ¥
            if (workload === 0) {
                cell.classList.add('workload-zero');
            } else if (workload >= 8.0) {
                cell.classList.add('workload-high');
            } else {
                cell.classList.add('workload-normal');
            }
            
            // ä¿ç•™é€±æœ«å’Œé€¾æœŸæ¨£å¼ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            const isWeekend = cell.getAttribute('data-weekend') === 'true';
            const isOverdue = cell.getAttribute('data-overdue') === 'true';
            
            if (isWeekend) {
                cell.classList.add('weekend');
            }
            if (isOverdue && workload > 0) {
                cell.classList.add('workload-overdue');
            }
        }

        // å…¨é¸/å…¨ä¸é¸åŠŸèƒ½
        function toggleSelectAll(selectAllCheckbox) {
            const allCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]');
            const newState = selectAllCheckbox.checked;
            
            // æ‰¹é‡æ›´æ–°æ‰€æœ‰ checkbox ç‹€æ…‹
            allCheckboxes.forEach(checkbox => {
                if (checkbox.checked !== newState) {
                    checkbox.checked = newState;
                    toggleRowCostExclusion(checkbox);
                }
            });
            
            // ä¸€æ¬¡æ€§é‡æ–°è¨ˆç®—çµ±è¨ˆ
            updateCostStatistics();
        }

        // æ›´æ–°å…¨é¸æŒ‰éˆ•çš„ç‹€æ…‹
        function updateSelectAllState() {
            const selectAllCheckbox = document.getElementById('selectAll');
            if (!selectAllCheckbox) return;
            
            const allCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]');
            const checkedCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]:checked');
            
            if (checkedCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        // åˆå§‹åŒ–æˆæœ¬è¨ˆç®—çµ±è¨ˆ
        function initializeCostCalculation() {
            // ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚è¨ˆç®—åˆå§‹çµ±è¨ˆ
            updateCostStatistics();
        }

        // æ¸¬è©¦å‡½æ•¸ - å¯åœ¨ç€è¦½å™¨æ§åˆ¶å°å‘¼å«ä¾†æ¸¬è©¦
        function testCostCalculation() {
            console.log('=== æ¸¬è©¦æˆæœ¬è¨ˆç®—åŠŸèƒ½ ===');
            const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
            console.log('æ‰¾åˆ° checkbox æ•¸é‡:', checkboxes.length);
            
            checkboxes.forEach((checkbox, index) => {
                console.log(`Checkbox ${index}:`, {
                    issue: checkbox.getAttribute('data-issue'),
                    hours: checkbox.getAttribute('data-hours'),
                    checked: checkbox.checked
                });
            });
            
            console.log('é‡æ–°è¨ˆç®—çµ±è¨ˆ...');
            updateCostStatistics();
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–æˆæœ¬è¨ˆç®—
        document.addEventListener('DOMContentLoaded', function() {
            // ç°¡å–®å»¶é²ç¢ºä¿ DOM å®Œå…¨æº–å‚™å¥½
            setTimeout(function() {
                calculatePeriodHours();
                initializeCostCalculation();
            }, 50);
        });

        // è¨ˆç®—å€é–“å·¥æ™‚ä¸¦æ›´æ–° data-hours å±¬æ€§ï¼ˆç•°æ­¥ç‰ˆæœ¬ï¼‰
        async function calculatePeriodHoursAsync() {
            console.log('=== é–‹å§‹è¨ˆç®—å€é–“å·¥æ™‚ï¼ˆç•°æ­¥ç‰ˆæœ¬ï¼‰ ===');
            
            // ç²å–æ‰€æœ‰å·¥ä½œé‡å–®å…ƒæ ¼
            const allWorkloadCells = document.querySelectorAll('td.workload-cell[data-period-index]');
            const issueHours = {}; // å„²å­˜æ¯å€‹è­°é¡Œçš„å€é–“å·¥æ™‚
            
            // è¨ˆç®—æ¯å€‹è­°é¡Œçš„å€é–“å·¥æ™‚
            allWorkloadCells.forEach(cell => {
                const issueId = cell.getAttribute('data-issue');
                const issueIdNum = parseInt(issueId);
                
                // åªè™•ç†å¯¦éš›è­°é¡Œ (issueId > 0)
                if (issueIdNum > 0) {
                    const workload = parseFloat(cell.getAttribute('data-original-workload')) || 0;
                    
                    if (!issueHours[issueId]) {
                        issueHours[issueId] = 0;
                    }
                    issueHours[issueId] += workload;
                }
            });
            
            console.log('è­°é¡Œå€é–“å·¥æ™‚:', issueHours);
            
            // æ›´æ–°æ¯å€‹è­°é¡Œçš„ data-hours å±¬æ€§
            Object.keys(issueHours).forEach(issueId => {
                const periodHours = issueHours[issueId];
                const checkbox = document.querySelector(`input[data-issue="${issueId}"]`);
                
                if (checkbox) {
                    console.log(`æ›´æ–°è­°é¡Œ #${issueId} çš„å·¥æ™‚: ${checkbox.getAttribute('data-hours')} -> ${periodHours.toFixed(1)}`);
                    checkbox.setAttribute('data-hours', periodHours.toFixed(1));
                }
                
                // æ›´æ–°è­°é¡Œè©³ç´°é¡¯ç¤º
                const periodHoursSpan = document.getElementById(`period-hours-${issueId}`);
                if (periodHoursSpan) {
                    periodHoursSpan.textContent = `å€é–“: ${periodHours.toFixed(1)} å°æ™‚`;
                }
            });
            
            // è¨ˆç®—ä¸¦æ›´æ–°äººå“¡å’Œå°ˆæ¡ˆçš„å€é–“å·¥æ™‚
            updateUserAndProjectPeriodHours(issueHours);
            
            console.log('=== å€é–“å·¥æ™‚è¨ˆç®—å®Œæˆï¼ˆç•°æ­¥ç‰ˆæœ¬ï¼‰ ===');
        }

        // è¨ˆç®—å–®å€‹è­°é¡Œåœ¨ç•¶å‰è¨­å®šå€é–“å…§çš„å¯¦éš›å·¥æ™‚
        function calculateIssueActualPeriodHours(issueId) {
            if (!issueId || parseInt(issueId) <= 0) {
                return 0;
            }
            
            // ç²å–è©²è­°é¡Œåœ¨ç•¶å‰é¡¯ç¤ºå€é–“å…§çš„æ‰€æœ‰å·¥ä½œé‡å–®å…ƒæ ¼
            const issueCells = document.querySelectorAll(`td.workload-cell[data-issue="${issueId}"][data-period-index]`);
            let totalHours = 0;
            
            issueCells.forEach(cell => {
                const workload = parseFloat(cell.getAttribute('data-original-workload')) || 0;
                totalHours += workload;
            });
            
            return totalHours;
        }

        // è¨ˆç®—å€é–“å·¥æ™‚ä¸¦æ›´æ–° data-hours å±¬æ€§
        function calculatePeriodHours() {
            console.log('=== é–‹å§‹è¨ˆç®—å€é–“å·¥æ™‚ ===');
            
            // ç²å–æ‰€æœ‰å·¥ä½œé‡å–®å…ƒæ ¼
            const allWorkloadCells = document.querySelectorAll('td.workload-cell[data-period-index]');
            const issueHours = {}; // å„²å­˜æ¯å€‹è­°é¡Œçš„å€é–“å·¥æ™‚
            
            // è¨ˆç®—æ¯å€‹è­°é¡Œçš„å€é–“å·¥æ™‚
            allWorkloadCells.forEach(cell => {
                const issueId = cell.getAttribute('data-issue');
                const issueIdNum = parseInt(issueId);
                
                // åªè™•ç†å¯¦éš›è­°é¡Œ (issueId > 0)
                if (issueIdNum > 0) {
                    const workload = parseFloat(cell.getAttribute('data-original-workload')) || 0;
                    
                    if (!issueHours[issueId]) {
                        issueHours[issueId] = 0;
                    }
                    issueHours[issueId] += workload;
                }
            });
            
            console.log('è­°é¡Œå€é–“å·¥æ™‚:', issueHours);
            
            // æ›´æ–°æ¯å€‹è­°é¡Œçš„ data-hours å±¬æ€§
            Object.keys(issueHours).forEach(issueId => {
                const periodHours = issueHours[issueId];
                const checkbox = document.querySelector(`input[data-issue="${issueId}"]`);
                
                if (checkbox) {
                    console.log(`æ›´æ–°è­°é¡Œ #${issueId} çš„å·¥æ™‚: ${checkbox.getAttribute('data-hours')} -> ${periodHours.toFixed(1)}`);
                    checkbox.setAttribute('data-hours', periodHours.toFixed(1));
                }
                
                // æ›´æ–°è­°é¡Œè©³ç´°é¡¯ç¤º
                const periodHoursSpan = document.getElementById(`period-hours-${issueId}`);
                if (periodHoursSpan) {
                    periodHoursSpan.textContent = `å€é–“: ${periodHours.toFixed(1)} å°æ™‚`;
                }
            });
            
            // è¨ˆç®—ä¸¦æ›´æ–°äººå“¡å’Œå°ˆæ¡ˆçš„å€é–“å·¥æ™‚
            updateUserAndProjectPeriodHours(issueHours);
            
            console.log('=== å€é–“å·¥æ™‚è¨ˆç®—å®Œæˆ ===');
        }

        // æ›´æ–°äººå“¡å’Œå°ˆæ¡ˆçš„å€é–“å·¥æ™‚
        function updateUserAndProjectPeriodHours(issueHours) {
            const userHours = {};
            const projectHours = {};
            
            // æ”¶é›†æ¯å€‹è­°é¡Œçš„äººå“¡å’Œå°ˆæ¡ˆè³‡è¨Š
            Object.keys(issueHours).forEach(issueId => {
                const checkbox = document.querySelector(`input[data-issue="${issueId}"]`);
                if (checkbox) {
                    const userName = checkbox.getAttribute('data-user');
                    const projectName = checkbox.getAttribute('data-project');
                    const hours = issueHours[issueId];
                    
                    // ç´¯è¨ˆäººå“¡å·¥æ™‚
                    if (!userHours[userName]) {
                        userHours[userName] = 0;
                    }
                    userHours[userName] += hours;
                    
                    // ç´¯è¨ˆå°ˆæ¡ˆå·¥æ™‚
                    const projectKey = `${userName}|${projectName}`;
                    if (!projectHours[projectKey]) {
                        projectHours[projectKey] = 0;
                    }
                    projectHours[projectKey] += hours;
                }
            });
            
            // æ›´æ–°äººå“¡ç¸½è¨ˆè¡Œçš„ data-hours
            Object.keys(userHours).forEach(userName => {
                const userCheckbox = document.querySelector(`input[data-user="${userName}"][data-issue="-1"]`);
                if (userCheckbox) {
                    console.log(`æ›´æ–°äººå“¡ ${userName} çš„å·¥æ™‚: ${userCheckbox.getAttribute('data-hours')} -> ${userHours[userName].toFixed(1)}`);
                    userCheckbox.setAttribute('data-hours', userHours[userName].toFixed(1));
                }
                
                // æ›´æ–°äººå“¡ç¸½è¨ˆè¡Œé¡¯ç¤ºçš„ data-original-hours
                const userSpan = document.querySelector(`span[data-user="${userName}"][data-original-hours]:not([data-project])`);
                if (userSpan) {
                    userSpan.setAttribute('data-original-hours', userHours[userName].toFixed(1));
                }
            });
            
            // æ›´æ–°å°ˆæ¡ˆç¸½è¨ˆè¡Œçš„ data-hours
            Object.keys(projectHours).forEach(projectKey => {
                const [userName, projectName] = projectKey.split('|');
                const projectCheckbox = document.querySelector(`input[data-user="${userName}"][data-project="${projectName}"][data-issue="-2"]`);
                if (projectCheckbox) {
                    console.log(`æ›´æ–°å°ˆæ¡ˆ ${userName}/${projectName} çš„å·¥æ™‚: ${projectCheckbox.getAttribute('data-hours')} -> ${projectHours[projectKey].toFixed(1)}`);
                    projectCheckbox.setAttribute('data-hours', projectHours[projectKey].toFixed(1));
                }
                
                // æ›´æ–°å°ˆæ¡ˆç¸½è¨ˆè¡Œé¡¯ç¤ºçš„ data-original-hours
                const projectSpan = document.querySelector(`span[data-user="${userName}"][data-project="${projectName}"][data-original-hours]`);
                if (projectSpan) {
                    projectSpan.setAttribute('data-original-hours', projectHours[projectKey].toFixed(1));
                }
            });
        }
    </script>
</body>
</html>