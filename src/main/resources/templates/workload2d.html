<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redmine å·¥ä½œè² è¼‰ 2D åˆ†æ</title>
    <!-- Chart.js åœ–è¡¨åº« -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .back-btn {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: white;
            color: #667eea;
        }

        .info-section {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .info-item label {
            font-weight: 600;
            color: #495057;
            display: block;
            margin-bottom: 5px;
        }

        .info-item span {
            color: #667eea;
            font-weight: 600;
        }

        .analysis-section {
            padding: 30px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .workload-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 12px;
        }

        .workload-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .workload-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            vertical-align: middle;
        }

        .workload-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .workload-table tbody tr:hover {
            background-color: #e3f2fd;
        }

        /* è­°é¡Œè³‡è¨Šæ¬„ä½ */
        .issue-info {
            text-align: left !important;
            min-width: 200px;
            max-width: 300px;
        }

        .issue-title {
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }

        .issue-details {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        /* æ—¥æœŸæ¬„ä½æ¨£å¼ */
        .date-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            min-width: 40px;
            max-width: 40px;
        }

        .workload-cell {
            min-width: 40px;
            max-width: 40px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        
        /* å–®å…ƒæ ¼æ›´æ–°å‹•ç•«æ•ˆæœ */
        .cell-updated {
            background-color: #cce5ff !important;
            animation: cellFlash 0.3s ease;
        }
        
        @keyframes cellFlash {
            0% {
                background-color: #007bff;
                transform: scale(1.05);
            }
            100% {
                background-color: #cce5ff;
                transform: scale(1);
            }
        }

        /* å·¥ä½œé‡æ•¸å€¼çš„é¡è‰²ç·¨ç¢¼ */
        .workload-zero {
            background-color: #ffffff;
            color: #6c757d;
        }

        .workload-normal {
            background-color: #d4edda;
            color: #155724;
            font-weight: 600;
        }

        .workload-medium {
            background-color: #fff3cd;
            color: #856404;
            font-weight: bold;
        }

        .workload-high {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }

        .workload-overdue {
            background-color: #f8d7da;
            color: #721c24;
        }

        .weekend {
            background-color: #e9ecef;
            color: #6c757d;
        }

        /* æˆæœ¬è¨ˆç®—æ¬„ä½æ¨£å¼ */
        .cost-include {
            width: 80px;
            text-align: center;
            vertical-align: middle;
            background: #f8f9fa;
            border-right: 2px solid #dee2e6;
        }

        .cost-include input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }

        /* indeterminate ç‹€æ…‹çš„æ¨£å¼ */
        .cost-include input[type="checkbox"]:indeterminate {
            opacity: 0.7;
        }

        .cost-include label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            margin-left: 5px;
        }

        /* è¢«æ’é™¤æˆæœ¬è¨ˆç®—çš„è¡Œæ¨£å¼ */
        .excluded-from-cost {
            opacity: 0.6;
            background-color: #f8d7da !important;
        }

        .excluded-from-cost .issue-info {
            color: #721c24;
        }

        /* æˆæœ¬è¨ˆç®—çµ±è¨ˆå€åŸŸ */
        .cost-summary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cost-summary .cost-item {
            text-align: center;
        }

        .cost-summary .cost-value {
            font-size: 1.5em;
            font-weight: 700;
            display: block;
        }

        .cost-summary .cost-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Loading å‹•ç•«æ¨£å¼ */
        .loading-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.8) !important;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 99999 !important;
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 300px;
            width: 90%;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .loading-subtext {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        /* é€²åº¦æ¢å‹•ç•« */
        .loading-progress {
            width: 100%;
            height: 4px;
            background: #f0f0f0;
            border-radius: 2px;
            margin: 15px 0;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        /* å°å‹ Loading æŒ‡ç¤ºå™¨ï¼ˆç”¨æ–¼å±€éƒ¨æ›´æ–°ï¼‰ */
        .mini-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 2em;
            }

            .back-btn {
                left: 15px;
                padding: 8px 15px;
                font-size: 14px;
            }

            .info-section {
                padding: 15px;
            }

            .analysis-section {
                padding: 15px;
            }

            .workload-table {
                font-size: 10px;
            }

            .workload-table th,
            .workload-table td {
                padding: 6px 4px;
            }
        }

        /* ç¯©é¸å€åŸŸæ¨£å¼ */
        .filter-section {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .filter-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.95em;
        }

        .form-group select,
        .form-group input[type="date"] {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
        }

        .form-group select[multiple] {
            padding: 8px;
            min-height: 100px;
            max-height: 150px;
            overflow-y: auto;
        }

        .form-group select[multiple] option {
            padding: 6px 10px;
            margin: 1px 0;
            border-radius: 4px;
        }

        .form-group select[multiple] option:hover {
            background-color: #f8f9fa;
        }

        .form-group select[multiple] option:checked {
            background-color: #667eea;
            color: white;
        }

        .form-group select:focus,
        .form-group input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-text {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 4px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            align-items: end;
        }

        .btn-search,
        .btn-reset {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
        }

        .btn-search {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-reset {
            background: #6c757d;
            color: white;
        }

        .btn-reset:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .filter-section {
                padding: 20px 15px;
            }
            
            .filter-form {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .btn-group {
                grid-column: 1;
                justify-content: center;
            }
        }

        /* Loading è¦†è“‹å±¤æ¨£å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; /* é»˜èªé¡¯ç¤ºï¼Œä¹‹å¾Œé€šé JavaScript æ§åˆ¶ */
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        /* ç•¶æ²’æœ‰æ•¸æ“šæ™‚éš±è— Loading */
        .no-data ~ .loading-overlay,
        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .loading-subtext {
            font-size: 14px;
            color: #666;
        }

        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: #f0f0f0;
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* è¨ˆç®—ä¸­çš„ checkbox æ¨£å¼ */
        .calculating {
            pointer-events: none;
            opacity: 0.6;
        }

        .legend {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .month-header {
            text-align: center;
        }

        /* åˆ†å±¤å±•é–‹ç›¸é—œæ¨£å¼ */
        .expandable-row {
            cursor: pointer;
            user-select: none;
        }

        .expandable-row:hover {
            background-color: #e3f2fd !important;
        }

        .expand-icon {
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.3s ease;
            font-weight: bold;
            color: #667eea;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .user-summary {
            background-color: #e8f4fd !important;
            font-weight: bold;
            color: #1976d2;
        }

        .project-summary {
            background-color: #f3f9ff !important;
            font-weight: 600;
            color: #1565c0;
        }

        .issue-detail {
            background-color: #fafafa;
            color: #424242;
        }

        .collapsed {
            display: none;
        }

        .level-0 { padding-left: 10px !important; }
        .level-1 { padding-left: 30px !important; }
        .level-2 { padding-left: 50px !important; }

        /* åœ–è¡¨å€åŸŸæ¨£å¼ */
        .charts-container {
            margin: 40px 0;
            padding: 0 30px 30px;
            background: white;
        }

        .charts-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            border-bottom: 3px solid #667eea;
        }

        .charts-header h2 {
            font-size: 2.2em;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .charts-header p {
            font-size: 1.1em;
            color: #666;
            font-weight: 400;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .chart-item {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            border: 1px solid #e0e6ed;
            transition: all 0.3s ease;
        }

        .chart-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.15);
        }

        .chart-full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-title h3 {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .chart-title p {
            font-size: 0.95em;
            color: #666;
            line-height: 1.4;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            margin: 0 auto;
        }

        .chart-full-width .chart-wrapper {
            height: 400px;
        }

        .chart-wrapper canvas {
            max-width: 100%;
            height: auto;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .chart-full-width {
                grid-column: 1;
            }
        }

        @media (max-width: 768px) {
            .charts-container {
                padding: 0 15px 20px;
                margin: 20px 0;
            }
            
            .charts-header {
                padding: 20px 0;
                margin-bottom: 25px;
            }
            
            .charts-header h2 {
                font-size: 1.8em;
            }
            
            .chart-item {
                padding: 20px;
            }
            
            .chart-wrapper {
                height: 250px;
            }
            
            .chart-full-width .chart-wrapper {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- å·¥ä½œè² è¼‰åˆ†æè¨­å®šï¼ˆéš±è—çš„é…ç½®å€åŸŸï¼‰ -->
    <div id="workloadSettings" style="display: none;">
        <!-- Loading é¡¯ç¤ºè¨­å®šï¼šfalse = é è¨­ä¸é¡¯ç¤º Loading ç•«é¢ -->
        <input type="checkbox" id="enableLoadingOverlay" data-setting="enableLoadingOverlay">
        
        <!-- å…¶ä»–è¨­å®šå¯åœ¨æ­¤æ“´å±• -->
        <input type="checkbox" id="enableDebugMode" data-setting="enableDebugMode">
        <input type="checkbox" id="enableProgressBar" data-setting="enableProgressBar" checked>
    </div>

    <!-- Loading è¦†è“‹å±¤ -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">è¨ˆç®—ä¸­...</div>
            <div class="loading-subtext" id="loadingSubtext">æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡å·¥æ™‚çµ±è¨ˆ</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Redmine å·¥ä½œè² è¼‰ 2D åˆ†æ</h1>
            <p>è­°é¡Œå·¥ä½œé‡æ—¥æœŸåˆ†ä½ˆè¦–è¦ºåŒ–åˆ†æ</p>
        </div>

        <!-- ç¯©é¸æ¢ä»¶å€åŸŸ -->
        <div class="filter-section">
            <form id="workload2dForm" action="/workload2d" method="post" class="filter-form">
                <div class="form-group">
                    <label for="groupName">éƒ¨é–€ç¾¤çµ„</label>
                    <select id="groupName" name="groupName" required onchange="loadUsers()">
                        <option value="">è«‹é¸æ“‡éƒ¨é–€</option>
                        <option th:each="group : ${groups}" 
                                th:value="${group}" 
                                th:text="${group}"
                                th:selected="${group == selectedGroup}"></option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="userFullname">ä½¿ç”¨è€… (å¯å¤šé¸)</label>
                    <select id="userFullname" name="userFullname" multiple size="4">
                        <option value="">ğŸ¢ å…¨éƒ¨æˆå“¡ (æ•´å€‹éƒ¨é–€)</option>
                        <!-- å‹•æ…‹è¼‰å…¥çš„ä½¿ç”¨è€…é¸é …æœƒåœ¨é€™è£¡æ’å…¥ -->
                        <th:block th:if="${users != null}">
                            <option th:each="user : ${users}" 
                                    th:value="${user}" 
                                    th:text="${user}"
                                    th:selected="${selectedUsers != null and selectedUsers.contains(user)}"></option>
                        </th:block>
                    </select>
                    <small class="form-text">æŒ‰ä½ Ctrl æˆ– Cmd å¯å¤šé¸ä½¿ç”¨è€…</small>
                </div>

                <div class="form-group">
                    <label for="startDate">é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate" name="startDate" 
                           th:value="${selectedStartDate != null ? selectedStartDate : defaultStartDate}" 
                           required>
                </div>

                <div class="form-group">
                    <label for="endDate">çµæŸæ—¥æœŸ</label>
                    <input type="date" id="endDate" name="endDate" 
                           th:value="${selectedEndDate != null ? selectedEndDate : defaultEndDate}" 
                           required>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn-search">ğŸ” é‡æ–°åˆ†æ</button>
                    <button type="button" class="btn-reset" onclick="resetForm()">ğŸ”„ é‡ç½®</button>
                </div>
            </form>
        </div>

        <div class="info-section">
            <div class="info-grid">
                <div class="info-item">
                    <label>ç¾¤çµ„åç¨±ï¼š</label>
                    <span th:text="${selectedGroup}"></span>
                </div>
                <div class="info-item">
                    <label>ä½¿ç”¨è€…ï¼š</label>
                    <span th:text="${selectedUsers != null and !selectedUsers.isEmpty() ? 
                                   (selectedUsers.size() == 1 ? selectedUsers[0] : 
                                   (selectedUsers.size() + 'äºº: ' + #strings.listJoin(selectedUsers, ', '))) : 
                                   'å…¨ç¾¤çµ„'}"></span>
                </div>
                <div class="info-item">
                    <label>åˆ†ææœŸé–“ï¼š</label>
                    <span th:text="${selectedStartDate + ' ~ ' + selectedEndDate}"></span>
                </div>
                <div class="info-item">
                    <label>æ™‚é–“é¡†ç²’åº¦ï¼š</label>
                    <span>ğŸ“… æ¯æ—¥</span>
                </div>
                <div class="info-item">
                    <label>è­°é¡Œæ•¸é‡ï¼š</label>
                    <span th:text="${analysis2D != null ? analysis2D.size() : 0}"></span>
                </div>
            </div>
        </div>

        <div class="analysis-section">
            <!-- ç„¡æ•¸æ“šæç¤º -->
            <div th:if="${analysis2D == null or analysis2D.isEmpty()}" class="no-data">
                <div style="text-align: center; padding: 60px 20px; background: #f8f9fa; border-radius: 15px; margin: 20px 0;">
                    <div style="font-size: 4em; margin-bottom: 20px; color: #dee2e6;">ğŸ“Š</div>
                    <h3 style="color: #6c757d; margin-bottom: 15px; font-size: 1.5em;">å°šç„¡åˆ†ææ•¸æ“š</h3>
                    <p style="color: #6c757d; font-size: 1.1em; margin-bottom: 25px;">è«‹åœ¨ä¸Šæ–¹é¸æ“‡éƒ¨é–€ç¾¤çµ„ã€ä½¿ç”¨è€…åŠæ—¥æœŸç¯„åœï¼Œç„¶å¾Œé»æ“Šã€ŒğŸ” é‡æ–°åˆ†æã€ä¾†é–‹å§‹åˆ†æ</p>
                    <div style="background: white; padding: 20px; border-radius: 10px; border: 2px dashed #dee2e6; max-width: 500px; margin: 0 auto;">
                        <h4 style="color: #495057; margin-bottom: 10px;">ğŸ’¡ æ“ä½œæç¤º</h4>
                        <ul style="text-align: left; color: #6c757d; line-height: 1.6;">
                            <li>é¸æ“‡éƒ¨é–€ç¾¤çµ„å¾Œæœƒè‡ªå‹•è¼‰å…¥è©²éƒ¨é–€çš„ä½¿ç”¨è€…åˆ—è¡¨</li>
                            <li>å¯ä»¥é¸æ“‡ç‰¹å®šä½¿ç”¨è€…æˆ–ä¿æŒã€Œå…¨éƒ¨æˆå“¡ã€</li>
                            <li>å»ºè­°æ—¥æœŸç¯„åœä¸è¦è¶…é3å€‹æœˆä»¥ç¢ºä¿åˆ†ææ•ˆèƒ½</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- æˆæœ¬è¨ˆç®—çµ±è¨ˆ -->
            <div class="cost-summary" th:if="${analysis2D != null and !analysis2D.isEmpty()}">
                <div class="cost-item">
                    <span class="cost-value" id="includedHours">è¨ˆç®—ä¸­...</span>
                    <span class="cost-label">ç´å…¥è¨ˆç®—å·¥æ™‚</span>
                </div>
                <div class="cost-item">
                    <span class="cost-value" id="excludedHours">0</span>
                    <span class="cost-label">æ’é™¤è¨ˆç®—å·¥æ™‚</span>
                </div>
                <div class="cost-item">
                    <span class="cost-value" id="totalHours">è¨ˆç®—ä¸­...</span>
                    <span class="cost-label">ç¸½å·¥æ™‚</span>
                </div>
                <div class="cost-item">
                    <span class="cost-value" id="includedItems">è¨ˆç®—ä¸­...</span>
                    <span class="cost-label">ç´å…¥é …ç›®æ•¸</span>
                </div>
            </div>

            <div th:if="${analysis2D != null and !analysis2D.isEmpty()}">
                <div class="table-container">
                    <table class="workload-table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="cost-include">
                                    <input type="checkbox" id="selectAll" checked onchange="toggleSelectAll(this)" title="å…¨é¸/å…¨ä¸é¸">
                                    <label for="selectAll">æˆæœ¬è¨ˆç®—</label>
                                </th>
                                <th rowspan="2" class="issue-info">è­°é¡Œè³‡è¨Š</th>
                                <!-- æ¯æ—¥æ¨¡å¼ï¼šå‹•æ…‹é¡¯ç¤ºæœŸé–“å…§çš„æ‰€æœ‰æœˆä»½ -->
                                <th th:if="${timeGranularity == 'daily'}" 
                                    th:text="${#temporals.format(startDate, 'yyyyå¹´MMæœˆ')} + 
                                             (${startDate.month != endDate.month} ? (' ~ ' + ${#temporals.format(endDate, 'MMæœˆ')}) : '')" 
                                    th:attr="colspan=${daysBetween}" 
                                    class="month-header"></th>
                                <!-- æ¯é€±æ¨¡å¼ -->
                                <th th:if="${timeGranularity == 'weekly'}" 
                                    th:text="${#temporals.format(startDate, 'yyyyå¹´')} + ' é€±æ¬¡åˆ†æ (' + 
                                             ${#temporals.format(startDate, 'MMæœˆ')} + 
                                             (${startDate.month != endDate.month} ? (' ~ ' + ${#temporals.format(endDate, 'MMæœˆ')}) : '') + ')'" 
                                    th:attr="colspan=${weekCount}" class="month-header"></th>
                                <!-- æ¯æœˆæ¨¡å¼ -->
                                <th th:if="${timeGranularity == 'monthly'}" 
                                    th:text="${#temporals.format(startDate, 'yyyyå¹´')} + ' æœˆä»½åˆ†æ (' + 
                                             ${#temporals.format(startDate, 'MMæœˆ')} + 
                                             (${startDate.month != endDate.month} ? (' ~ ' + ${#temporals.format(endDate, 'MMæœˆ')}) : '') + ')'" 
                                    th:attr="colspan=${monthCount}" class="month-header"></th>
                            </tr>
                            <tr>
                                <!-- æ¯æ—¥æ¨¡å¼ï¼šå‹•æ…‹ç”Ÿæˆå¾é–‹å§‹æ—¥æœŸåˆ°çµæŸæ—¥æœŸçš„æ‰€æœ‰æ—¥æœŸæ¬„ä½ -->
                                <th th:if="${timeGranularity == 'daily'}" 
                                    th:each="i : ${#numbers.sequence(0, daysBetween - 1)}" 
                                    th:with="currentDate=${startDate.plusDays(i)}"
                                    th:text="${currentDate.dayOfMonth}"
                                    th:classappend="${currentDate.dayOfWeek.value == 6 or currentDate.dayOfWeek.value == 7} ? 'weekend' : ''"
                                    class="date-header">
                                </th>
                                
                                <!-- æ¯é€±æ¨¡å¼ï¼šä½¿ç”¨å¾Œç«¯è¨ˆç®—çš„é€±æ¬¡åˆ—è¡¨ -->
                                <th th:if="${timeGranularity == 'weekly'}" 
                                    th:each="weekNumber : ${weekNumbers}"
                                    th:text="'W' + ${weekNumber}"
                                    class="date-header">
                                </th>
                                
                                <!-- æ¯æœˆæ¨¡å¼ï¼šå‹•æ…‹ç”Ÿæˆæœˆä»½æ¬„ä½ -->
                                <th th:if="${timeGranularity == 'monthly'}" 
                                    th:each="i : ${#numbers.sequence(0, monthCount - 1)}"
                                    th:with="currentMonth=${startDate.plusMonths(i)}"
                                    th:text="${currentMonth.monthValue} + 'æœˆ'"
                                    class="date-header">
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- åˆ†å±¤é¡¯ç¤ºï¼šä½¿ç”¨è€… -> å°ˆæ¡ˆ -> è­°é¡Œ -->
                            <tr th:each="item, itemStat : ${analysis2D}" 
                                th:class="${item.issueId == -1} ? 'user-summary expandable-row' : 
                                          (${item.issueId == -2} ? 'project-summary expandable-row collapsed' : 'issue-detail collapsed')"
                                th:attr="data-user=${item.userFullname}, 
                                         data-project=${item.projectName},
                                         data-level=${item.issueId == -1} ? '0' : (${item.issueId == -2} ? '1' : '2'),
                                         data-parent=${item.issueId == -2} ? ${item.userFullname} : (${item.issueId > 0} ? ${item.userFullname + '_' + item.projectName} : '')"
                                th:onclick="${item.issueId == -1 or item.issueId == -2} ? 'toggleExpand(this)' : null">
                                
                                <td class="cost-include">
                                    <input type="checkbox" 
                                           th:id="'cost_' + ${item.userFullname} + '_' + ${item.projectName} + '_' + ${item.issueId}"
                                           th:attr="data-user=${item.userFullname}, 
                                                    data-project=${item.projectName}, 
                                                    data-issue=${item.issueId},
                                                    data-hours=${item.estimatedHours}"
                                           th:title="${item.issueId == -1} ? ('åŒ…å«ä½¿ç”¨è€… ' + ${item.userFullname} + ' çš„æˆæœ¬è¨ˆç®—') : 
                                                     (${item.issueId == -2} ? ('åŒ…å«å°ˆæ¡ˆ ' + ${item.projectName} + ' çš„æˆæœ¬è¨ˆç®—') : 
                                                     ('åŒ…å«è­°é¡Œ #' + ${item.issueId} + ' çš„æˆæœ¬è¨ˆç®—'))"
                                           checked 
                                           onchange="toggleCostCalculation(this)"
                                           onclick="event.stopPropagation();">
                                </td>
                                
                                <td class="issue-info" 
                                    th:class="${item.issueId == -1} ? 'issue-info level-0' : 
                                              (${item.issueId == -2} ? 'issue-info level-1' : 'issue-info level-2')">
                                    
                                    <!-- ä½¿ç”¨è€…ç¸½è¨ˆè¡Œ -->
                                    <div th:if="${item.issueId == -1}">
                                        <span class="expand-icon">â–¶</span>
                                        <span class="issue-title" th:text="'ğŸ‘¤ ' + ${item.userFullname}"></span>
                                        <div class="issue-details">
                                            <span th:id="'user-hours-' + ${item.userFullname.replaceAll(' ', '_')}"
                                                  th:attr="data-user=${item.userFullname}, 
                                                           data-original-hours=${item.estimatedHours}"
                                                  th:text="${item.issueSubject}"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- å°ˆæ¡ˆç¸½è¨ˆè¡Œ -->
                                    <div th:if="${item.issueId == -2}">
                                        <span class="expand-icon">â–¶</span>
                                        <span class="issue-title" th:text="'ğŸ“ ' + ${item.projectName}"></span>
                                        <div class="issue-details">
                                            <span th:id="'project-hours-' + ${item.userFullname.replaceAll(' ', '_')} + '_' + ${item.projectName.replaceAll(' ', '_')}"
                                                  th:attr="data-user=${item.userFullname}, 
                                                           data-project=${item.projectName}, 
                                                           data-original-hours=${item.estimatedHours}"
                                                  th:text="${item.issueSubject}"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- è­°é¡Œè©³ç´°è¡Œ -->
                                    <div th:if="${item.issueId > 0}">
                                        <div class="issue-title" th:text="'ğŸ“‹ ' + ${item.issueId} + ' - ' + ${item.issueSubject}"></div>
                                        <div class="issue-details">
                                            <span th:text="'æœŸé–“: ' + ${#temporals.format(item.startDate, 'yyyy-MM-dd')} + ' ~ ' + ${#temporals.format(item.dueDate, 'yyyy-MM-dd')}"></span><br/>
                                            <span th:text="'é ä¼°: ' + ${item.estimatedHours} + ' å°æ™‚'"></span><br/>
                                            <span th:id="'period-hours-' + ${item.issueId}" class="period-hours">å€é–“: è¨ˆç®—ä¸­...</span>
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- æ¯æ—¥æ¨¡å¼ï¼šé¡¯ç¤ºæ¯æ—¥å·¥ä½œé‡ -->
                                <td th:if="${timeGranularity == 'daily'}"
                                    th:each="day, iterStat : ${item.dailyWorkloads}"
                                    th:text="${day.status}"
                                    th:attr="data-user=${item.userFullname},
                                             data-project=${item.projectName},
                                             data-issue=${item.issueId},
                                             data-period-index=${iterStat.index},
                                             data-original-workload=${day.status},
                                             data-weekend=${day.weekend},
                                             data-overdue=${day.overdue}"
                                    th:class="${'workload-cell ' + (day.weekend ? 'weekend' : 
                                               (day.status == '0.0' ? 'workload-zero' : 
                                               (day.overdue ? 'workload-overdue' : 
                                               (T(java.lang.Double).parseDouble(day.status) >= 8.0 ? 'workload-high' : 
                                               (T(java.lang.Double).parseDouble(day.status) > 5.0 ? 'workload-medium' : 'workload-normal')))))}">
                                </td>
                                
                                <!-- æ¯é€±/æ¯æœˆæ¨¡å¼ï¼šé¡¯ç¤ºé€±æœŸå·¥ä½œé‡ -->
                                <td th:if="${timeGranularity != 'daily'}"
                                    th:each="period, iterStat : ${item.periodWorkloads}"
                                    th:text="${period.status}"
                                    th:attr="data-user=${item.userFullname},
                                             data-project=${item.projectName},
                                             data-issue=${item.issueId},
                                             data-period-index=${iterStat.index},
                                             data-original-workload=${period.status}"
                                    th:class="${'workload-cell ' + 
                                               (period.status == '0.0' ? 'workload-zero' : 
                                               (T(java.lang.Double).parseDouble(period.status) >= 8.0 ? 'workload-high' : 
                                               (T(java.lang.Double).parseDouble(period.status) > 5.0 ? 'workload-medium' : 'workload-normal')))}">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div th:if="${analysis2D == null or analysis2D.isEmpty()}" class="no-data">
                <h3>æŸ¥ç„¡è³‡æ–™</h3>
                <p>è«‹èª¿æ•´æŸ¥è©¢æ¢ä»¶å¾Œé‡æ–°æœå°‹</p>
            </div>
        </div>
    </div>

    <!-- äººåŠ›åˆ†æåœ–è¡¨å€åŸŸ -->
    <div th:if="${analysis2D != null and !analysis2D.isEmpty()}" class="charts-container">
        <div class="charts-header">
            <h2>ğŸ“Š äººåŠ›åˆ†æåœ–è¡¨</h2>
            <p>åŸºæ–¼ 2D å·¥ä½œè² è¼‰çŸ©é™£æ•¸æ“šçš„è¦–è¦ºåŒ–åˆ†æ</p>
        </div>
        
        <div class="charts-grid">
            <!-- äººå“¡å·¥æ™‚åˆ†ä½ˆåœ“é¤…åœ– -->
            <div class="chart-item">
                <div class="chart-title">
                    <h3>ğŸ‘¥ äººå“¡å·¥æ™‚åˆ†ä½ˆ</h3>
                    <p>é¡¯ç¤ºå„äººå“¡åœ¨é¸å®šæœŸé–“çš„å·¥æ™‚ä½”æ¯”</p>
                </div>
                <div class="chart-wrapper">
                    <canvas id="userHoursChart"></canvas>
                </div>
            </div>

            <!-- å°ˆæ¡ˆå·¥æ™‚åˆ†ä½ˆé•·æ¢åœ– -->
            <div class="chart-item">
                <div class="chart-title">
                    <h3>ğŸ“‹ å°ˆæ¡ˆå·¥æ™‚åˆ†ä½ˆ</h3>
                    <p>é¡¯ç¤ºå„å°ˆæ¡ˆçš„ç¸½å·¥æ™‚èˆ‡åˆ†ä½ˆæƒ…æ³</p>
                </div>
                <div class="chart-wrapper">
                    <canvas id="projectHoursChart"></canvas>
                </div>
            </div>

            <!-- å·¥æ™‚è¶¨å‹¢æŠ˜ç·šåœ– -->
            <div class="chart-item chart-full-width">
                <div class="chart-title">
                    <h3>ğŸ“ˆ å·¥æ™‚è¶¨å‹¢åˆ†æ</h3>
                    <p>é¡¯ç¤ºé¸å®šæœŸé–“å…§å„äººå“¡çš„å·¥æ™‚è®ŠåŒ–è¶¨å‹¢</p>
                </div>
                <div class="chart-wrapper">
                    <canvas id="workloadTrendChart"></canvas>
                </div>
            </div>

            <!-- å·¥ä½œè² è¼‰ç†±åŠ›åœ– -->
            <div class="chart-item chart-full-width">
                <div class="chart-title">
                    <h3>ğŸ”¥ å·¥ä½œè² è¼‰ç†±åŠ›åœ–</h3>
                    <p>ä»¥ç†±åŠ›åœ–æ–¹å¼å±•ç¤ºå„äººå“¡åœ¨ä¸åŒæ™‚é–“é»çš„å·¥ä½œè² è¼‰å¼·åº¦</p>
                </div>
                <div class="chart-wrapper">
                    <canvas id="workloadHeatmapChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸ Loading ä½¿ç”¨è€…è¼ªæ’­è¨ˆæ™‚å™¨ (é¿å…å¤šæ¬¡é‡é€²å‡½æ•¸é€ æˆç„¡æ³•æ¸…é™¤)
        window.__WL_ROTATE_TIMER = null;
        window.__WL_FORCE_HIDE_TIMER = null;
        // çµ±ä¸€çš„é é¢åˆå§‹åŒ–å‡½æ•¸
        function initializePage() {
            try {
                console.log('é–‹å§‹çµ±ä¸€é é¢åˆå§‹åŒ–...');
                
                // 1. è¼‰å…¥è¨­å®š
                loadConfigFromHTML();
                
                // 2. æ³¨å…¥åˆ‡æ›å™¨
                injectLoadingToggle();
                
                // 3. åˆå§‹åŒ–è¡¨æ ¼æ¨£å¼
                initializeTableStyling();
                
                // 4. åˆå§‹åŒ–ä¸»è¦åŠŸèƒ½ï¼ˆå¦‚æœæœ‰æ•¸æ“šï¼‰
                initializeMainFeatures();
                
                console.log('çµ±ä¸€é é¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('é é¢åˆå§‹åŒ–ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // è¡¨æ ¼æ¨£å¼åˆå§‹åŒ–
        function initializeTableStyling() {
            const table = document.querySelector('.workload-table');
            if (table) {
                // ç‚ºè¡¨æ ¼æ·»åŠ æ»¾å‹•æç¤º
                const container = table.closest('.table-container');
                if (container && container.scrollWidth > container.clientWidth) {
                    container.style.border = '2px solid #667eea';
                    container.style.borderRadius = '8px';
                    container.title = 'æ­¤è¡¨æ ¼æ”¯æ´æ©«å‘æ»¾å‹•';
                }
            }
        }

        // ä¸»è¦åŠŸèƒ½åˆå§‹åŒ–
        function initializeMainFeatures() {
            // æª¢æŸ¥æ˜¯å¦æœ‰ 2D åˆ†ææ•¸æ“š
            const hasData = document.querySelector('tbody tr[data-level="0"]');
            
            if (!hasData) {
                console.log('æ²’æœ‰æ•¸æ“šï¼Œè·³éä¸»è¦åŠŸèƒ½åˆå§‹åŒ–');
                return;
            }
            
            console.log('æª¢æ¸¬åˆ°æ•¸æ“šï¼Œé–‹å§‹ä¸»è¦åŠŸèƒ½åˆå§‹åŒ–...');
            
            // ç°¡å–®å»¶é²ç¢ºä¿ DOM å®Œå…¨æº–å‚™å¥½
            setTimeout(async function() {
                try {
                    console.log('é–‹å§‹åˆå§‹åŒ– 2D åˆ†æç³»çµ±...');
                    // é¡¯ç¤ºåˆå§‹åŒ– LOADINGï¼ˆä¾ HTML è¨­å®šæ±ºå®šï¼‰
                    showLoading('åˆå§‹åŒ–ä¸­...', 'æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡å·¥æ™‚çµ±è¨ˆ');
                    // å»ºç«‹å…¨åŸŸå¿«å– (åˆæ¬¡)
                    await buildWorkloadCache();
                    
                    // è¨­ç½® DOM è®ŠåŒ–ç›£è½å™¨ï¼Œç›£æ§æ–°å¢çš„ issue-title
                    setupDOMChangeObserver();
                    
                    // æ›´æ–°é€²åº¦åˆ° 20%
                    try {
                        updateProgress(20);
                    } catch (progressError) {
                        console.warn('æ›´æ–°é€²åº¦å¤±æ•—:', progressError);
                    }
                    
                    // è¨ˆç®—å€é–“å·¥æ™‚
                    console.log('è¨ˆç®—å€é–“å·¥æ™‚...');
                    await calculatePeriodHoursAsync();
                    // è¨ˆç®—å®Œæˆå¾Œåˆ·æ–°å¿«å–å…§çš„ periodHours
                    refreshIssuePeriodHours();
                    try {
                        updateProgress(40);
                    } catch (progressError) {
                        console.warn('æ›´æ–°é€²åº¦å¤±æ•—:', progressError);
                    }
                    
                    // åˆå§‹åŒ–æˆæœ¬è¨ˆç®—
                    console.log('åˆå§‹åŒ–æˆæœ¬è¨ˆç®—...');
                    initializeCostCalculation();
                    try {
                        updateProgress(60);
                    } catch (progressError) {
                        console.warn('æ›´æ–°é€²åº¦å¤±æ•—:', progressError);
                    }
                    
                    // åˆå§‹åŒ–åœ–è¡¨ï¼ˆç­‰å¾…å®Œæˆï¼‰
                    console.log('åˆå§‹åŒ–åœ–è¡¨...');
                    await initializeCharts();
                    try {
                        updateProgress(80);
                    } catch (progressError) {
                        console.warn('æ›´æ–°é€²åº¦å¤±æ•—:', progressError);
                    }
                    
                    // æœ€çµ‚æ›´æ–°
                    try {
                        updateProgress(100);
                    } catch (progressError) {
                        console.warn('æ›´æ–°é€²åº¦å¤±æ•—:', progressError);
                    }
                    
                    console.log('2D åˆ†æç³»çµ±åˆå§‹åŒ–å®Œæˆï¼ˆTABLE + CHART å…¨éƒ¨å®Œæˆï¼‰');
                    
                } catch (error) {
                    console.error('åˆå§‹åŒ–éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
                } finally {
                    // å»¶é²éš±è— Loadingï¼Œç¢ºä¿ç”¨æˆ¶çœ‹åˆ° 100% å®Œæˆä¸”æ‰€æœ‰åœ–è¡¨éƒ½å·²æ¸²æŸ“
                    setTimeout(() => {
                        try {
                            hideLoading();
                            console.log('Loading éš±è—ï¼Œåˆå§‹åŒ–æµç¨‹å®Œæˆï¼ˆTABLE + CHARTï¼‰');
                        } catch (hideError) {
                            console.warn('éš±è— Loading æ™‚ç™¼ç”ŸéŒ¯èª¤:', hideError);
                        }
                    }, 500);
                }
            }, 200);
        }

        // é€™å€‹ç›£è½å™¨ç¾åœ¨åªæ˜¯ç‚ºäº†å‘å¾Œå…¼å®¹ï¼Œå¯¦éš›åŠŸèƒ½å·²è½‰ç§»åˆ°çµ±ä¸€åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('èˆŠç‰ˆ DOMContentLoaded ç›£è½å™¨ï¼ˆå·²æ£„ç”¨ï¼ŒåŠŸèƒ½è½‰ç§»åˆ°çµ±ä¸€åˆå§‹åŒ–ï¼‰');
            
            // åªåœ¨æœ‰æ•¸æ“šæ™‚åŸ·è¡Œ
            const hasData = document.querySelector('tbody tr[data-level="0"]');
            if (!hasData) {
                console.log('ç„¡æ•¸æ“šï¼Œè·³éèˆŠç‰ˆåˆå§‹åŒ–');
                return;
            }
            
            // ä¿ç•™è¡¨æ ¼æ»¾å‹•æç¤ºåŠŸèƒ½
            const table = document.querySelector('.workload-table');
            if (table) {
                const container = table.closest('.table-container');
                if (container && container.scrollWidth > container.clientWidth) {
                    container.style.border = '2px solid #667eea';
                    container.style.borderRadius = '8px';
                    container.title = 'è¡¨æ ¼å¯å·¦å³æ»¾å‹•æŸ¥çœ‹æ›´å¤šå…§å®¹';
                }
            }
            
            // åˆå§‹åŒ–ï¼šåªé¡¯ç¤ºä½¿ç”¨è€…ç¸½è¨ˆè¡Œ
            initializeExpandState();
        });

        // åˆå§‹åŒ–å±•é–‹ç‹€æ…‹ï¼šé è¨­åªé¡¯ç¤ºä½¿ç”¨è€…ç¸½è¨ˆ
        function initializeExpandState() {
            const cache = window.__WL_CACHE__;
            if (!cache || !cache.issues) {
                console.warn('[initializeExpandState] å¿«å–æœªå°±ç·’ï¼Œç„¡æ³•åˆå§‹åŒ–å±•é–‹ç‹€æ…‹');
                return;
            }
            
            // ä½¿ç”¨å¿«å–çš„ issues é™£åˆ—
            cache.issues.forEach(issue => {
                if (!issue.row) return;
                const level = issue.row.getAttribute('data-level');
                if (level === '1' || level === '2') {
                    issue.row.classList.add('collapsed');
                }
            });
            
            if (cache.DEBUG) {
                console.log('[initializeExpandState] å·²åˆå§‹åŒ–å±•é–‹ç‹€æ…‹');
            }
        }

        // åˆ‡æ›å±•é–‹/æ”¶åˆç‹€æ…‹
        function toggleExpand(clickedRow) {
            const level = clickedRow.getAttribute('data-level');
            const icon = clickedRow.querySelector('.expand-icon');
            const isExpanded = icon.classList.contains('expanded');
            
            if (level === '0') {
                // ä½¿ç”¨è€…å±¤ç´šï¼šåˆ‡æ›è©²ä½¿ç”¨è€…ä¸‹çš„æ‰€æœ‰å°ˆæ¡ˆ
                toggleUserProjects(clickedRow, !isExpanded);
            } else if (level === '1') {
                // å°ˆæ¡ˆå±¤ç´šï¼šåˆ‡æ›è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰è­°é¡Œ
                toggleProjectIssues(clickedRow, !isExpanded);
            }
            
            // æ›´æ–°åœ–ç¤º
            if (isExpanded) {
                icon.classList.remove('expanded');
                icon.textContent = 'â–¶';
            } else {
                icon.classList.add('expanded');
                icon.textContent = 'â–¼';
            }
        }

        // åˆ‡æ›ä½¿ç”¨è€…ä¸‹çš„å°ˆæ¡ˆé¡¯ç¤º
        function toggleUserProjects(userRow, expand) {
            const userName = userRow.getAttribute('data-user');
            const cache = window.__WL_CACHE__;
            if (!cache || !cache.users || !cache.users[userName]) {
                console.warn('[toggleUserProjects] å¿«å–æœªå°±ç·’æˆ–æ‰¾ä¸åˆ°ä½¿ç”¨è€…:', userName);
                return;
            }
            
            const userData = cache.users[userName];
            
            // éæ­·è©²ä½¿ç”¨è€…çš„æ‰€æœ‰å°ˆæ¡ˆ
            Object.keys(userData.projects).forEach(projectName => {
                const projectData = userData.projects[projectName];
                if (!projectData.row) return;
                
                const row = projectData.row;
                const rowLevel = row.getAttribute('data-level');
                
                if (rowLevel === '1') {
                    // å°ˆæ¡ˆè¡Œ
                    if (expand) {
                        row.classList.remove('collapsed');
                    } else {
                        row.classList.add('collapsed');
                        // åŒæ™‚æ”¶åˆè©²å°ˆæ¡ˆä¸‹çš„è­°é¡Œ
                        hideProjectIssues(userName, projectName);
                        // é‡ç½®å°ˆæ¡ˆçš„å±•é–‹åœ–ç¤º
                        const projectIcon = row.querySelector('.expand-icon');
                        if (projectIcon) {
                            projectIcon.classList.remove('expanded');
                            projectIcon.textContent = 'â–¶';
                        }
                    }
                }
            });
        }

        // åˆ‡æ›å°ˆæ¡ˆä¸‹çš„è­°é¡Œé¡¯ç¤º
        function toggleProjectIssues(projectRow, expand) {
            const userName = projectRow.getAttribute('data-user');
            const projectName = projectRow.getAttribute('data-project');
            const cache = window.__WL_CACHE__;
            if (!cache || !cache.users || !cache.users[userName]) {
                console.warn('[toggleProjectIssues] å¿«å–æœªå°±ç·’æˆ–æ‰¾ä¸åˆ°ä½¿ç”¨è€…:', userName);
                return;
            }
            
            const userData = cache.users[userName];
            if (!userData.projects || !userData.projects[projectName]) {
                console.warn('[toggleProjectIssues] æ‰¾ä¸åˆ°å°ˆæ¡ˆ:', userName, projectName);
                return;
            }
            
            const projectData = userData.projects[projectName];
            
            // éæ­·è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰è­°é¡Œ
            projectData.issues.forEach(issueObj => {
                if (issueObj && issueObj.row) {
                    if (expand) {
                        issueObj.row.classList.remove('collapsed');
                    } else {
                        issueObj.row.classList.add('collapsed');
                    }
                }
            });
        }

        // éš±è—å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰è­°é¡Œ
        function hideProjectIssues(userName, projectName) {
            const cache = window.__WL_CACHE__;
            if (!cache || !cache.users || !cache.users[userName]) {
                console.warn('[hideProjectIssues] å¿«å–æœªå°±ç·’æˆ–æ‰¾ä¸åˆ°ä½¿ç”¨è€…:', userName);
                return;
            }
            
            const userData = cache.users[userName];
            if (!userData.projects || !userData.projects[projectName]) {
                console.warn('[hideProjectIssues] æ‰¾ä¸åˆ°å°ˆæ¡ˆ:', userName, projectName);
                return;
            }
            
            const projectData = userData.projects[projectName];
            
            // éæ­·è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰è­°é¡Œ
            projectData.issues.forEach(issueObj => {
                if (issueObj && issueObj.row) {
                    issueObj.row.classList.add('collapsed');
                }
            });
        }

        // === Loading ç®¡ç†åŠŸèƒ½ ===
        
        function updateProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            } else {
                // å¦‚æœæ‰¾ä¸åˆ°é€²åº¦æ¢ï¼Œè¨˜éŒ„èª¿è©¦è¨Šæ¯
                const cache = window.__WL_CACHE__;
                if (cache && cache.DEBUG) {
                    console.warn('[Progress] æ‰¾ä¸åˆ°é€²åº¦æ¢å…ƒç´  #progressBar');
                }
            }
        }

        // === æˆæœ¬è¨ˆç®—åŠŸèƒ½ ===
        
        // åˆ‡æ›å–®å€‹é …ç›®çš„æˆæœ¬è¨ˆç®— - éšå±¤å¼å‹¾é¸é‚è¼¯ï¼ˆå„ªåŒ–ç‰ˆï¼šå¿«é€Ÿå›æ‡‰+æ’ç¨‹é‡ç®—ï¼‰
        function toggleCostCalculation(checkbox) {
            const issueId = checkbox.getAttribute('data-issue');
            const userName = checkbox.getAttribute('data-user');
            const projectName = checkbox.getAttribute('data-project');
            const isChecked = checkbox.checked;
            
            const cache = window.__WL_CACHE__;
            if (cache && cache.DEBUG) console.log('[Toggle]', { issueId, userName, projectName, isChecked });
            
            // ç«‹å³é¡¯ç¤º Loadingï¼ˆæä¾›å³æ™‚åé¥‹ï¼‰
            showLoading('æ›´æ–°ä¸­...', 'æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡æ¯æ—¥å·¥æ™‚');
            
            // ä½¿ç”¨ setTimeout ç¢ºä¿è™•ç†é †åºæ­£ç¢º
            setTimeout(() => {
                // ç«‹å³åŒæ­¥æ›´æ–°è¦–è¦ºæ¨£å¼ï¼ˆç„¡å»¶é²ï¼Œä½¿ç”¨è€…é«”é©—æ›´å¥½ï¼‰
                if (issueId === '-1') {
                    // äººå“¡å±¤ç´šï¼šæ‰¹é‡æ›´æ–°è©²äººå“¡ä¸‹æ‰€æœ‰å°ˆæ¡ˆå’Œ ISSUEï¼ˆåŒæ­¥ï¼‰
                    if (cache && cache.DEBUG) console.log('è™•ç†äººå“¡å±¤ç´šå‹¾é¸:', userName, isChecked);
                    handleUserLevelToggleSync(userName, isChecked);
                } else if (issueId === '-2') {
                    // å°ˆæ¡ˆå±¤ç´šï¼šæ‰¹é‡æ›´æ–°è©²å°ˆæ¡ˆä¸‹æ‰€æœ‰ ISSUEï¼ˆåŒæ­¥ï¼‰
                    if (cache && cache.DEBUG) console.log('è™•ç†å°ˆæ¡ˆå±¤ç´šå‹¾é¸:', userName, projectName, isChecked);
                    handleProjectLevelToggleSync(userName, projectName, isChecked);
                } else {
                    // ISSUE å±¤ç´šï¼šæ›´æ–°å–®å€‹ ISSUE è¦–è¦ºæ¨£å¼ï¼Œä¸¦æ›´æ–°çˆ¶å±¤ç‹€æ…‹
                    if (cache && cache.DEBUG) console.log('è™•ç† ISSUE å±¤ç´šå‹¾é¸:', issueId, isChecked);
                    toggleRowCostExclusion(checkbox);
                    updateProjectCheckboxState(userName, projectName);
                    updateParentCheckboxState(userName);
                }
                
                // æ›´æ–°å…¨é¸ç‹€æ…‹ï¼ˆè¼•é‡ç´šï¼‰
                updateSelectAllState();
                
                // æ’ç¨‹ç•°æ­¥é‡ç®—ï¼ˆå»æŠ–å‹•ï¼Œé¿å…é »ç¹è¨ˆç®—ï¼‰
                if (cache && cache.DEBUG) console.log('æ’ç¨‹æˆæœ¬é‡ç®—...');
                scheduleCostAndSummaryRecalc('toggle');
            }, 50); // çŸ­æš«å»¶é²ç¢ºä¿ Loading é¡¯ç¤º
        }

        // è™•ç†äººå“¡å±¤ç´šçš„å‹¾é¸/å–æ¶ˆå‹¾é¸ï¼ˆç•°æ­¥ç‰ˆæœ¬ - ä½¿ç”¨å…§å­˜æ¨¡å‹ï¼‰
        async function handleUserLevelToggleAsync(userName, isChecked) {
            console.log(`è™•ç†äººå“¡å±¤ç´š: ${userName}, å‹¾é¸=${isChecked}`);
            
            const cache = window.__WL_CACHE__;
            if (!cache || !cache.users[userName]) {
                console.warn('Cache æœªåˆå§‹åŒ–æˆ–æ‰¾ä¸åˆ°ä½¿ç”¨è€…:', userName);
                return;
            }
            
            let updatedCount = 0;
            const userObj = cache.users[userName];
            
            // æ›´æ–°äººå“¡å±¤ç´š checkbox
            if (userObj.checkbox) {
                userObj.checkbox.checked = isChecked;
                toggleRowCostExclusion(userObj.checkbox);
                updatedCount++;
            }
            
            // éæ­·è©²äººå“¡çš„æ‰€æœ‰å°ˆæ¡ˆï¼ˆä½¿ç”¨å…§å­˜æ¨¡å‹ï¼‰
            for (const projectName of userObj.projects) {
                const projectKey = `${userName}|${projectName}`;
                const projectObj = cache.projects[projectKey];
                
                if (projectObj && projectObj.checkbox) {
                    if (projectObj.checkbox.checked !== isChecked) {
                        projectObj.checkbox.checked = isChecked;
                        toggleRowCostExclusion(projectObj.checkbox);
                        updatedCount++;
                    }
                    
                    // æ›´æ–°è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰ ISSUEï¼ˆä½¿ç”¨å…§å­˜æ¨¡å‹ï¼‰
                    for (const issueObj of projectObj.issues) {
                        if (issueObj.checkbox && issueObj.checkbox.checked !== isChecked) {
                            issueObj.checkbox.checked = isChecked;
                            toggleRowCostExclusion(issueObj.checkbox);
                            updatedCount++;
                        }
                    }
                }
            }
            
            console.log(`[Cache] äººå“¡ ${userName} çš„æ‰€æœ‰é …ç›®å·²æ›´æ–°ç‚º: ${isChecked}, å…±æ›´æ–° ${updatedCount} å€‹é …ç›®`);
        }

        // è™•ç†å°ˆæ¡ˆå±¤ç´šçš„å‹¾é¸/å–æ¶ˆå‹¾é¸ï¼ˆç•°æ­¥ç‰ˆæœ¬ - ä½¿ç”¨å…§å­˜æ¨¡å‹ï¼‰
        async function handleProjectLevelToggleAsync(userName, projectName, isChecked) {
            console.log(`è™•ç†å°ˆæ¡ˆå±¤ç´š: ${userName}/${projectName}, å‹¾é¸=${isChecked}`);
            
            const cache = window.__WL_CACHE__;
            const projectKey = `${userName}|${projectName}`;
            
            if (!cache || !cache.projects[projectKey]) {
                console.warn('Cache æœªåˆå§‹åŒ–æˆ–æ‰¾ä¸åˆ°å°ˆæ¡ˆ:', projectKey);
                return;
            }
            
            let updatedCount = 0;
            const projectObj = cache.projects[projectKey];
            
            // æ›´æ–°å°ˆæ¡ˆå±¤ç´š checkbox
            if (projectObj.checkbox) {
                projectObj.checkbox.checked = isChecked;
                toggleRowCostExclusion(projectObj.checkbox);
                updatedCount++;
            }
            
            // éæ­·è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰ ISSUEï¼ˆä½¿ç”¨å…§å­˜æ¨¡å‹ï¼‰
            for (const issueObj of projectObj.issues) {
                if (issueObj.checkbox && issueObj.checkbox.checked !== isChecked) {
                    issueObj.checkbox.checked = isChecked;
                    toggleRowCostExclusion(issueObj.checkbox);
                    updatedCount++;
                }
            }
            
            console.log(`[Cache] å°ˆæ¡ˆ ${userName}/${projectName} ä¸‹çš„æ‰€æœ‰ ISSUE å·²æ›´æ–°ç‚º: ${isChecked}, å…±æ›´æ–° ${updatedCount} å€‹é …ç›®`);
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°äººå“¡å±¤ç´šçš„ç‹€æ…‹
            updateParentCheckboxState(userName);
        }

        // è™•ç†äººå“¡å±¤ç´šçš„å‹¾é¸/å–æ¶ˆå‹¾é¸ï¼ˆåŒæ­¥ç‰ˆæœ¬ï¼šç«‹å³ UI æ›´æ–° - ä½¿ç”¨å…§å­˜æ¨¡å‹ï¼‰
        function handleUserLevelToggleSync(userName, isChecked) {
            const cache = window.__WL_CACHE__;
            if (!cache || !cache.users[userName]) {
                console.warn('Cache æœªåˆå§‹åŒ–æˆ–æ‰¾ä¸åˆ°ä½¿ç”¨è€…:', userName);
                return;
            }
            
            const userObj = cache.users[userName];
            let updatedCount = 0;
            
            // æ›´æ–°äººå“¡ checkbox
            if (userObj.checkbox) {
                userObj.checkbox.checked = isChecked;
                toggleRowCostExclusion(userObj.checkbox);
                updatedCount++;
            }
            
            // éæ­·æ‰€æœ‰å°ˆæ¡ˆå’Œ ISSUEï¼ˆä½¿ç”¨å…§å­˜æ¨¡å‹ï¼‰
            // ä¿®å¾©ï¼šä½¿ç”¨ Object.entries() æ­£ç¢ºéæ­·ç‰©ä»¶
            for (const [projectName, projectObj] of Object.entries(userObj.projects)) {
                // æ›´æ–°å°ˆæ¡ˆ checkbox
                if (projectObj.checkbox && projectObj.checkbox.checked !== isChecked) {
                    projectObj.checkbox.checked = isChecked;
                    toggleRowCostExclusion(projectObj.checkbox);
                    updatedCount++;
                }
                
                // æ›´æ–°æ‰€æœ‰ ISSUE checkbox
                for (const issueObj of projectObj.issues) {
                    if (issueObj.checkbox && issueObj.checkbox.checked !== isChecked) {
                        issueObj.checkbox.checked = isChecked;
                        toggleRowCostExclusion(issueObj.checkbox);
                        updatedCount++;
                    }
                }
            }
            
            if (cache.DEBUG) {
                console.log(`[Cache] äººå“¡ ${userName} éšå±¤å‹¾é¸: ${isChecked}, å½±éŸ¿ ${updatedCount} å€‹é …ç›®`);
            }
        }

        // è™•ç†å°ˆæ¡ˆå±¤ç´šçš„å‹¾é¸/å–æ¶ˆå‹¾é¸ï¼ˆåŒæ­¥ç‰ˆæœ¬ï¼šç«‹å³ UI æ›´æ–° - ä½¿ç”¨å…§å­˜æ¨¡å‹ï¼‰
        function handleProjectLevelToggleSync(userName, projectName, isChecked) {
            const cache = window.__WL_CACHE__;
            const projectKey = `${userName}|${projectName}`;
            
            if (!cache || !cache.projects[projectKey]) {
                console.warn('Cache æœªåˆå§‹åŒ–æˆ–æ‰¾ä¸åˆ°å°ˆæ¡ˆ:', projectKey);
                return;
            }
            
            const projectObj = cache.projects[projectKey];
            let updatedCount = 0;
            
            // æ›´æ–°å°ˆæ¡ˆ checkbox
            if (projectObj.checkbox) {
                projectObj.checkbox.checked = isChecked;
                toggleRowCostExclusion(projectObj.checkbox);
                updatedCount++;
            }
            
            // éæ­·è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰ ISSUEï¼ˆä½¿ç”¨å…§å­˜æ¨¡å‹ï¼‰
            for (const issueObj of projectObj.issues) {
                if (issueObj.checkbox && issueObj.checkbox.checked !== isChecked) {
                    issueObj.checkbox.checked = isChecked;
                    toggleRowCostExclusion(issueObj.checkbox);
                    updatedCount++;
                }
            }
            
            if (cache.DEBUG) {
                console.log(`[Cache] å°ˆæ¡ˆ ${projectName} éšå±¤å‹¾é¸: ${isChecked}, å½±éŸ¿ ${updatedCount} å€‹é …ç›®`);
            }
            
            // æ›´æ–°å®Œå°ˆæ¡ˆä¸‹çš„æ‰€æœ‰ ISSUE å¾Œï¼Œæª¢æŸ¥ä¸¦æ›´æ–°äººå“¡å±¤ç´šç‹€æ…‹
            updateParentCheckboxState(userName);
        }
        
        // ä¿ç•™èˆŠåŒæ­¥ç‰ˆæœ¬ä½œç‚ºåˆ¥åï¼ˆå‘å¾Œç›¸å®¹ï¼‰
        function handleUserLevelToggle(userName, isChecked) { handleUserLevelToggleSync(userName, isChecked); }
        function handleProjectLevelToggle(userName, projectName, isChecked) { handleProjectLevelToggleSync(userName, projectName, isChecked); }

        // æ›´æ–°å°ˆæ¡ˆå±¤ç´š checkbox çš„ç‹€æ…‹ï¼ˆç•¶ ISSUE æ”¹è®Šæ™‚ï¼‰
        function updateProjectCheckboxState(userName, projectName) {
            const cache = window.__WL_CACHE__;
            if (!cache || !cache.users || !cache.users[userName]) {
                console.warn('[updateProjectCheckboxState] å¿«å–æœªå°±ç·’æˆ–æ‰¾ä¸åˆ°ä½¿ç”¨è€…:', userName);
                return;
            }
            
            const userData = cache.users[userName];
            if (!userData.projects || !userData.projects[projectName]) {
                console.warn('[updateProjectCheckboxState] æ‰¾ä¸åˆ°å°ˆæ¡ˆ:', userName, projectName);
                return;
            }
            
            const projectData = userData.projects[projectName];
            const projectCheckbox = projectData.checkbox;
            
            if (!projectCheckbox) {
                console.warn('[updateProjectCheckboxState] æ‰¾ä¸åˆ°å°ˆæ¡ˆ checkbox:', userName, projectName);
                return;
            }
            
            // æª¢æŸ¥è©²å°ˆæ¡ˆä¸‹çš„æ‰€æœ‰ ISSUE ç‹€æ…‹
            let checkedCount = 0;
            let totalCount = projectData.issues.length;
            
            projectData.issues.forEach(issueObj => {
                if (issueObj && issueObj.checkbox && issueObj.checkbox.checked) {
                    checkedCount++;
                }
            });
            
            console.log(`å°ˆæ¡ˆ ${userName}/${projectName}: ${checkedCount}/${totalCount} å€‹ ISSUE å·²å‹¾é¸`);
            
            // æ ¹æ“šå­é …ç›®ç‹€æ…‹æ›´æ–°å°ˆæ¡ˆ checkbox
            if (checkedCount === totalCount) {
                // å…¨éƒ¨å‹¾é¸
                projectCheckbox.checked = true;
                projectCheckbox.indeterminate = false;
                console.log('  -> å°ˆæ¡ˆç‹€æ…‹: å…¨é¸');
            } else if (checkedCount === 0) {
                // å…¨éƒ¨æœªå‹¾é¸
                projectCheckbox.checked = false;
                projectCheckbox.indeterminate = false;
                console.log('  -> å°ˆæ¡ˆç‹€æ…‹: æœªé¸');
            } else {
                // éƒ¨åˆ†å‹¾é¸ - é€™æ˜¯é—œéµï¼ä¸è¦å–æ¶ˆå°ˆæ¡ˆçš„ checkedï¼Œè€Œæ˜¯è¨­ç‚º indeterminate
                projectCheckbox.checked = true; // ä¿æŒå‹¾é¸ç‹€æ…‹
                projectCheckbox.indeterminate = true; // ä½†é¡¯ç¤ºç‚ºéƒ¨åˆ†é¸å–
                console.log('  -> å°ˆæ¡ˆç‹€æ…‹: éƒ¨åˆ†é¸å–');
            }
            
            toggleRowCostExclusion(projectCheckbox);
        }

        // æ›´æ–°äººå“¡å±¤ç´š checkbox çš„ç‹€æ…‹ï¼ˆç•¶å°ˆæ¡ˆæ”¹è®Šæ™‚ï¼‰
        function updateParentCheckboxState(userName) {
            const cache = window.__WL_CACHE__;
            if (!cache || !cache.users || !cache.users[userName]) {
                console.warn('[updateParentCheckboxState] å¿«å–æœªå°±ç·’æˆ–æ‰¾ä¸åˆ°ä½¿ç”¨è€…:', userName);
                return;
            }
            
            const userData = cache.users[userName];
            const userCheckbox = userData.checkbox;
            
            if (!userCheckbox) {
                console.warn('[updateParentCheckboxState] æ‰¾ä¸åˆ°ä½¿ç”¨è€… checkbox:', userName);
                return;
            }
            
            // æ”¶é›†è©²äººå“¡ä¸‹çš„æ‰€æœ‰ ISSUE checkbox
            const allIssueCheckboxes = [];
            Object.keys(userData.projects).forEach(projectName => {
                const projectData = userData.projects[projectName];
                projectData.issues.forEach(issueObj => {
                    if (issueObj && issueObj.checkbox) {
                        allIssueCheckboxes.push(issueObj.checkbox);
                    }
                });
            });
            
            if (allIssueCheckboxes.length === 0) return;
            
            let checkedCount = 0;
            let totalCount = allIssueCheckboxes.length;
            
            allIssueCheckboxes.forEach(cb => {
                if (cb.checked) checkedCount++;
            });
            
            console.log(`äººå“¡ ${userName}: ${checkedCount}/${totalCount} å€‹ ISSUE å·²å‹¾é¸`);
            
            // æ ¹æ“šå­é …ç›®ç‹€æ…‹æ›´æ–°äººå“¡ checkbox
            if (checkedCount === totalCount) {
                // å…¨éƒ¨å‹¾é¸
                userCheckbox.checked = true;
                userCheckbox.indeterminate = false;
                console.log('  -> äººå“¡ç‹€æ…‹: å…¨é¸');
            } else if (checkedCount === 0) {
                // å…¨éƒ¨æœªå‹¾é¸
                userCheckbox.checked = false;
                userCheckbox.indeterminate = false;
                console.log('  -> äººå“¡ç‹€æ…‹: æœªé¸');
            } else {
                // éƒ¨åˆ†å‹¾é¸
                userCheckbox.checked = true; // ä¿æŒå‹¾é¸ç‹€æ…‹
                userCheckbox.indeterminate = true; // ä½†é¡¯ç¤ºç‚ºéƒ¨åˆ†é¸å–
                console.log('  -> äººå“¡ç‹€æ…‹: éƒ¨åˆ†é¸å–');
            }
            
            toggleRowCostExclusion(userCheckbox);
        }

        // åˆ‡æ›è¡Œçš„è¦–è¦ºæ¨£å¼
        function toggleRowCostExclusion(checkbox) {
            const row = checkbox.closest('tr');
            if (checkbox.checked) {
                // å®Œå…¨å‹¾é¸ï¼šç§»é™¤æ’é™¤æ¨£å¼
                row.classList.remove('excluded-from-cost');
            } else if (checkbox.indeterminate) {
                // éƒ¨åˆ†é¸å–ï¼šä¹Ÿç§»é™¤æ’é™¤æ¨£å¼ï¼ˆå› ç‚ºä»æœ‰éƒ¨åˆ†å…§å®¹è¢«è¨ˆå…¥ï¼‰
                row.classList.remove('excluded-from-cost');
            } else {
                // å®Œå…¨æœªå‹¾é¸ï¼šæ·»åŠ æ’é™¤æ¨£å¼
                row.classList.add('excluded-from-cost');
            }
        }

        // === å¿«å–å»ºç½®èˆ‡åˆ·æ–° (è£œä¸Šéºå¤±å®šç¾©) ===
        // === å…¨åŸŸè¨­å®šï¼ˆå¾ HTML å…ƒç´ è®€å–ï¼‰===
        window.__WL_CONFIG__ = window.__WL_CONFIG__ || {};
        
        // å¾ HTML è¨­å®šå€åŸŸè®€å–é…ç½®
        function loadConfigFromHTML() {
            const settingsPanel = document.getElementById('workloadSettings');
            if (!settingsPanel) {
                console.warn('[Config] æ‰¾ä¸åˆ°è¨­å®šé¢æ¿ï¼Œä½¿ç”¨é è¨­å€¼');
                window.__WL_CONFIG__.enableLoadingOverlay = false;
                return;
            }
            
            // è®€å– Loading Overlay è¨­å®šï¼ˆé è¨­ falseï¼‰
            const loadingCheckbox = document.getElementById('enableLoadingOverlay');
            window.__WL_CONFIG__.enableLoadingOverlay = loadingCheckbox ? loadingCheckbox.checked : false;
            
            // è®€å–å…¶ä»–è¨­å®š
            const debugCheckbox = document.getElementById('enableDebugMode');
            window.__WL_CONFIG__.enableDebugMode = debugCheckbox ? debugCheckbox.checked : false;
            
            const progressCheckbox = document.getElementById('enableProgressBar');
            window.__WL_CONFIG__.enableProgressBar = progressCheckbox ? progressCheckbox.checked : true;
        }

        function setLoadingOverlayEnabled(enabled) {
            const loadingCheckbox = document.getElementById('enableLoadingOverlay');
            if (loadingCheckbox) {
                loadingCheckbox.checked = !!enabled;
            }
            window.__WL_CONFIG__.enableLoadingOverlay = !!enabled;
            
            if (!enabled) {
                // é¦¬ä¸Šéš±è—ä¸¦åœæ­¢ç›¸é—œè¼ªè©¢ / è¨ˆæ™‚å™¨
                hideLoading();
                if (window.__WL_USER_POLL_TIMER) { clearInterval(window.__WL_USER_POLL_TIMER); window.__WL_USER_POLL_TIMER = null; }
                if (window.__WL_ROTATE_TIMER) { clearInterval(window.__WL_ROTATE_TIMER); window.__WL_ROTATE_TIMER = null; }
                if (window.__WL_FORCE_HIDE_TIMER) { clearTimeout(window.__WL_FORCE_HIDE_TIMER); window.__WL_FORCE_HIDE_TIMER = null; }
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–è¨­å®šï¼ˆä¿®æ”¹ç‚ºä½¿ç”¨çµ±ä¸€åˆå§‹åŒ–ï¼‰
        (function initConfig() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializePage);
            } else {
                // DOM å·²è¼‰å…¥ï¼Œç›´æ¥åŸ·è¡Œ
                setTimeout(initializePage, 0);
            }
        })();

        // åœ¨é é¢é ‚éƒ¨å·¥å…·åˆ—ï¼ˆè‹¥å­˜åœ¨ï¼‰æ’å…¥ä¸€å€‹åˆ‡æ› UIï¼ˆåªæ’ä¸€æ¬¡ï¼‰
        function injectLoadingToggle(){
            if (document.getElementById('wlLoadingToggle')) return; // å·²æ’å…¥
            const toolbar = document.querySelector('#topToolbar, .top-toolbar, .toolbar, body');
            if (!toolbar) return;
            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'position:fixed;top:6px;right:12px;z-index:2147483647;font-size:12px;background:rgba(0,0,0,0.55);color:#fff;padding:4px 8px;border-radius:6px;backdrop-filter:blur(4px);display:flex;align-items:center;gap:4px;';
            wrapper.innerHTML = '<label style="cursor:pointer;display:flex;align-items:center;gap:4px;margin:0;"><input id="wlLoadingToggle" type="checkbox" style="margin:0;"><span>é¡¯ç¤º Loading</span></label>';
            document.body.appendChild(wrapper);
            const chk = wrapper.querySelector('#wlLoadingToggle');
            if (chk) {
                // åŒæ­¥ HTML è¨­å®šåˆ°æµ®å‹•åˆ‡æ›å™¨
                chk.checked = !!window.__WL_CONFIG__.enableLoadingOverlay;
                chk.addEventListener('change', () => {
                    setLoadingOverlayEnabled(chk.checked);
                    // åŒæ­¥å› HTML è¨­å®šå€åŸŸ
                    loadConfigFromHTML();
                });
            } else {
                console.warn('[LoadingToggle] ç„¡æ³•æ‰¾åˆ° #wlLoadingToggle å…ƒç´ ');
            }
        }

        // Loading æ§åˆ¶å‡½æ•¸ï¼ˆå—è¨­å®šæ§åˆ¶ï¼‰
        function showLoading(text = 'è¨ˆç®—ä¸­...', subtext = 'æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡å·¥æ™‚çµ±è¨ˆ') {
            if (!window.__WL_CONFIG__.enableLoadingOverlay) {
                // è¨­å®šç‚ºé—œé–‰æ™‚ä¸é¡¯ç¤º
                return;
            }
            console.log('[Loading] æº–å‚™é¡¯ç¤º Loading:', text); // æ·»åŠ èª¿è©¦è¨Šæ¯
            
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            
            console.log('[Loading] å…ƒç´ æª¢æŸ¥:', {
                overlay: !!overlay,
                loadingText: !!loadingText,
                loadingSubtext: !!loadingSubtext
            });
            
            if (overlay) {
                if (loadingText) loadingText.textContent = text;
                if (loadingSubtext) loadingSubtext.textContent = subtext;
                
                overlay.style.display = 'flex';
                console.log('[Loading] Loading æ¨£å¼å·²è¨­ç½®ç‚º flex');
                
                // å¼·åˆ¶é‡ç¹ª
                overlay.offsetHeight;
                
                console.log('[Loading] Loading å·²é¡¯ç¤º:', text); // ç¢ºèªé¡¯ç¤º
            } else {
                console.error('[Loading] æ‰¾ä¸åˆ° loadingOverlay å…ƒç´ !');
            }
        }

        function hideLoading() {
            console.log('[Loading] æº–å‚™éš±è— Loading'); // æ·»åŠ èª¿è©¦è¨Šæ¯
            
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                console.log('[Loading] Loading å·²éš±è—'); // ç¢ºèªéš±è—
            } else {
                console.error('[Loading] æ‰¾ä¸åˆ° loadingOverlay å…ƒç´ !');
            }
        }

        // é¡¯ç¤ºå°å‹ Loading æŒ‡ç¤ºå™¨åœ¨ç‰¹å®šå…ƒç´ 
        function showMiniLoading(element) {
            if (!element) return;
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰ mini-loading
            if (element.querySelector('.mini-loading')) return;
            
            const miniLoader = document.createElement('span');
            miniLoader.className = 'mini-loading';
            element.appendChild(miniLoader);
        }

        function hideMiniLoading(element) {
            if (!element) return;
            
            const miniLoader = element.querySelector('.mini-loading');
            if (miniLoader) {
                miniLoader.remove();
            }
        }

        // æ¸¬è©¦åŠŸèƒ½ï¼šLoading æ•ˆæœæ¸¬è©¦
        function testLoading() {
            console.log('=== Loading æ•ˆæœæ¸¬è©¦é–‹å§‹ ===');
            
            // ç›´æ¥æ¸¬è©¦ showLoading å’Œ hideLoading
            showLoading('æ¸¬è©¦æ¨¡å¼', 'æ­£åœ¨æ¸¬è©¦ Loading å‹•ç•«æ•ˆæœ');
            
            setTimeout(() => {
                hideLoading();
                console.log('=== Loading æ•ˆæœæ¸¬è©¦çµæŸ ===');
                alert('Loading æ¸¬è©¦å®Œæˆï¼å¦‚æœæ‚¨çœ‹åˆ°äº† Loading å‹•ç•«ï¼Œèªªæ˜åŠŸèƒ½æ­£å¸¸');
            }, 2000);
        }

        // èª¿è©¦åŠŸèƒ½ï¼šåˆ‡æ›èª¿è©¦æ¨¡å¼
        function toggleDebugMode() {
            const cache = window.__WL_CACHE__;
            if (cache) {
                cache.DEBUG = !cache.DEBUG;
                console.log('èª¿è©¦æ¨¡å¼:', cache.DEBUG ? 'é–‹å•Ÿ' : 'é—œé–‰');
                alert('èª¿è©¦æ¨¡å¼å·²' + (cache.DEBUG ? 'é–‹å•Ÿ' : 'é—œé–‰') + 'ï¼Œè«‹æŸ¥çœ‹ç€è¦½å™¨ Console');
            }
        }
        
        // æ¸¬è©¦åŠŸèƒ½ï¼šéšå±¤å‹¾é¸æ¸¬è©¦
        function testHierarchy() {
            const cache = window.__WL_CACHE__;
            if (!cache) {
                alert('Cache å°šæœªåˆå§‹åŒ–');
                return;
            }
            
            console.log('=== éšå±¤å‹¾é¸èˆ‡æ¯æ—¥å·¥æ™‚æ¸¬è©¦é–‹å§‹ ===');
            
            // æ¸¬è©¦ Loading æ•ˆæœ
            showLoading('æ¸¬è©¦æ¨¡å¼', 'æ­£åœ¨é€²è¡Œéšå±¤å‹¾é¸åŠŸèƒ½æ¸¬è©¦');
            
            setTimeout(() => {
                // æ‰¾åˆ°ç¬¬ä¸€å€‹ç”¨æˆ¶å’Œç¬¬ä¸€å€‹å°ˆæ¡ˆé€²è¡Œæ¸¬è©¦
                const firstUserName = cache.users ? Object.keys(cache.users)[0] : null;
                const firstProjectName = firstUserName && cache.users[firstUserName].projects ? 
                    Object.keys(cache.users[firstUserName].projects)[0] : null;
                
                if (firstUserName) {
                    console.log('æ¸¬è©¦ç”¨æˆ¶:', firstUserName);
                    const userData = cache.users[firstUserName];
                    const userCheckbox = userData.checkbox;
                    
                    if (userCheckbox) {
                        // è¨˜éŒ„æ¸¬è©¦å‰çš„ç‹€æ…‹ï¼ˆä½¿ç”¨å¿«å–ä¸­çš„å·¥ä½œé‡å–®å…ƒæ ¼ï¼‰
                        const beforeUserCells = cache.cellsByUser[firstUserName] || [];
                        console.log('æ¸¬è©¦å‰ç”¨æˆ¶å·¥ä½œé‡å–®å…ƒæ ¼æ•¸é‡:', beforeUserCells.length);
                        beforeUserCells.forEach((cell, idx) => {
                            if (cell.getAttribute('data-issue') === '-1') {
                                console.log(`  ç”¨æˆ¶å·¥ä½œé‡ ${idx}: ${cell.textContent}`);
                            }
                        });
                        
                        console.log('æ‰¾åˆ°ç”¨æˆ¶ checkboxï¼Œç•¶å‰ç‹€æ…‹:', userCheckbox.checked);
                        // åˆ‡æ›ç‹€æ…‹é€²è¡Œæ¸¬è©¦ï¼ˆé€™å°‡è§¸ç™¼ Loadingï¼‰
                        userCheckbox.checked = !userCheckbox.checked;
                        console.log('æ¨¡æ“¬ç”¨æˆ¶å‹¾é¸åˆ‡æ›åˆ°:', userCheckbox.checked);
                        
                        // è§¸ç™¼éšå±¤å‹¾é¸ï¼ˆæœƒè‡ªå‹•é¡¯ç¤º Loadingï¼‰
                        toggleCostCalculation(userCheckbox);
                        
                        // ç­‰å¾…æ›´æ–°å¾Œæª¢æŸ¥çµæœ
                        setTimeout(() => {
                            const afterUserCells = cache.cellsByUser[firstUserName] || [];
                            console.log('æ¸¬è©¦å¾Œç”¨æˆ¶å·¥ä½œé‡å–®å…ƒæ ¼:');
                            afterUserCells.forEach((cell, idx) => {
                                if (cell.getAttribute('data-issue') === '-1') {
                                    console.log(`  ç”¨æˆ¶å·¥ä½œé‡ ${idx}: ${cell.textContent} (æœŸé–“ ${cell.getAttribute('data-period-index')})`);
                                }
                            });
                        }, 500);
                    }
                }
                
                setTimeout(() => {
                    if (firstUserName && firstProjectName) {
                        console.log('æ¸¬è©¦å°ˆæ¡ˆ:', `${firstUserName}/${firstProjectName}`);
                        const projectData = cache.users[firstUserName].projects[firstProjectName];
                        const projectCheckbox = projectData.checkbox;
                        
                        if (projectCheckbox) {
                            // è¨˜éŒ„æ¸¬è©¦å‰çš„ç‹€æ…‹ï¼ˆä½¿ç”¨å¿«å–ä¸­çš„å·¥ä½œé‡å–®å…ƒæ ¼ï¼‰
                            const projectKey = `${firstUserName}|${firstProjectName}`;
                            const beforeProjectCells = cache.cellsByProject[projectKey] || [];
                            console.log('æ¸¬è©¦å‰å°ˆæ¡ˆå·¥ä½œé‡å–®å…ƒæ ¼æ•¸é‡:', beforeProjectCells.length);
                            beforeProjectCells.forEach((cell, idx) => {
                                if (cell.getAttribute('data-issue') === '-2') {
                                    console.log(`  å°ˆæ¡ˆå·¥ä½œé‡ ${idx}: ${cell.textContent}`);
                                }
                            });
                            
                            console.log('æ‰¾åˆ°å°ˆæ¡ˆ checkboxï¼Œç•¶å‰ç‹€æ…‹:', projectCheckbox.checked);
                            // åˆ‡æ›ç‹€æ…‹é€²è¡Œæ¸¬è©¦ï¼ˆé€™å°‡è§¸ç™¼ Loadingï¼‰
                            projectCheckbox.checked = !projectCheckbox.checked;
                            console.log('æ¨¡æ“¬å°ˆæ¡ˆå‹¾é¸åˆ‡æ›åˆ°:', projectCheckbox.checked);
                            
                            // è§¸ç™¼éšå±¤å‹¾é¸ï¼ˆæœƒè‡ªå‹•é¡¯ç¤º Loadingï¼‰
                            toggleCostCalculation(projectCheckbox);
                            
                            // ç­‰å¾…æ›´æ–°å¾Œæª¢æŸ¥çµæœ
                            setTimeout(() => {
                                const afterProjectCells = cache.cellsByProject[projectKey] || [];
                                console.log('æ¸¬è©¦å¾Œå°ˆæ¡ˆå·¥ä½œé‡å–®å…ƒæ ¼:');
                                afterProjectCells.forEach((cell, idx) => {
                                    if (cell.getAttribute('data-issue') === '-2') {
                                        console.log(`  å°ˆæ¡ˆå·¥ä½œé‡ ${idx}: ${cell.textContent} (æœŸé–“ ${cell.getAttribute('data-period-index')})`);
                                    }
                                });
                                
                                console.log('=== éšå±¤å‹¾é¸èˆ‡æ¯æ—¥å·¥æ™‚æ¸¬è©¦çµæŸ ===');
                                alert('æ¸¬è©¦å®Œæˆï¼è«‹æŸ¥çœ‹ç€è¦½å™¨ Console ä¸¦è§€å¯Ÿè¡¨æ ¼ä¸­æ¯æ—¥å·¥æ™‚çš„è®ŠåŒ–ä»¥åŠ Loading æ•ˆæœ');
                            }, 500);
                        }
                    }
                }, 1500);
                
                hideLoading();
            }, 1000);
        }

        /**
         * å»ºç«‹å®Œæ•´çš„å…§å­˜æ¨¡å‹ï¼ˆMemory Modelï¼‰
         * ä¸€æ¬¡æ€§æƒæ DOM ä¸¦å»ºç«‹å¿«å–ï¼Œé¿å…å¾ŒçºŒé‡è¤‡ querySelectorAll
         */
        async function buildWorkloadCache() {
            const t0 = performance.now();
            if (!window.__WL_CACHE__) window.__WL_CACHE__ = { DEBUG: false };
            const cache = window.__WL_CACHE__;
            
            // åˆå§‹åŒ–æ‰€æœ‰å¿«å–çµæ§‹
            cache.issues = [];                          // ISSUE è³‡æ–™é™£åˆ—
            cache.users = Object.create(null);          // äººå“¡ç´¢å¼• {userName: userObj}
            cache.projects = Object.create(null);       // å°ˆæ¡ˆç´¢å¼• {userName|projectName: projectObj}
            cache.userSpans = Object.create(null);      // äººå“¡ç¸½è¨ˆ span
            cache.projectSpans = Object.create(null);   // å°ˆæ¡ˆç¸½è¨ˆ span
            cache.checkboxByKey = Object.create(null);  // checkbox å¿«é€ŸæŸ¥æ‰¾ {user|project|issue: checkbox}
            cache.allCheckboxes = [];                   // æ‰€æœ‰ checkbox
            cache.workloadCells = [];                   // æ‰€æœ‰å·¥ä½œé‡å–®å…ƒæ ¼
            cache.cellsByIssue = Object.create(null);   // æŒ‰ issue çµ„ç¹”çš„ cells {user|project|issue: [cells]}
            cache.cellsByUser = Object.create(null);    // æŒ‰ user çµ„ç¹”çš„ cells {user: [cells]}
            cache.cellsByProject = Object.create(null); // æŒ‰ project çµ„ç¹”çš„ cells {user|project: [cells]}
            cache.issueCheckboxes = Object.create(null); // è­°é¡Œ checkbox å¿«é€ŸæŸ¥æ‰¾ {issueId: checkbox}

            // 1. æƒææ‰€æœ‰ ISSUE checkboxï¼ˆåªæƒæä¸€æ¬¡ï¼‰
            const issueCheckboxes = document.querySelectorAll('tbody input[type="checkbox"][data-issue]:not([data-issue="-1"]):not([data-issue="-2"])');
            console.log(`[buildCache] é–‹å§‹æƒæ ${issueCheckboxes.length} å€‹è­°é¡Œ...`);
            let userCount = 0; // è¿½è¹¤æ–°ä½¿ç”¨è€…æ•¸é‡
            for (const cb of issueCheckboxes) {
                const issueId = cb.getAttribute('data-issue');
                const user = cb.getAttribute('data-user');
                const project = cb.getAttribute('data-project');
                const key = `${user}|${project}|${issueId}`;
                
                // âœ… å»ºç«‹ issueCheckboxes å¿«å–
                cache.issueCheckboxes[issueId] = cb;
                
                // å»ºç«‹ issue ç‰©ä»¶
                const row = cb.closest('tr');
                const issueObj = { 
                    checkbox: cb, 
                    issueId, 
                    user, 
                    project, 
                    periodHours: 0,
                    key,
                    row: row,
                    id: issueId  // åŠ å…¥ id å±¬æ€§ä¾›å…¶ä»–å‡½æ•¸ä½¿ç”¨
                };
                cache.issues.push(issueObj);
                cache.checkboxByKey[key] = cb;
                cache.allCheckboxes.push(cb);
                
                // åˆå§‹åŒ– user ç´¢å¼•ï¼ˆè¼ªè©¢æ©Ÿåˆ¶æœƒè² è²¬æ›´æ–° Loading é¡¯ç¤ºï¼‰
                if (!cache.users[user]) {
                    cache.users[user] = {
                        name: user,
                        issues: [],
                        projects: Object.create(null),
                        checkbox: null,
                        row: null,
                        cells: []
                    };
                }
                cache.users[user].issues.push(issueObj);
                
                // åˆå§‹åŒ– project ç´¢å¼•
                const projectKey = `${user}|${project}`;
                if (!cache.projects[projectKey]) {
                    cache.projects[projectKey] = {
                        user,
                        project,
                        issues: [],
                        checkbox: null,  // ç¨å¾Œå¡«å…¥
                        row: null,  // ç¨å¾Œå¡«å…¥
                        cells: []
                    };
                }
                cache.projects[projectKey].issues.push(issueObj);
                
                // å°‡å°ˆæ¡ˆåŠ å…¥åˆ°ä½¿ç”¨è€…çš„å°ˆæ¡ˆåˆ—è¡¨ä¸­
                if (!cache.users[user].projects[project]) {
                    cache.users[user].projects[project] = cache.projects[projectKey];
                }
            }

            // 2. æƒæäººå“¡å±¤ç´š checkbox
            document.querySelectorAll('input[data-issue="-1"]').forEach(cb => {
                const user = cb.getAttribute('data-user');
                const key = `${user}|-1`;
                cache.checkboxByKey[key] = cb;
                cache.allCheckboxes.push(cb);
                if (cache.users[user]) {
                    cache.users[user].checkbox = cb;
                    // å„²å­˜è©²è¡Œçš„ row å…ƒç´ 
                    const row = cb.closest('tr');
                    if (row) {
                        cache.users[user].row = row;
                    }
                }
            });

            // 3. æƒæå°ˆæ¡ˆå±¤ç´š checkbox
            document.querySelectorAll('input[data-issue="-2"]').forEach(cb => {
                const user = cb.getAttribute('data-user');
                const project = cb.getAttribute('data-project');
                const key = `${user}|${project}|-2`;
                const projectKey = `${user}|${project}`;
                cache.checkboxByKey[key] = cb;
                cache.allCheckboxes.push(cb);
                if (cache.projects[projectKey]) {
                    cache.projects[projectKey].checkbox = cb;
                    // å„²å­˜è©²è¡Œçš„ row å…ƒç´ 
                    const row = cb.closest('tr');
                    if (row) {
                        cache.projects[projectKey].row = row;
                    }
                }
            });

            // 4. æƒæäººå“¡ç¸½è¨ˆ span (ç„¡ data-project)
            document.querySelectorAll('span[data-user][data-original-hours]:not([data-project])')
                .forEach(sp => { 
                    const user = sp.getAttribute('data-user');
                    cache.userSpans[user] = sp; 
                    if (cache.users[user]) {
                        cache.users[user].span = sp;
                    }
                });

            // 5. æƒæå°ˆæ¡ˆç¸½è¨ˆ span
            document.querySelectorAll('span[data-user][data-project][data-original-hours]')
                .forEach(sp => { 
                    const user = sp.getAttribute('data-user');
                    const project = sp.getAttribute('data-project');
                    const key = `${user}|${project}`;
                    cache.projectSpans[key] = sp;
                    if (cache.projects[key]) {
                        cache.projects[key].span = sp;
                    }
                });

            // 6. æƒææ‰€æœ‰å·¥ä½œé‡å–®å…ƒæ ¼ï¼ˆåªæƒæä¸€æ¬¡ï¼‰
            const allWorkloadCells = document.querySelectorAll('td.workload-cell[data-period-index]');
            allWorkloadCells.forEach(cell => {
                const issueId = cell.getAttribute('data-issue');
                const user = cell.getAttribute('data-user');
                const project = cell.getAttribute('data-project');
                const periodIndex = cell.getAttribute('data-period-index');
                const originalWorkload = parseFloat(cell.getAttribute('data-original-workload')) || 0;
                
                const cellObj = {
                    element: cell,
                    issueId,
                    user,
                    project,
                    periodIndex,
                    originalWorkload
                };
                
                cache.workloadCells.push(cellObj);
                
                // æŒ‰ issue çµ„ç¹”
                const issueKey = `${user}|${project}|${issueId}`;
                if (!cache.cellsByIssue[issueKey]) {
                    cache.cellsByIssue[issueKey] = [];
                }
                cache.cellsByIssue[issueKey].push(cellObj);
                // ä¹Ÿç”¨ issueId ç´”éµå­˜ä¸€ä»½ï¼ˆä¾›å¾ŒçºŒè¨ˆç®—å¿«é€Ÿä»¥ issueId ç›´æ¥å–ï¼‰
                if (!cache.cellsByIssue[issueId]) {
                    cache.cellsByIssue[issueId] = [];
                }
                cache.cellsByIssue[issueId].push(cellObj);
                
                // æŒ‰ user çµ„ç¹”ï¼ˆäººå“¡ç¸½è¨ˆè¡Œ issueId="-1"ï¼‰
                if (issueId === '-1') {
                    if (!cache.cellsByUser[user]) {
                        cache.cellsByUser[user] = [];
                    }
                    cache.cellsByUser[user].push(cellObj);
                    if (cache.users[user]) {
                        cache.users[user].cells.push(cellObj);
                    }
                }
                
                // æŒ‰ project çµ„ç¹”ï¼ˆå°ˆæ¡ˆç¸½è¨ˆè¡Œ issueId="-2"ï¼‰
                if (issueId === '-2' && project) {
                    const projectKey = `${user}|${project}`;
                    if (!cache.cellsByProject[projectKey]) {
                        cache.cellsByProject[projectKey] = [];
                    }
                    cache.cellsByProject[projectKey].push(cellObj);
                    if (cache.projects[projectKey]) {
                        cache.projects[projectKey].cells.push(cellObj);
                    }
                }
            });

            if (cache.DEBUG) {
                console.log('[Cache] å…§å­˜æ¨¡å‹å»ºç«‹å®Œæˆ:', {
                    'buildTime(ms)': (performance.now() - t0).toFixed(2),
                    'issues': cache.issues.length,
                    'users': Object.keys(cache.users).length,
                    'projects': Object.keys(cache.projects).length,
                    'allCheckboxes': cache.allCheckboxes.length,
                    'workloadCells': cache.workloadCells.length
                });
            }
        }

        // è¨­ç½® DOM è®ŠåŒ–ç›£è½å™¨ï¼Œç›£æ§æ–°å¢çš„äººå“¡
        function setupDOMChangeObserver() {
            const targetNode = document.querySelector('tbody'); // ç›£è½ table body
            if (!targetNode) {
                console.warn('[DOM] æ‰¾ä¸åˆ° tbodyï¼Œç„¡æ³•è¨­ç½®ç›£è½å™¨');
                return;
            }

            const observer = new MutationObserver(function(mutations) {
                let hasNewUsers = false;
                let latestUser = null;
                
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                // æª¢æŸ¥æ–°å¢çš„ç¯€é»æ˜¯å¦åŒ…å« issue-title æˆ–äººå“¡è³‡è¨Š
                                const issueTitles = node.querySelectorAll ? node.querySelectorAll('.issue-title') : [];
                                const userCells = node.querySelectorAll ? node.querySelectorAll('[data-user]') : [];
                                
                                if (issueTitles.length > 0 || userCells.length > 0 || node.matches?.('.issue-title') || node.matches?.('[data-user]')) {
                                    hasNewUsers = true;
                                    // å–å¾—ä½¿ç”¨è€…åç¨±
                                    if (node.matches?.('[data-user]')) {
                                        latestUser = node.getAttribute('data-user');
                                    } else if (userCells.length > 0) {
                                        latestUser = userCells[userCells.length - 1].getAttribute('data-user');
                                    } else if (issueTitles.length > 0) {
                                        // å¾ issue-title å…ƒç´ å˜—è©¦å–å¾—ä½¿ç”¨è€…åç¨±
                                        const titleText = issueTitles[0].textContent || '';
                                        const match = titleText.match(/(\S+)/); // å–ç¬¬ä¸€å€‹éç©ºç™½å­—ç¬¦åºåˆ—ä½œç‚ºä½¿ç”¨è€…å
                                        if (match) latestUser = match[1];
                                    }
                                    console.log('[DOM] æª¢æ¸¬åˆ°æ–°å¢ä½¿ç”¨è€…ç›¸é—œå…ƒç´ :', latestUser || 'æœªçŸ¥');
                                }
                            }
                        });
                    }
                });
                
                // å¦‚æœæª¢æ¸¬åˆ°æ–°ä½¿ç”¨è€…ï¼Œæ›´æ–° LOADING é¡¯ç¤º
                if (hasNewUsers && latestUser) {
                    try {
                        const subEl = document.getElementById('loadingSubtext');
                        if (subEl && /æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡å·¥æ™‚çµ±è¨ˆ/.test(subEl.textContent)) {
                            subEl.textContent = subEl.textContent.replace(/(æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡å·¥æ™‚çµ±è¨ˆ)( - .*)?$/, `$1 - ${latestUser}`);
                            console.log('[DOM] æ›´æ–° LOADING è‡³ä½¿ç”¨è€…:', latestUser);
                        }
                    } catch(e) {
                        console.warn('[DOM] æ›´æ–° LOADING éŒ¯èª¤:', e);
                    }
                }
            });

            // é–‹å§‹ç›£è½
            observer.observe(targetNode, {
                childList: true,
                subtree: true
            });
            
            console.log('[DOM] å·²è¨­ç½® TABLE è®ŠåŒ–ç›£è½å™¨');
        }

        // è¼ªè©¢æ–¹å¼è£œå¼·ï¼šå®šæœŸæª¢æŸ¥æ–°å‡ºç¾çš„ä½¿ç”¨è€… / issue-title
        let __WL_USER_POLL_TIMER = null;
        let __WL_USER_POLL_LAST_COUNT = 0;
        let __WL_USER_POLL_LAST_NAME = '';
        let __WL_USER_POLL_START_TS = 0;
        function startIncrementalUserLoadingUpdates(){
            if (__WL_USER_POLL_TIMER) return; // å·²å•Ÿå‹•
            __WL_USER_POLL_LAST_COUNT = 0;
            __WL_USER_POLL_LAST_NAME = '';
            __WL_USER_POLL_START_TS = Date.now();
            __WL_USER_POLL_TIMER = setInterval(()=>{
                try {
                    const subEl = document.getElementById('loadingSubtext');
                    if (!subEl) return;
                    // åªåœ¨ä»æ˜¯åˆå§‹åŒ–è¨Šæ¯éšæ®µæ™‚è™•ç†
                    if (!/æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡å·¥æ™‚çµ±è¨ˆ/.test(subEl.textContent)) {
                        // ç•¶ loading é€²å…¥ä¸‹ä¸€éšæ®µæ™‚è‡ªå‹•åœæ­¢è¼ªè©¢
                        clearInterval(__WL_USER_POLL_TIMER); __WL_USER_POLL_TIMER = null; return;
                    }
                    // è¶…é 15 ç§’ä»æœªé€²å…¥ä¸‹ä¸€éšæ®µå‰‡åœæ­¢ï¼ˆé˜²æ­¢ç„¡é™è¼ªè©¢ï¼‰
                    if (Date.now() - __WL_USER_POLL_START_TS > 15000) {
                        clearInterval(__WL_USER_POLL_TIMER); __WL_USER_POLL_TIMER = null; return;
                    }
                    const cache = window.__WL_CACHE__;
                    // å„ªå…ˆä½¿ç”¨å¿«å–ä¸­çš„ users
                    let userNames = [];
                    if (cache && cache.users) {
                        userNames = Object.keys(cache.users);
                    }
                    // è‹¥ç„¡æ³•å¾å¿«å–å¾—åˆ°ï¼Œå¾ DOM æŠ“å– .issue-title æˆ– data-user
                    if (userNames.length === 0) {
                        const domUsers = new Set();
                        document.querySelectorAll('[data-user]').forEach(el=>{ const u = el.getAttribute('data-user'); if (u) domUsers.add(u); });
                        document.querySelectorAll('.issue-title').forEach(el=>{ const txt = el.textContent.trim(); if (txt) domUsers.add(txt.split(/\s|\(|ï¼ˆ/)[0]); });
                        userNames = Array.from(domUsers);
                    }
                    if (userNames.length === 0) return; // å°šæœªè§£æå‡ºä½¿ç”¨è€…
                    const latest = userNames[userNames.length-1];
                    // åªæœ‰åœ¨äººæ•¸æˆ–æœ€å¾Œä¸€ä½ä¸åŒæ™‚æ‰æ›´æ–° DOM
                    if (userNames.length !== __WL_USER_POLL_LAST_COUNT || latest !== __WL_USER_POLL_LAST_NAME) {
                        subEl.textContent = `æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡å·¥æ™‚çµ±è¨ˆ - ${latest} (${userNames.length})`;
                        __WL_USER_POLL_LAST_COUNT = userNames.length;
                        __WL_USER_POLL_LAST_NAME = latest;
                        if (cache && cache.DEBUG) console.log('[Loading-Poll] æœ€æ–°ä½¿ç”¨è€…:', latest, 'äººæ•¸=', __WL_USER_POLL_LAST_COUNT);
                    }
                } catch(e) { /* å¿½ç•¥è¼ªè©¢éŒ¯èª¤ */ }
            }, 120); // 120ms ä¸€æ¬¡ï¼Œå…¼é¡§å³æ™‚èˆ‡æ€§èƒ½
        }

        function refreshIssuePeriodHours() {
            if (!window.__WL_CACHE__) {
                console.warn('refreshIssuePeriodHours: Cache ä¸å­˜åœ¨');
                return;
            }
            const cache = window.__WL_CACHE__;
            const t0 = performance.now();
            let updatedCount = 0;
            let totalHours = 0;
            
            cache.issues.forEach(item => {
                let h = parseFloat(item.checkbox.getAttribute('data-hours'));
                // è‹¥å·²å®Œæˆåˆæ¬¡æ­£å¼è¨ˆç®—ä¸” data-hours æœ‰å€¼ï¼Œç›´æ¥ä½¿ç”¨é¿å…é‡è¤‡é‡ç®—
                if (cache.periodHoursReady && !isNaN(h)) {
                    // ä½¿ç”¨æ—¢æœ‰ h
                } else if (isNaN(h) || h === 0) {
                    // fallback: ä½¿ç”¨å¿«å–ä¸­çš„ cellsByIssue
                    h = 0;
                    const cells = cache.cellsByIssue[item.issueId];
                    if (cells) {
                        cells.forEach(cellObj => {
                            // cellObj ä¾†è‡ª buildWorkloadCache çš„ {element, originalWorkload,...}
                            const workload = typeof cellObj.originalWorkload === 'number' ? cellObj.originalWorkload : (cellObj.element ? (parseFloat(cellObj.element.getAttribute('data-original-workload')) || 0) : 0);
                            if (!isNaN(workload)) h += workload;
                        });
                    }
                    if (!isNaN(h)) item.checkbox.setAttribute('data-hours', h.toFixed(1));
                }
                item.periodHours = h;
                if (h > 0) {
                    updatedCount++;
                    totalHours += h;
                }
                
                // æ›´æ–° DOM ä¸­çš„å€é–“å·¥æ™‚é¡¯ç¤º
                const periodHoursSpan = document.getElementById(`period-hours-${item.issueId}`);
                if (periodHoursSpan) {
                    periodHoursSpan.textContent = `å€é–“: ${h.toFixed(1)} å°æ™‚`;
                } else {
                    // èª¿è©¦ä¿¡æ¯ï¼šæ‰¾ä¸åˆ°å°æ‡‰çš„spanå…ƒç´ 
                    if (cache.DEBUG) console.warn(`æ‰¾ä¸åˆ° period-hours-${item.issueId} å…ƒç´ `);
                }
            });
            
            console.log(`refreshIssuePeriodHours: ${updatedCount}/${cache.issues.length} å€‹è­°é¡Œæœ‰å·¥æ™‚, ç¸½è¨ˆ ${totalHours.toFixed(1)} hrs`);
            if (cache.DEBUG) console.log('[Perf] refreshIssuePeriodHours ms=', (performance.now() - t0).toFixed(2));
        }

        // æ›´æ–°æˆæœ¬çµ±è¨ˆ - ç´”å‰ç«¯è¨ˆç®—ï¼ˆç•°æ­¥ç‰ˆæœ¬ï¼‰
        async function updateCostStatisticsAsync() {
            const t0 = performance.now();
            if (!window.__WL_CACHE__) {
                console.warn('updateCostStatisticsAsync: Cache ä¸å­˜åœ¨ï¼Œå»ºç«‹å¿«å–');
                await buildWorkloadCache();
            }
            const cache = window.__WL_CACHE__;
            // åƒ…åœ¨æœªå®Œæˆåˆæ¬¡è¨ˆç®—æ™‚åˆ·æ–°
            if (!cache.periodHoursReady) {
                refreshIssuePeriodHours();
            }
            
            let includedHours = 0, excludedHours = 0, totalHours = 0;
            let includedItems = 0, totalItems = 0;

            console.log(`æˆæœ¬çµ±è¨ˆè¨ˆç®—: æª¢æŸ¥ ${cache.issues.length} å€‹è­°é¡Œ`);

            // èª¿è©¦ï¼šæª¢æŸ¥å‰å¹¾å€‹è­°é¡Œçš„ periodHours
            let debugCount = 0;
            for (const issue of cache.issues) {
                if (debugCount < 3) {
                    console.log(`  è­°é¡Œ ${issue.issueId}: periodHours=${issue.periodHours}, data-hours=${issue.checkbox.getAttribute('data-hours')}`);
                    debugCount++;
                }
                
                const hours = issue.periodHours;
                const issueIdNum = parseInt(issue.issueId);
                if (issueIdNum > 0 && hours > 0) {
                    totalHours += hours; totalItems++;
                    // å³æ™‚è®€å– checkbox.checked ç‹€æ…‹ï¼ˆä¸ä¾è³´å¿«å–çš„å‹¾é¸ç‹€æ…‹ï¼‰
                    if (issue.checkbox.checked) { includedHours += hours; includedItems++; }
                    else excludedHours += hours;
                }
            }

            console.log(`æˆæœ¬çµ±è¨ˆçµæœ: ç´å…¥=${includedHours.toFixed(1)}hrs, æ’é™¤=${excludedHours.toFixed(1)}hrs, ç¸½è¨ˆ=${totalHours.toFixed(1)}hrs, é …ç›®=${includedItems}/${totalItems}`);

            const includedElement = document.getElementById('includedHours');
            const excludedElement = document.getElementById('excludedHours');
            const totalElement = document.getElementById('totalHours');
            const itemsElement = document.getElementById('includedItems');
            
            // æ›´æ–°æˆæœ¬çµ±è¨ˆé¡¯ç¤ºï¼ˆæ·»åŠ æ›´æ–°é–ƒçˆæ•ˆæœä½œç‚ºè¦–è¦ºåé¥‹ï¼‰
            if (includedElement) {
                includedElement.textContent = includedHours.toFixed(1) + ' hrs';
                includedElement.style.transition = 'color 0.3s';
                includedElement.style.color = '#2196F3';
                setTimeout(() => { includedElement.style.color = ''; }, 300);
            }
            if (excludedElement) excludedElement.textContent = excludedHours.toFixed(1) + ' hrs';
            if (totalElement) totalElement.textContent = totalHours.toFixed(1) + ' hrs';
            if (itemsElement) itemsElement.textContent = includedItems + ' / ' + totalItems;
            if (cache.DEBUG) console.log('[Perf] updateCostStatisticsAsync ms=', (performance.now()-t0).toFixed(2));
        }

        // æ›´æ–°æˆæœ¬çµ±è¨ˆ - ç´”å‰ç«¯è¨ˆç®—
        let __WL_RECALC_TIMER = null;
        let __WL_RECALC_RUNNING = false;
        let __WL_LOADING_SHOWN = false; // è¿½è¹¤ Loading æ˜¯å¦å·²é¡¯ç¤º
        
        function scheduleCostAndSummaryRecalc(reason='toggle', immediate=false){
            if (window.__WL_CACHE__ && window.__WL_CACHE__.DEBUG) console.log('[Sched] æ’ç¨‹é‡ç®— reason=', reason, 'immediate=', immediate);
            if (__WL_RECALC_TIMER) clearTimeout(__WL_RECALC_TIMER);
            
            // æ ¹æ“šæ“ä½œé¡å‹å‹•æ…‹èª¿æ•´å»¶é²ï¼šå–®ä¸€ toggle ç”¨ 100msï¼Œæ‰¹æ¬¡æ“ä½œç”¨ 200ms
            const delay = immediate ? 0 : (reason === 'toggle' ? 100 : 200);
            
            // ç¸½æ˜¯é¡¯ç¤º Loadingï¼ˆé™¤äº† immediate æ¨¡å¼ï¼‰
            const shouldShowLoading = !immediate;
            
            __WL_RECALC_TIMER = setTimeout(async ()=>{
                if (__WL_RECALC_RUNNING) { // è‹¥ä»åœ¨è·‘ï¼Œå»¶å¾Œå†è©¦
                    if (window.__WL_CACHE__ && window.__WL_CACHE__.DEBUG) console.log('[Sched] é‡ç®—ä»åœ¨åŸ·è¡Œï¼Œé‡æ–°æ’ç¨‹');
                    scheduleCostAndSummaryRecalc('rerun');
                    return;
                }
                __WL_RECALC_RUNNING = true;
                
                try {
                    // é¡¯ç¤º Loadingï¼ˆæ ¹æ“šæ“ä½œé¡å‹èª¿æ•´æç¤ºæ–‡å­—ï¼‰
                    if (shouldShowLoading) {
                        let loadingText = 'è¨ˆç®—ä¸­...';
                        let loadingSubtext = 'æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡å·¥æ™‚çµ±è¨ˆ';
                        
                        if (reason === 'selectAll') {
                            loadingText = 'æ‰¹æ¬¡è™•ç†ä¸­...';
                            loadingSubtext = 'æ­£åœ¨æ›´æ–°æ‰€æœ‰é …ç›®çš„æˆæœ¬èˆ‡å·¥æ™‚';
                        } else if (reason === 'batch') {
                            loadingText = 'æ‰¹æ¬¡è¨ˆç®—ä¸­...';
                            loadingSubtext = 'æ­£åœ¨è™•ç†å¤šå€‹é …ç›®çš„æˆæœ¬çµ±è¨ˆ';
                        } else if (reason === 'toggle') {
                            loadingText = 'æ›´æ–°ä¸­...';
                            loadingSubtext = 'æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡æ¯æ—¥å·¥æ™‚';
                        }
                        
                        // åªåœ¨ Loading æœªé¡¯ç¤ºæ™‚æ‰é¡¯ç¤ºï¼ˆtoggle æ“ä½œå·²ç¶“é¡¯ç¤ºäº†ï¼‰
                        if (!__WL_LOADING_SHOWN) {
                            showLoading(loadingText, loadingSubtext);
                            // åˆæ¬¡é¡¯ç¤ºå¾Œç«‹å³åŠ ä¸Šç¬¬ä¸€ä½ä½¿ç”¨è€…åç¨±
                            try {
                                const cache = window.__WL_CACHE__;
                                if (cache && cache.users) {
                                    const firstUser = Object.keys(cache.users)[0];
                                    if (firstUser) {
                                        const subEl = document.getElementById('loadingSubtext');
                                        if (subEl && /æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡å·¥æ™‚çµ±è¨ˆ|æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡æ¯æ—¥å·¥æ™‚|æ­£åœ¨æ›´æ–°æ¯æ—¥å·¥æ™‚åˆ†ä½ˆ/.test(subEl.textContent)) {
                                            subEl.textContent = subEl.textContent + ' - ' + firstUser;
                                        }
                                    }
                                }
                            } catch(e) { /* å¿½ç•¥é¦–æ¬¡é™„åŠ éŒ¯èª¤ */ }
                        }
                        __WL_LOADING_SHOWN = true;
                    }
                    
                    // åœ¨é¡¯ç¤ºæœŸé–“å‹•æ…‹è¼ªæ’­ä½¿ç”¨è€…åç¨±ï¼ˆæå‡é«”é©—ï¼‰
                    const startUserRotation = () => {
                        try {
                            const cache = window.__WL_CACHE__;
                            const subEl = document.getElementById('loadingSubtext');
                            if (!cache || !cache.users || !subEl) return;
                            const userNames = Object.keys(cache.users);
                            if (userNames.length === 0) return;
                            let idx = 0;
                            if (window.__WL_ROTATE_TIMER) { clearInterval(window.__WL_ROTATE_TIMER); }
                            window.__WL_ROTATE_TIMER = setInterval(()=>{
                                if (!subEl) return;
                                const name = userNames[idx % userNames.length];
                                subEl.textContent = subEl.textContent.replace(/(æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡æ¯æ—¥å·¥æ™‚|æ­£åœ¨æ›´æ–°æ¯æ—¥å·¥æ™‚åˆ†ä½ˆ|æ­£åœ¨é‡æ–°è¨ˆç®—æˆæœ¬èˆ‡å·¥æ™‚çµ±è¨ˆ|æ­£åœ¨è™•ç†å¤šå€‹é …ç›®çš„æˆæœ¬çµ±è¨ˆ|æ­£åœ¨æ›´æ–°æ‰€æœ‰é …ç›®çš„æˆæœ¬èˆ‡å·¥æ™‚|æ­£åœ¨æ›´æ–°ç›¸é—œåœ–è¡¨).*/, `$1 - ${name}`);
                                idx++;
                            }, 800);
                        } catch(e) { /* å¿½ç•¥è¼ªæ’­éŒ¯èª¤ */ }
                    };
                    if (shouldShowLoading) startUserRotation();

                    // å¼·åˆ¶ä¿éšªï¼š8 ç§’å¾Œè‡ªå‹•éš±è— (é¿å…ç•°å¸¸å¡ä½)
                    if (window.__WL_FORCE_HIDE_TIMER) clearTimeout(window.__WL_FORCE_HIDE_TIMER);
                    window.__WL_FORCE_HIDE_TIMER = setTimeout(()=>{
                        try {
                            if (window.__WL_ROTATE_TIMER) { clearInterval(window.__WL_ROTATE_TIMER); window.__WL_ROTATE_TIMER = null; }
                            hideLoading();
                            __WL_LOADING_SHOWN = false;
                            console.warn('[Loading] å¼·åˆ¶è¶…æ™‚éš±è—');
                        } catch(e){}
                    }, 8000);

                    // ç¬¬1æ­¥ï¼šæ›´æ–°æˆæœ¬çµ±è¨ˆ
                    await updateCostStatisticsAsync();
                    
                    // ç¬¬2æ­¥ï¼šæ›´æ–°ç¸½è¨ˆè¡Œå·¥æ™‚çµ±è¨ˆï¼ˆä½†ä¸åŒ…å«æ¯æ—¥å·¥æ™‚ï¼‰
                    await updateSummaryRowsHoursAsyncOnly(); 
                    
                    // ç¬¬3æ­¥ï¼šæ›´æ–°æ¯æ—¥å·¥æ™‚ï¼ˆå„ªå…ˆåŸ·è¡Œï¼‰
                    if (shouldShowLoading) {
                        showLoading('æ›´æ–°ä¸­...', 'æ­£åœ¨æ›´æ–°æ¯æ—¥å·¥æ™‚åˆ†ä½ˆ');
                    }
                    await updateWorkloadCellsAsync();
                    
                    // ç¬¬4æ­¥ï¼šæœ€å¾Œæ›´æ–°åœ–è¡¨
                    if (shouldShowLoading) {
                        showLoading('å®Œæˆä¸­...', 'æ­£åœ¨æ›´æ–°ç›¸é—œåœ–è¡¨');
                    }
                    if (typeof updateCharts === 'function') {
                        await new Promise(resolve => {
                            requestAnimationFrame(()=> { 
                                try { 
                                    updateCharts(); 
                                    resolve();
                                } catch(e){ 
                                    console.warn('updateCharts error', e);
                                    resolve();
                                } 
                            });
                        });
                    }
                } finally {
                    __WL_RECALC_RUNNING = false;
                    
                    // éš±è— Loading
                    if (shouldShowLoading) {
                        // ç¢ºä¿ Loading è‡³å°‘é¡¯ç¤º 300msï¼Œæä¾›è‰¯å¥½çš„è¦–è¦ºå›é¥‹
                        setTimeout(() => {
                            if (window.__WL_ROTATE_TIMER) { clearInterval(window.__WL_ROTATE_TIMER); window.__WL_ROTATE_TIMER = null; }
                            if (window.__WL_FORCE_HIDE_TIMER) { clearTimeout(window.__WL_FORCE_HIDE_TIMER); window.__WL_FORCE_HIDE_TIMER = null; }
                            hideLoading();
                            __WL_LOADING_SHOWN = false; // é‡ç½®æ¨™è¨˜
                        }, Math.max(0, 300));
                    }
                }
            }, delay);
        }
        function updateCostStatistics(immediate=false) { scheduleCostAndSummaryRecalc('manual', immediate); }

        // åƒ…æ›´æ–°å°ˆæ¡ˆå’Œäººå“¡ç¸½è¨ˆè¡Œçš„å·¥æ™‚é¡¯ç¤ºï¼ˆä¸åŒ…å«æ¯æ—¥å·¥æ™‚æ›´æ–°ï¼‰
        async function updateSummaryRowsHoursAsyncOnly() {
            const t0 = performance.now();
            if (!window.__WL_CACHE__) {
                await buildWorkloadCache();
                refreshIssuePeriodHours(); // ç¢ºä¿ periodHours å·²è¨ˆç®—
            }
            const cache = window.__WL_CACHE__;
            const userAgg = Object.create(null);
            const projectAgg = Object.create(null);

            // å–®æ¬¡è¿´åœˆèšåˆ (ä½¿ç”¨å¿«å–çš„ issues é™£åˆ—ï¼Œé¿å…é‡æ–° querySelectorAll)
            for (const issue of cache.issues) {
                const hours = issue.periodHours; // å·²é å…ˆè¨ˆç®—çš„å€é–“å·¥æ™‚
                if (hours <= 0) continue;
                const user = issue.user;
                const project = issue.project;
                const key = user + '|' + project;
                // å³æ™‚è®€å– checkbox.checked ç‹€æ…‹ï¼ˆç¢ºä¿ç²å–æœ€æ–°å‹¾é¸ç‹€æ…‹ï¼‰
                const checked = issue.checkbox.checked;

                let ua = userAgg[user];
                if (!ua) userAgg[user] = ua = {total:0, included:0, excluded:0, totalCount:0, includedCount:0};
                let pa = projectAgg[key];
                if (!pa) projectAgg[key] = pa = {total:0, included:0, excluded:0, totalCount:0, includedCount:0};

                ua.total += hours; ua.totalCount++;
                pa.total += hours; pa.totalCount++;
                if (checked) { ua.included += hours; ua.includedCount++; pa.included += hours; pa.includedCount++; }
                else { ua.excluded += hours; pa.excluded += hours; }
            }

            // æ‰¹æ¬¡æ›´æ–°æ–‡å­— (æœ€å°‘é‡æ’)
            for (const user in userAgg) {
                const span = cache.userSpans[user];
                if (!span) continue;
                const d = userAgg[user];
                let txt;
                if (d.includedCount === d.totalCount) txt = `ç¸½å·¥æ™‚: ${d.included.toFixed(1)} å°æ™‚`;
                else if (d.includedCount === 0) txt = `ç¸½å·¥æ™‚: 0.0 å°æ™‚ (æ’é™¤ ${d.excluded.toFixed(1)} å°æ™‚)`;
                else txt = `ç¸½å·¥æ™‚: ${d.included.toFixed(1)} å°æ™‚ (æ’é™¤ ${d.excluded.toFixed(1)} å°æ™‚)`;
                span.textContent = txt;
            }
            for (const key in projectAgg) {
                const span = cache.projectSpans[key];
                if (!span) continue;
                const d = projectAgg[key];
                let txt;
                if (d.includedCount === d.totalCount) txt = `ç¸½å·¥æ™‚: ${d.included.toFixed(1)} å°æ™‚`;
                else if (d.includedCount === 0) txt = `ç¸½å·¥æ™‚: 0.0 å°æ™‚ (æ’é™¤ ${d.excluded.toFixed(1)} å°æ™‚)`;
                else txt = `ç¸½å·¥æ™‚: ${d.included.toFixed(1)} å°æ™‚ (æ’é™¤ ${d.excluded.toFixed(1)} å°æ™‚)`;
                span.textContent = txt;
            }

            if (cache.DEBUG) console.log('[Perf] updateSummaryRowsHoursAsyncOnly ms=', (performance.now()-t0).toFixed(2));
        }

        // æ›´æ–°å°ˆæ¡ˆå’Œäººå“¡ç¸½è¨ˆè¡Œçš„å·¥æ™‚é¡¯ç¤ºï¼ˆç•°æ­¥ç‰ˆæœ¬ï¼‰
        async function updateSummaryRowsHoursAsync() {
            const t0 = performance.now();
            if (!window.__WL_CACHE__) {
                await buildWorkloadCache();
                refreshIssuePeriodHours(); // ç¢ºä¿ periodHours å·²è¨ˆç®—
            }
            const cache = window.__WL_CACHE__;
            const userAgg = Object.create(null);
            const projectAgg = Object.create(null);

            // å–®æ¬¡è¿´åœˆèšåˆ (ä½¿ç”¨å¿«å–çš„ issues é™£åˆ—ï¼Œé¿å…é‡æ–° querySelectorAll)
            for (const issue of cache.issues) {
                const hours = issue.periodHours; // å·²é å…ˆè¨ˆç®—çš„å€é–“å·¥æ™‚
                if (hours <= 0) continue;
                const user = issue.user;
                const project = issue.project;
                const key = user + '|' + project;
                // å³æ™‚è®€å– checkbox.checked ç‹€æ…‹ï¼ˆç¢ºä¿ç²å–æœ€æ–°å‹¾é¸ç‹€æ…‹ï¼‰
                const checked = issue.checkbox.checked;

                let ua = userAgg[user];
                if (!ua) userAgg[user] = ua = {total:0, included:0, excluded:0, totalCount:0, includedCount:0};
                let pa = projectAgg[key];
                if (!pa) projectAgg[key] = pa = {total:0, included:0, excluded:0, totalCount:0, includedCount:0};

                ua.total += hours; ua.totalCount++;
                pa.total += hours; pa.totalCount++;
                if (checked) { ua.included += hours; ua.includedCount++; pa.included += hours; pa.includedCount++; }
                else { ua.excluded += hours; pa.excluded += hours; }
            }

            // æ‰¹æ¬¡æ›´æ–°æ–‡å­— (æœ€å°‘é‡æ’)
            for (const user in userAgg) {
                const span = cache.userSpans[user];
                if (!span) continue;
                const d = userAgg[user];
                let txt;
                if (d.includedCount === d.totalCount) txt = `ç¸½å·¥æ™‚: ${d.included.toFixed(1)} å°æ™‚`;
                else if (d.includedCount === 0) txt = `ç¸½å·¥æ™‚: 0.0 å°æ™‚ (æ’é™¤ ${d.excluded.toFixed(1)} å°æ™‚)`;
                else txt = `ç¸½å·¥æ™‚: ${d.included.toFixed(1)} å°æ™‚ (æ’é™¤ ${d.excluded.toFixed(1)} å°æ™‚)`;
                span.textContent = txt;
            }
            for (const key in projectAgg) {
                const span = cache.projectSpans[key];
                if (!span) continue;
                const d = projectAgg[key];
                let txt;
                if (d.includedCount === d.totalCount) txt = `ç¸½å·¥æ™‚: ${d.included.toFixed(1)} å°æ™‚`;
                else if (d.includedCount === 0) txt = `ç¸½å·¥æ™‚: 0.0 å°æ™‚ (æ’é™¤ ${d.excluded.toFixed(1)} å°æ™‚)`;
                else txt = `ç¸½å·¥æ™‚: ${d.included.toFixed(1)} å°æ™‚ (æ’é™¤ ${d.excluded.toFixed(1)} å°æ™‚)`;
                span.textContent = txt;
            }

            if (cache.DEBUG) console.log('[Perf] updateSummaryRowsHoursAsync ms=', (performance.now()-t0).toFixed(2));
            await updateWorkloadCellsAsync();
        }

        // æ›´æ–°å°ˆæ¡ˆå’Œäººå“¡ç¸½è¨ˆè¡Œçš„å·¥æ™‚é¡¯ç¤º
        function updateSummaryRowsHours() {
            console.log('=== updateSummaryRowsHours é–‹å§‹ ===');
            
            const cache = window.__WL_CACHE__;
            if (!cache || !cache.issues) {
                console.warn('[updateSummaryRowsHours] å¿«å–æœªå°±ç·’ï¼Œç„¡æ³•æ›´æ–°ç¸½è¨ˆè¡Œ');
                return;
            }
            
            // 1. æ”¶é›†æ¯å€‹äººå“¡çš„å·¥æ™‚æ•¸æ“š
            const userHours = {};
            
            // 2. æ”¶é›†æ¯å€‹å°ˆæ¡ˆçš„å·¥æ™‚æ•¸æ“š
            const projectHours = {};
            
            // ä½¿ç”¨å¿«å–çš„ issues é™£åˆ—
            cache.issues.forEach(issue => {
                const userName = issue.user;
                const projectName = issue.project;
                const issueId = issue.id;
                const hours = issue.periodHours || 0; // ä½¿ç”¨é å…ˆè¨ˆç®—çš„å€é–“å·¥æ™‚
                const isChecked = issue.checkbox.checked;
                
                if (issueId && parseInt(issueId) > 0 && hours > 0) {
                    // åˆå§‹åŒ–äººå“¡æ•¸æ“š
                    if (!userHours[userName]) {
                        userHours[userName] = { total: 0, included: 0, excluded: 0, totalCount: 0, includedCount: 0 };
                    }
                    
                    // åˆå§‹åŒ–å°ˆæ¡ˆæ•¸æ“š
                    const projectKey = `${userName}|${projectName}`;
                    if (!projectHours[projectKey]) {
                        projectHours[projectKey] = { total: 0, included: 0, excluded: 0, totalCount: 0, includedCount: 0 };
                    }
                    
                    // ç´¯è¨ˆå·¥æ™‚
                    userHours[userName].total += hours;
                    userHours[userName].totalCount++;
                    projectHours[projectKey].total += hours;
                    projectHours[projectKey].totalCount++;
                    
                    if (isChecked) {
                        userHours[userName].included += hours;
                        userHours[userName].includedCount++;
                        projectHours[projectKey].included += hours;
                        projectHours[projectKey].includedCount++;
                    } else {
                        userHours[userName].excluded += hours;
                        projectHours[projectKey].excluded += hours;
                    }
                }
            });
            
            console.log('äººå“¡å·¥æ™‚çµ±è¨ˆ:', userHours);
            console.log('å°ˆæ¡ˆå·¥æ™‚çµ±è¨ˆ:', projectHours);
            
            // 3. æ›´æ–°äººå“¡ç¸½è¨ˆè¡Œçš„é¡¯ç¤º
            for (const userName in userHours) {
                const data = userHours[userName];
                const userSpan = document.querySelector(`span[data-user="${userName}"][data-original-hours]:not([data-project])`);
                
                if (userSpan) {
                    const originalHours = parseFloat(userSpan.getAttribute('data-original-hours')) || 0;
                    let displayText;
                    
                    if (data.includedCount === data.totalCount) {
                        // å…¨é¸
                        displayText = `ç¸½å·¥æ™‚: ${data.included.toFixed(1)} å°æ™‚`;
                    } else if (data.includedCount === 0) {
                        // å…¨ä¸é¸
                        displayText = `ç¸½å·¥æ™‚: 0.0 å°æ™‚ (æ’é™¤ ${data.excluded.toFixed(1)} å°æ™‚)`;
                    } else {
                        // éƒ¨åˆ†é¸å–
                        displayText = `ç¸½å·¥æ™‚: ${data.included.toFixed(1)} å°æ™‚ (æ’é™¤ ${data.excluded.toFixed(1)} å°æ™‚)`;
                    }
                    
                    console.log(`æ›´æ–°äººå“¡ ${userName}: ${userSpan.textContent} -> ${displayText}`);
                    userSpan.textContent = displayText;
                }
            }
            
            // 4. æ›´æ–°å°ˆæ¡ˆç¸½è¨ˆè¡Œçš„é¡¯ç¤º
            for (const projectKey in projectHours) {
                const [userName, projectName] = projectKey.split('|');
                const data = projectHours[projectKey];
                const projectSpan = document.querySelector(`span[data-user="${userName}"][data-project="${projectName}"][data-original-hours]`);
                
                if (projectSpan) {
                    const originalHours = parseFloat(projectSpan.getAttribute('data-original-hours')) || 0;
                    let displayText;
                    
                    if (data.includedCount === data.totalCount) {
                        // å…¨é¸
                        displayText = `ç¸½å·¥æ™‚: ${data.included.toFixed(1)} å°æ™‚`;
                    } else if (data.includedCount === 0) {
                        // å…¨ä¸é¸
                        displayText = `ç¸½å·¥æ™‚: 0.0 å°æ™‚ (æ’é™¤ ${data.excluded.toFixed(1)} å°æ™‚)`;
                    } else {
                        // éƒ¨åˆ†é¸å–
                        displayText = `ç¸½å·¥æ™‚: ${data.included.toFixed(1)} å°æ™‚ (æ’é™¤ ${data.excluded.toFixed(1)} å°æ™‚)`;
                    }
                    
                    projectSpan.textContent = displayText;
                }
            }
            
            console.log('=== updateSummaryRowsHours å®Œæˆ ===');
            
            // åŒæ™‚æ›´æ–°æ¯æ—¥/æ¯é€±/æ¯æœˆçš„å·¥ä½œé‡é¡¯ç¤º
            updateWorkloadCells();
        }

        // æ›´æ–°æ¯æ—¥/æ¯é€±/æ¯æœˆå·¥ä½œé‡å–®å…ƒæ ¼ï¼ˆç•°æ­¥ç‰ˆæœ¬ - ä½¿ç”¨å…§å­˜å¿«å–å„ªåŒ–ï¼‰
        async function updateWorkloadCellsAsync() {
            const t0 = performance.now();
            const cache = window.__WL_CACHE__;
            
            if (!cache || !cache.workloadCells) {
                console.warn('[updateWorkloadCellsAsync] å¿«å–æœªå°±ç·’ï¼Œé‡å»ºå¿«å–');
                await buildWorkloadCache();
            }
            
            if (cache.DEBUG) console.log('[Cache] updateWorkloadCellsAsync é–‹å§‹ï¼Œä½¿ç”¨å¿«å–çš„', cache.workloadCells.length, 'å€‹å–®å…ƒæ ¼');
            
            // æŒ‰äººå“¡å’Œå°ˆæ¡ˆçµ„ç¹”æ•¸æ“šçµæ§‹
            const userPeriodData = Object.create(null);      // äººå“¡å±¤ç´šçš„æ™‚é–“æ®µæ•¸æ“š
            const projectPeriodData = Object.create(null);   // å°ˆæ¡ˆå±¤ç´šçš„æ™‚é–“æ®µæ•¸æ“š
            
            // ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨å¿«å–æ”¶é›†æ‰€æœ‰ ISSUE çš„æ™‚é–“æ®µæ•¸æ“šï¼ˆç„¡ DOM æŸ¥è©¢ï¼‰
            const cellsToUpdate = []; // è¨˜éŒ„éœ€è¦æ›´æ–°çš„å–®å…ƒæ ¼
            
            for (const cellObj of cache.workloadCells) {
                const issueIdNum = parseInt(cellObj.issueId);
                
                // åªè™•ç†å¯¦éš› ISSUE (issueId > 0)
                if (issueIdNum > 0) {
                    const userName = cellObj.user;
                    const projectName = cellObj.project;
                    const periodIndex = cellObj.periodIndex;
                    const workload = cellObj.originalWorkload;
                    
                    if (workload > 0) {
                        // âœ… ä½¿ç”¨å¿«å–çš„ checkboxByKey å–ä»£ querySelectorï¼ˆé—œéµå„ªåŒ–ï¼ï¼‰
                        const key = `${userName}|${projectName}|${cellObj.issueId}`;
                        const checkbox = cache.checkboxByKey[key];
                        
                        if (checkbox) {
                            const isChecked = checkbox.checked;
                            
                            // åªç´¯è¨ˆå·²å‹¾é¸çš„ ISSUE å·¥ä½œé‡
                            if (isChecked) {
                                // åˆå§‹åŒ–äººå“¡æ™‚é–“æ®µæ•¸æ“š
                                if (!userPeriodData[userName]) {
                                    userPeriodData[userName] = Object.create(null);
                                }
                                if (!userPeriodData[userName][periodIndex]) {
                                    userPeriodData[userName][periodIndex] = 0;
                                }
                                userPeriodData[userName][periodIndex] += workload;
                                
                                // åˆå§‹åŒ–å°ˆæ¡ˆæ™‚é–“æ®µæ•¸æ“š
                                const projectKey = `${userName}|${projectName}`;
                                if (!projectPeriodData[projectKey]) {
                                    projectPeriodData[projectKey] = Object.create(null);
                                }
                                if (!projectPeriodData[projectKey][periodIndex]) {
                                    projectPeriodData[projectKey][periodIndex] = 0;
                                }
                                projectPeriodData[projectKey][periodIndex] += workload;
                            }
                        }
                    }
                }
            }
            
            if (cache.DEBUG) {
                console.log('[Cache] æ•¸æ“šæ”¶é›†å®Œæˆï¼Œè€—æ™‚:', (performance.now() - t0).toFixed(2), 'ms');
                console.log('[Cache] äººå“¡æ™‚é–“æ®µæ•¸é‡:', Object.keys(userPeriodData).length);
                console.log('[Cache] å°ˆæ¡ˆæ™‚é–“æ®µæ•¸é‡:', Object.keys(projectPeriodData).length);
            }
            
            // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨å¿«å–æ›´æ–°äººå“¡ç¸½è¨ˆè¡Œçš„å·¥ä½œé‡å–®å…ƒæ ¼
            const t1 = performance.now();
            let userCellsUpdated = 0;
            
            for (const userName in cache.cellsByUser) {
                const userCells = cache.cellsByUser[userName];
                const periodData = userPeriodData[userName] || {};
                
                for (const cellObj of userCells) {
                    // åªè™•ç†äººå“¡ç¸½è¨ˆè¡Œ (issueId === '-1')
                    if (cellObj.issueId === '-1') {
                        const periodIndex = cellObj.periodIndex;
                        const newWorkload = periodData[periodIndex] || 0;
                        const cell = cellObj.element;
                        const currentWorkload = parseFloat(cell.textContent) || 0;
                        
                        if (Math.abs(currentWorkload - newWorkload) > 0.01) {
                            cell.textContent = newWorkload.toFixed(1);
                            updateWorkloadCellStyle(cell, newWorkload);
                            
                            // ä½¿ç”¨ CSS class å„ªåŒ–å‹•ç•«æ€§èƒ½
                            cell.classList.add('cell-updated');
                            setTimeout(() => {
                                cell.classList.remove('cell-updated');
                            }, 300);
                            
                            userCellsUpdated++;
                        }
                    }
                }
            }
            
            if (cache.DEBUG) {
                console.log('[Cache] äººå“¡ç¸½è¨ˆæ›´æ–°å®Œæˆï¼Œæ›´æ–°', userCellsUpdated, 'å€‹å–®å…ƒæ ¼ï¼Œè€—æ™‚:', (performance.now() - t1).toFixed(2), 'ms');
            }
            
            // ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨å¿«å–æ›´æ–°å°ˆæ¡ˆç¸½è¨ˆè¡Œçš„å·¥ä½œé‡å–®å…ƒæ ¼
            const t2 = performance.now();
            let projectCellsUpdated = 0;
            
            for (const projectKey in cache.cellsByProject) {
                const projectCells = cache.cellsByProject[projectKey];
                const periodData = projectPeriodData[projectKey] || {};
                
                for (const cellObj of projectCells) {
                    // åªè™•ç†å°ˆæ¡ˆç¸½è¨ˆè¡Œ (issueId === '-2')
                    if (cellObj.issueId === '-2') {
                        const periodIndex = cellObj.periodIndex;
                        const newWorkload = periodData[periodIndex] || 0;
                        const cell = cellObj.element;
                        const currentWorkload = parseFloat(cell.textContent) || 0;
                        
                        if (Math.abs(currentWorkload - newWorkload) > 0.01) {
                            cell.textContent = newWorkload.toFixed(1);
                            updateWorkloadCellStyle(cell, newWorkload);
                            
                            // ä½¿ç”¨ CSS class å„ªåŒ–å‹•ç•«æ€§èƒ½
                            cell.classList.add('cell-updated');
                            setTimeout(() => {
                                cell.classList.remove('cell-updated');
                            }, 300);
                            
                            projectCellsUpdated++;
                        }
                    }
                }
            }
            
            if (cache.DEBUG) {
                console.log('[Cache] å°ˆæ¡ˆç¸½è¨ˆæ›´æ–°å®Œæˆï¼Œæ›´æ–°', projectCellsUpdated, 'å€‹å–®å…ƒæ ¼ï¼Œè€—æ™‚:', (performance.now() - t2).toFixed(2), 'ms');
                console.log('[Cache] updateWorkloadCellsAsync ç¸½è€—æ™‚:', (performance.now() - t0).toFixed(2), 'ms');
            }
        }

        // æ›´æ–°æ¯æ—¥/æ¯é€±/æ¯æœˆå·¥ä½œé‡å–®å…ƒæ ¼
        function updateWorkloadCells() {
            console.log('=== updateWorkloadCells é–‹å§‹ ===');
            
            // ç²å–æ‰€æœ‰å·¥ä½œé‡å–®å…ƒæ ¼
            const allWorkloadCells = document.querySelectorAll('td.workload-cell[data-period-index]');
            console.log('æ‰¾åˆ°å·¥ä½œé‡å–®å…ƒæ ¼æ•¸é‡:', allWorkloadCells.length);
            
            // æŒ‰äººå“¡å’Œå°ˆæ¡ˆçµ„ç¹”æ•¸æ“šçµæ§‹
            const userPeriodData = {};      // äººå“¡å±¤ç´šçš„æ™‚é–“æ®µæ•¸æ“š
            const projectPeriodData = {};   // å°ˆæ¡ˆå±¤ç´šçš„æ™‚é–“æ®µæ•¸æ“š
            
            // ç¬¬ä¸€æ­¥ï¼šæ”¶é›†æ‰€æœ‰ ISSUE çš„æ™‚é–“æ®µæ•¸æ“š
            allWorkloadCells.forEach(cell => {
                const issueId = cell.getAttribute('data-issue');
                const issueIdNum = parseInt(issueId);
                
                // åªè™•ç†å¯¦éš› ISSUE (issueId > 0)
                if (issueIdNum > 0) {
                    const userName = cell.getAttribute('data-user');
                    const projectName = cell.getAttribute('data-project');
                    const periodIndex = cell.getAttribute('data-period-index');
                    const workload = parseFloat(cell.getAttribute('data-original-workload')) || 0;
                    
                    // æ‰¾åˆ°å°æ‡‰çš„ checkbox
                    const checkbox = document.querySelector(
                        `input[data-user="${userName}"][data-project="${projectName}"][data-issue="${issueId}"]`
                    );
                    
                    if (checkbox && workload > 0) {
                        const isChecked = checkbox.checked;
                        
                        // åˆå§‹åŒ–äººå“¡æ™‚é–“æ®µæ•¸æ“š
                        const userKey = userName;
                        if (!userPeriodData[userKey]) {
                            userPeriodData[userKey] = {};
                        }
                        if (!userPeriodData[userKey][periodIndex]) {
                            userPeriodData[userKey][periodIndex] = 0;
                        }
                        
                        // åˆå§‹åŒ–å°ˆæ¡ˆæ™‚é–“æ®µæ•¸æ“š
                        const projectKey = `${userName}|${projectName}`;
                        if (!projectPeriodData[projectKey]) {
                            projectPeriodData[projectKey] = {};
                        }
                        if (!projectPeriodData[projectKey][periodIndex]) {
                            projectPeriodData[projectKey][periodIndex] = 0;
                        }
                        
                        // åªç´¯è¨ˆå·²å‹¾é¸çš„ ISSUE å·¥ä½œé‡
                        if (isChecked) {
                            userPeriodData[userKey][periodIndex] += workload;
                            projectPeriodData[projectKey][periodIndex] += workload;
                        }
                    }
                }
            });
            
            console.log('äººå“¡æ™‚é–“æ®µæ•¸æ“š:', userPeriodData);
            console.log('å°ˆæ¡ˆæ™‚é–“æ®µæ•¸æ“š:', projectPeriodData);
            
            // ç¬¬äºŒæ­¥ï¼šæ›´æ–°äººå“¡ç¸½è¨ˆè¡Œçš„å·¥ä½œé‡å–®å…ƒæ ¼
            for (const userName in userPeriodData) {
                const periodData = userPeriodData[userName];
                
                for (const periodIndex in periodData) {
                    const workload = periodData[periodIndex];
                    const cell = document.querySelector(
                        `td.workload-cell[data-user="${userName}"][data-issue="-1"][data-period-index="${periodIndex}"]`
                    );
                    
                    if (cell) {
                        const newValue = workload.toFixed(1);
                        
                        // æ›´æ–°æ–‡å­—å…§å®¹
                        cell.textContent = newValue;
                        
                        // æ›´æ–°æ¨£å¼é¡åˆ¥
                        updateWorkloadCellStyle(cell, workload);
                    }
                }
            }
            
            // ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°å°ˆæ¡ˆç¸½è¨ˆè¡Œçš„å·¥ä½œé‡å–®å…ƒæ ¼
            for (const projectKey in projectPeriodData) {
                const [userName, projectName] = projectKey.split('|');
                const periodData = projectPeriodData[projectKey];
                
                for (const periodIndex in periodData) {
                    const workload = periodData[periodIndex];
                    const cell = document.querySelector(
                        `td.workload-cell[data-user="${userName}"][data-project="${projectName}"][data-issue="-2"][data-period-index="${periodIndex}"]`
                    );
                    
                    if (cell) {
                        const newValue = workload.toFixed(1);
                        
                        // æ›´æ–°æ–‡å­—å…§å®¹
                        cell.textContent = newValue;
                        
                        // æ›´æ–°æ¨£å¼é¡åˆ¥
                        updateWorkloadCellStyle(cell, workload);
                    }
                }
            }
            
            console.log('=== updateWorkloadCells å®Œæˆ ===');
        }

        // æ›´æ–°å·¥ä½œé‡å–®å…ƒæ ¼çš„æ¨£å¼é¡åˆ¥
        function updateWorkloadCellStyle(cell, workload) {
            // ç§»é™¤èˆŠçš„æ¨£å¼é¡åˆ¥
            cell.classList.remove('workload-zero', 'workload-normal', 'workload-medium', 'workload-high', 'workload-overdue');
            
            // æ ¹æ“šå·¥ä½œé‡æ·»åŠ æ–°çš„æ¨£å¼é¡åˆ¥
            if (workload === 0) {
                cell.classList.add('workload-zero');
            } else if (workload >= 8.0) {
                cell.classList.add('workload-high');
            } else if (workload > 5.0) {
                cell.classList.add('workload-medium');
            } else {
                cell.classList.add('workload-normal');
            }
            
            // ä¿ç•™é€±æœ«å’Œé€¾æœŸæ¨£å¼ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            const isWeekend = cell.getAttribute('data-weekend') === 'true';
            const isOverdue = cell.getAttribute('data-overdue') === 'true';
            
            if (isWeekend) {
                cell.classList.add('weekend');
            }
            if (isOverdue && workload > 0) {
                cell.classList.add('workload-overdue');
            }
        }

        // å…¨é¸/å…¨ä¸é¸åŠŸèƒ½ï¼ˆå„ªåŒ–ç‰ˆï¼šç«‹å³å›æ‡‰ UI + Loading æ•ˆæœï¼‰
        function toggleSelectAll(selectAllCheckbox) {
            const cache = window.__WL_CACHE__;
            if (!cache || !cache.allCheckboxes) {
                console.warn('[toggleSelectAll] å¿«å–æœªå°±ç·’ï¼Œç„¡æ³•å…¨é¸/å…¨ä¸é¸');
                return;
            }
            
            const allCheckboxes = cache.allCheckboxes;
            const newState = selectAllCheckbox.checked;
            
            // å¦‚æœé …ç›®æ•¸é‡å¾ˆå¤šï¼Œä½¿ç”¨ selectAll ç†ç”±è§¸ç™¼é©ç•¶çš„ Loading
            const reason = allCheckboxes.length > 100 ? 'selectAll' : 'batch';
            
            // æ‰¹é‡åŒæ­¥æ›´æ–°æ‰€æœ‰ checkbox ç‹€æ…‹ï¼ˆç«‹å³è¦–è¦ºåé¥‹ï¼‰
            allCheckboxes.forEach(checkbox => {
                if (checkbox.checked !== newState) {
                    checkbox.checked = newState;
                    toggleRowCostExclusion(checkbox);
                }
            });
            
            // æ’ç¨‹é‡ç®—ï¼ˆæ ¹æ“šé …ç›®æ•¸é‡é¸æ“‡é©ç•¶çš„ç†ç”±ï¼‰
            scheduleCostAndSummaryRecalc(reason);
        }

        // æ›´æ–°å…¨é¸æŒ‰éˆ•çš„ç‹€æ…‹
        function updateSelectAllState() {
            const selectAllCheckbox = document.getElementById('selectAll');
            if (!selectAllCheckbox) return;
            
            const cache = window.__WL_CACHE__;
            if (!cache || !cache.allCheckboxes) {
                console.warn('[updateSelectAllState] å¿«å–æœªå°±ç·’ï¼Œç„¡æ³•æ›´æ–°å…¨é¸ç‹€æ…‹');
                return;
            }
            
            const allCheckboxes = cache.allCheckboxes;
            let checkedCount = 0;
            
            allCheckboxes.forEach(cb => {
                if (cb.checked) checkedCount++;
            });
            
            if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        // åˆå§‹åŒ–æˆæœ¬è¨ˆç®—çµ±è¨ˆ
        function initializeCostCalculation() {
            console.log('æˆæœ¬è¨ˆç®—åˆå§‹åŒ–...');
            // ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚ç«‹å³è¨ˆç®—åˆå§‹çµ±è¨ˆ
            updateCostStatistics(true); // immediate=true
            console.log('æˆæœ¬è¨ˆç®—åˆå§‹åŒ–å®Œæˆ');
        }

        // æ¸¬è©¦å‡½æ•¸ - å¯åœ¨ç€è¦½å™¨æ§åˆ¶å°å‘¼å«ä¾†æ¸¬è©¦
        function testCostCalculation() {
            console.log('=== æ¸¬è©¦æˆæœ¬è¨ˆç®—åŠŸèƒ½ ===');
            const cache = window.__WL_CACHE__;
            if (!cache || !cache.allCheckboxes) {
                console.warn('å¿«å–æœªå°±ç·’ï¼Œç„¡æ³•æ¸¬è©¦');
                return;
            }
            
            console.log('æ‰¾åˆ° checkbox æ•¸é‡:', cache.allCheckboxes.length);
            
            cache.allCheckboxes.forEach((checkbox, index) => {
                console.log(`Checkbox ${index}:`, {
                    issue: checkbox.getAttribute('data-issue'),
                    hours: checkbox.getAttribute('data-hours'),
                    checked: checkbox.checked
                });
            });
            
            console.log('é‡æ–°è¨ˆç®—çµ±è¨ˆ...');
            updateCostStatistics();
        }

        // è¨ˆç®—å€é–“å·¥æ™‚ä¸¦æ›´æ–° data-hours å±¬æ€§ï¼ˆç•°æ­¥ç‰ˆæœ¬ï¼‰- âœ… å„ªåŒ–ï¼šä½¿ç”¨å¿«å–
        async function calculatePeriodHoursAsync() {
            console.log('=== é–‹å§‹è¨ˆç®—å€é–“å·¥æ™‚ï¼ˆä½¿ç”¨å¿«å–ï¼‰ ===');
            
            const cache = window.__WL_CACHE__;
            const issueHours = {}; // å„²å­˜æ¯å€‹è­°é¡Œçš„å€é–“å·¥æ™‚
            const userAgg = Object.create(null);
            const projectAgg = Object.create(null);
            const tStart = performance.now();
            const totalIssues = cache && cache.issues ? cache.issues.length : 0;
            const loadingSub = document.getElementById('loadingSubtext');
            const progressBar = document.getElementById('progressBar');
            
            if (cache && cache.issues && cache.cellsByIssue) {
                // âœ… ä½¿ç”¨å¿«å–ï¼šç›´æ¥å¾ cache.issues éæ­·
                console.log(`ä½¿ç”¨å¿«å–è™•ç† ${cache.issues.length} å€‹è­°é¡Œ`);
                
                let processed = 0;
                for (const issue of cache.issues) {
                    const issueId = issue.issueId;
                    if (!issueHours[issueId]) issueHours[issueId] = 0;
                    const cells = cache.cellsByIssue[issueId] || [];
                    let sum = 0;
                    for (const cellObj of cells) {
                        const workload = typeof cellObj.originalWorkload === 'number' ? cellObj.originalWorkload : (cellObj.element ? (parseFloat(cellObj.element.getAttribute('data-original-workload')) || 0) : 0);
                        if (!isNaN(workload)) sum += workload;
                    }
                    issueHours[issueId] = sum;
                    // èšåˆä½¿ç”¨è€…/å°ˆæ¡ˆ
                    const userName = issue.user;
                    const projectName = issue.project;
                    if (!userAgg[userName]) userAgg[userName] = 0;
                    if (!projectAgg[userName+'|'+projectName]) projectAgg[userName+'|'+projectName] = 0;
                    userAgg[userName] += sum;
                    projectAgg[userName+'|'+projectName] += sum;

                    // å‹•æ…‹æ›´æ–° Loading é¡¯ç¤ºï¼šç›®å‰è™•ç†åˆ°å“ªå€‹ä½¿ç”¨è€…
                    processed++;
                    if (loadingSub && processed % 50 === 0) { // æ¯ 50 ç­†åˆ·æ–°ä¸€æ¬¡é¿å…éåº¦é‡æ’
                        const percent = ((processed / totalIssues) * 100).toFixed(1);
                        // åªæ›´æ–°é€²åº¦ç™¾åˆ†æ¯”ï¼Œé™„åŠ åˆ°ç¾æœ‰æ–‡å­—å¾Œé¢ï¼ˆä¿ç•™ buildWorkloadCache è¨­å®šçš„ä½¿ç”¨è€…åç¨±ï¼‰
                        const baseText = loadingSub.textContent.replace(/ \(\d+\/\d+\)$/, ''); // ç§»é™¤èˆŠçš„é€²åº¦
                        loadingSub.textContent = `${baseText} (${processed}/${totalIssues})`;
                        if (progressBar) progressBar.style.width = percent + '%';
                        // é‡‹æ”¾ä¸»åŸ·è¡Œç·’ï¼Œé¿å…å¡é “
                        await new Promise(r => requestAnimationFrame(r));
                    }
                }
            } else {
                // å›é€€æ–¹æ¡ˆï¼šä½¿ç”¨ DOM æŸ¥è©¢ï¼ˆè¼ƒæ…¢ï¼‰
                console.warn('å¿«å–æœªæº–å‚™å¥½ï¼Œä½¿ç”¨ DOM æŸ¥è©¢ï¼ˆè¼ƒæ…¢ï¼‰');
                const allWorkloadCells = document.querySelectorAll('td.workload-cell[data-period-index]');
                console.log(`é–‹å§‹è™•ç† ${allWorkloadCells.length} å€‹å·¥ä½œé‡å–®å…ƒæ ¼`);
                
                allWorkloadCells.forEach(cell => {
                    const issueId = cell.getAttribute('data-issue');
                    const issueIdNum = parseInt(issueId);
                    
                    // åªè™•ç†å¯¦éš›è­°é¡Œ (issueId > 0)
                    if (issueIdNum > 0) {
                        const workload = parseFloat(cell.getAttribute('data-original-workload')) || 0;
                        
                        if (!issueHours[issueId]) {
                            issueHours[issueId] = 0;
                        }
                        issueHours[issueId] += workload;
                    }
                });
            }
            
            console.log(`è­°é¡Œå€é–“å·¥æ™‚: ${Object.keys(issueHours).length} å€‹è­°é¡Œå·²è¨ˆç®—`);
            
            // è¨ˆç®—ç¸½å·¥æ™‚
            let totalCalculatedHours = 0;
            Object.values(issueHours).forEach(h => totalCalculatedHours += h);
            console.log(`è­°é¡Œç¸½å·¥æ™‚: ${totalCalculatedHours.toFixed(1)} hrs`);
            
            // âœ… å„ªåŒ–ï¼šæ›´æ–°æ¯å€‹è­°é¡Œçš„ data-hours å±¬æ€§ï¼ˆä½¿ç”¨å¿«å–ï¼‰
            const issueIds = Object.keys(issueHours);
            
            if (cache && cache.issueCheckboxes) {
                // ä½¿ç”¨å¿«å–æ›´æ–°ï¼ˆå¿«é€Ÿï¼‰
                let updatedCount = 0;
                issueIds.forEach(issueId => {
                    const periodHours = issueHours[issueId];
                    const checkbox = cache.issueCheckboxes[issueId];
                    
                    if (checkbox) {
                        checkbox.setAttribute('data-hours', periodHours.toFixed(1));
                        updatedCount++;
                    }
                    
                    // æ›´æ–°è­°é¡Œè©³ç´°é¡¯ç¤º
                    const periodHoursSpan = document.getElementById(`period-hours-${issueId}`);
                    if (periodHoursSpan) {
                        periodHoursSpan.textContent = `å€é–“: ${periodHours.toFixed(1)} å°æ™‚`;
                    }
                });
                console.log(`å·²æ›´æ–° ${updatedCount} å€‹è­°é¡Œçš„ data-hours å±¬æ€§`);
            } else {
                // å›é€€æ–¹æ¡ˆï¼šDOM æŸ¥è©¢ï¼ˆè¼ƒæ…¢ï¼‰
                console.warn('å¿«å–ä¸­æ²’æœ‰ issueCheckboxesï¼Œä½¿ç”¨ DOM æŸ¥è©¢');
                issueIds.forEach(issueId => {
                    const periodHours = issueHours[issueId];
                    const checkbox = document.querySelector(`input[data-issue="${issueId}"]`);
                    
                    if (checkbox) {
                        checkbox.setAttribute('data-hours', periodHours.toFixed(1));
                    }
                    
                    // æ›´æ–°è­°é¡Œè©³ç´°é¡¯ç¤º
                    const periodHoursSpan = document.getElementById(`period-hours-${issueId}`);
                    if (periodHoursSpan) {
                        periodHoursSpan.textContent = `å€é–“: ${periodHours.toFixed(1)} å°æ™‚`;
                    }
                });
            }
            
            // ç›´æ¥æ›´æ–°äººå“¡å’Œå°ˆæ¡ˆ checkbox data-hoursï¼ˆé¿å…å¾ŒçºŒå†æƒï¼‰
            for (const userName in userAgg) {
                const total = userAgg[userName];
                const userObj = cache.users[userName];
                if (userObj && userObj.checkbox) userObj.checkbox.setAttribute('data-hours', total.toFixed(1));
                if (userObj && userObj.span) userObj.span.setAttribute('data-original-hours', total.toFixed(1));
            }
            for (const key in projectAgg) {
                const total = projectAgg[key];
                const projectObj = cache.projects[key];
                if (projectObj && projectObj.checkbox) projectObj.checkbox.setAttribute('data-hours', total.toFixed(1));
                if (projectObj && projectObj.span) projectObj.span.setAttribute('data-original-hours', total.toFixed(1));
            }
            cache.periodHoursReady = true;
            if (cache.DEBUG) console.log('[Perf] calculatePeriodHoursAsync ms=', (performance.now()-tStart).toFixed(2));
        }

        // è¨ˆç®—å–®å€‹è­°é¡Œåœ¨ç•¶å‰è¨­å®šå€é–“å…§çš„å¯¦éš›å·¥æ™‚
        function calculateIssueActualPeriodHours(issueId) {
            if (!issueId || parseInt(issueId) <= 0) {
                return 0;
            }
            
            // ç²å–è©²è­°é¡Œåœ¨ç•¶å‰é¡¯ç¤ºå€é–“å…§çš„æ‰€æœ‰å·¥ä½œé‡å–®å…ƒæ ¼
            const issueCells = document.querySelectorAll(`td.workload-cell[data-issue="${issueId}"][data-period-index]`);
            let totalHours = 0;
            
            issueCells.forEach(cell => {
                const workload = parseFloat(cell.getAttribute('data-original-workload')) || 0;
                totalHours += workload;
            });
            
            return totalHours;
        }

        // è¨ˆç®—å€é–“å·¥æ™‚ä¸¦æ›´æ–° data-hours å±¬æ€§
        function calculatePeriodHours() {
            console.log('=== é–‹å§‹è¨ˆç®—å€é–“å·¥æ™‚ ===');
            
            // ç²å–æ‰€æœ‰å·¥ä½œé‡å–®å…ƒæ ¼
            const allWorkloadCells = document.querySelectorAll('td.workload-cell[data-period-index]');
            const issueHours = {}; // å„²å­˜æ¯å€‹è­°é¡Œçš„å€é–“å·¥æ™‚
            
            // è¨ˆç®—æ¯å€‹è­°é¡Œçš„å€é–“å·¥æ™‚
            allWorkloadCells.forEach(cell => {
                const issueId = cell.getAttribute('data-issue');
                const issueIdNum = parseInt(issueId);
                
                // åªè™•ç†å¯¦éš›è­°é¡Œ (issueId > 0)
                if (issueIdNum > 0) {
                    const workload = parseFloat(cell.getAttribute('data-original-workload')) || 0;
                    
                    if (!issueHours[issueId]) {
                        issueHours[issueId] = 0;
                    }
                    issueHours[issueId] += workload;
                }
            });
            
            console.log(`è­°é¡Œå€é–“å·¥æ™‚: ${Object.keys(issueHours).length} å€‹è­°é¡Œå·²è¨ˆç®—`);
            
            // æ›´æ–°æ¯å€‹è­°é¡Œçš„ data-hours å±¬æ€§
            Object.keys(issueHours).forEach(issueId => {
                const periodHours = issueHours[issueId];
                const checkbox = document.querySelector(`input[data-issue="${issueId}"]`);
                
                if (checkbox) {
                    checkbox.setAttribute('data-hours', periodHours.toFixed(1));
                }
                
                // æ›´æ–°è­°é¡Œè©³ç´°é¡¯ç¤º
                const periodHoursSpan = document.getElementById(`period-hours-${issueId}`);
                if (periodHoursSpan) {
                    periodHoursSpan.textContent = `å€é–“: ${periodHours.toFixed(1)} å°æ™‚`;
                }
            });
            
            // è¨ˆç®—ä¸¦æ›´æ–°äººå“¡å’Œå°ˆæ¡ˆçš„å€é–“å·¥æ™‚
            updateUserAndProjectPeriodHours(issueHours);
        }

        // æ›´æ–°äººå“¡å’Œå°ˆæ¡ˆçš„å€é–“å·¥æ™‚
        function updateUserAndProjectPeriodHours(issueHours) {
            const userHours = {};
            const projectHours = {};
            
            // æ”¶é›†æ¯å€‹è­°é¡Œçš„äººå“¡å’Œå°ˆæ¡ˆè³‡è¨Š
            Object.keys(issueHours).forEach(issueId => {
                const checkbox = document.querySelector(`input[data-issue="${issueId}"]`);
                if (checkbox) {
                    const userName = checkbox.getAttribute('data-user');
                    const projectName = checkbox.getAttribute('data-project');
                    const hours = issueHours[issueId];
                    
                    // ç´¯è¨ˆäººå“¡å·¥æ™‚
                    if (!userHours[userName]) {
                        userHours[userName] = 0;
                    }
                    userHours[userName] += hours;
                    
                    // ç´¯è¨ˆå°ˆæ¡ˆå·¥æ™‚
                    const projectKey = `${userName}|${projectName}`;
                    if (!projectHours[projectKey]) {
                        projectHours[projectKey] = 0;
                    }
                    projectHours[projectKey] += hours;
                }
            });
            
            // æ›´æ–°äººå“¡ç¸½è¨ˆè¡Œçš„ data-hours
            Object.keys(userHours).forEach(userName => {
                const userCheckbox = document.querySelector(`input[data-user="${userName}"][data-issue="-1"]`);
                if (userCheckbox) {
                    userCheckbox.setAttribute('data-hours', userHours[userName].toFixed(1));
                }
                
                // æ›´æ–°äººå“¡ç¸½è¨ˆè¡Œé¡¯ç¤ºçš„ data-original-hours
                const userSpan = document.querySelector(`span[data-user="${userName}"][data-original-hours]:not([data-project])`);
                if (userSpan) {
                    userSpan.setAttribute('data-original-hours', userHours[userName].toFixed(1));
                }
            });
            
            // æ›´æ–°å°ˆæ¡ˆç¸½è¨ˆè¡Œçš„ data-hours
            Object.keys(projectHours).forEach(projectKey => {
                const [userName, projectName] = projectKey.split('|');
                const projectCheckbox = document.querySelector(`input[data-user="${userName}"][data-project="${projectName}"][data-issue="-2"]`);
                if (projectCheckbox) {
                    projectCheckbox.setAttribute('data-hours', projectHours[projectKey].toFixed(1));
                }
                
                // æ›´æ–°å°ˆæ¡ˆç¸½è¨ˆè¡Œé¡¯ç¤ºçš„ data-original-hours
                const projectSpan = document.querySelector(`span[data-user="${userName}"][data-project="${projectName}"][data-original-hours]`);
                if (projectSpan) {
                    projectSpan.setAttribute('data-original-hours', projectHours[projectKey].toFixed(1));
                }
            });
        }

        // === åœ–è¡¨ç›¸é—œåŠŸèƒ½ ===
        
        // âš¡ æ€§èƒ½å„ªåŒ–ï¼šå…¨å±€ç¦ç”¨ Chart.js å‹•ç•«ï¼ˆç¯€çœ 4+ ç§’ï¼‰
        if (typeof Chart !== 'undefined') {
            Chart.defaults.animation = false;
            Chart.defaults.animations = false;
            Chart.defaults.transitions = false;
            console.log('[Chart] å‹•ç•«å·²å…¨å±€ç¦ç”¨ï¼ˆæ€§èƒ½å„ªåŒ–ï¼‰');
        }
        
        let userHoursChart = null;
        let projectHoursChart = null;
        let workloadTrendChart = null;
        let workloadHeatmapChart = null;

        // åˆå§‹åŒ–æ‰€æœ‰åœ–è¡¨ï¼ˆæ”¹ç‚ºç•°æ­¥ä»¥ç¢ºä¿å®Œæˆå¾Œæ‰éš±è— Loadingï¼‰
        async function initializeCharts() {
            const t0 = performance.now();
            console.log('=== åˆå§‹åŒ–åœ–è¡¨ ===');
            
            // ç¢ºä¿æœ‰æ•¸æ“šæ‰åˆå§‹åŒ–åœ–è¡¨
            const hasData = document.querySelector('tbody tr[data-level="0"]');
            if (!hasData) {
                console.log('æ²’æœ‰æ•¸æ“šï¼Œè·³éåœ–è¡¨åˆå§‹åŒ–');
                return;
            }
            
            try {
                // åŒæ­¥å‰µå»ºæ‰€æœ‰åœ–è¡¨
                const results = [
                    createUserHoursChart(),
                    createProjectHoursChart(),
                    createWorkloadTrendChart(),
                    createWorkloadHeatmapChart()
                ];
                
                const successCount = results.filter(r => r).length;
                const t1 = performance.now();
                const duration = (t1 - t0).toFixed(2);
                
                console.log(`[Chart] åœ–è¡¨åˆå§‹åŒ–å®Œæˆ: ${successCount}/4 å€‹åœ–è¡¨`);
                
            } catch (error) {
                console.error('[Chart] åœ–è¡¨åˆå§‹åŒ–å‡ºéŒ¯:', error);
            }
        }

        // äººå“¡å·¥æ™‚åˆ†ä½ˆåœ“é¤…åœ–
        function createUserHoursChart() {
            const ctx = document.getElementById('userHoursChart');
            if (!ctx) return false;

            const userHoursData = collectUserHoursData();
            
            if (userHoursChart) {
                userHoursChart.destroy();
            }

            userHoursChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: userHoursData.users,
                    datasets: [{
                        data: userHoursData.hours,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                            '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    animation: false,  // âš¡ ç¦ç”¨å‹•ç•«
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} å°æ™‚ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            return true;
        }

        // å°ˆæ¡ˆå·¥æ™‚åˆ†ä½ˆé•·æ¢åœ–
        function createProjectHoursChart() {
            const ctx = document.getElementById('projectHoursChart');
            if (!ctx) return false;

            const projectHoursData = collectProjectHoursData();
            
            if (projectHoursChart) {
                projectHoursChart.destroy();
            }

            projectHoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: projectHoursData.projects,
                    datasets: [{
                        label: 'å°ˆæ¡ˆå·¥æ™‚',
                        data: projectHoursData.hours,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    animation: false,  // âš¡ ç¦ç”¨å‹•ç•«
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw} å°æ™‚`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å·¥æ™‚ (å°æ™‚)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'å°ˆæ¡ˆåç¨±'
                            },
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
            return true;
        }

        // å·¥æ™‚è¶¨å‹¢æŠ˜ç·šåœ–
        function createWorkloadTrendChart() {
            const ctx = document.getElementById('workloadTrendChart');
            if (!ctx) {
                console.error('[Chart] workloadTrendChart canvas å…ƒç´ ä¸å­˜åœ¨');
                return false;
            }

            const trendData = collectWorkloadTrendData();
            
            // æª¢æŸ¥æ•¸æ“šæœ‰æ•ˆæ€§
            if (!trendData || !trendData.periods || !trendData.users || trendData.users.length === 0) {
                console.warn('[Chart] å·¥æ™‚è¶¨å‹¢åœ–è¡¨ç„¡æ•¸æ“š', trendData);
                return false;
            }
            
            if (workloadTrendChart) {
                workloadTrendChart.destroy();
            }

            workloadTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.periods,
                    datasets: trendData.users.map((user, index) => ({
                        label: user.name,
                        data: user.workloads,
                        borderColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                        ][index % 8],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.1)', 'rgba(118, 75, 162, 0.1)', 
                            'rgba(240, 147, 251, 0.1)', 'rgba(245, 87, 108, 0.1)',
                            'rgba(79, 172, 254, 0.1)', 'rgba(0, 242, 254, 0.1)', 
                            'rgba(67, 233, 123, 0.1)', 'rgba(56, 249, 215, 0.1)'
                        ][index % 8],
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    }))
                },
                options: {
                    animation: false,  // âš¡ ç¦ç”¨å‹•ç•«
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å·¥ä½œè² è¼‰ (å°æ™‚)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ™‚é–“é€±æœŸ'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
            
            console.log(`[Chart] âœ… å·¥æ™‚è¶¨å‹¢åœ–è¡¨å·²å‰µå»º`);
            return true;
        }

        // å·¥ä½œè² è¼‰ç†±åŠ›åœ–ï¼ˆä½¿ç”¨é•·æ¢åœ–æ¨¡æ“¬ï¼‰
        function createWorkloadHeatmapChart() {
            const ctx = document.getElementById('workloadHeatmapChart');
            if (!ctx) {
                console.error('[Chart] workloadHeatmapChart canvas å…ƒç´ ä¸å­˜åœ¨');
                return false;
            }

            const heatmapData = collectWorkloadHeatmapData();
            
            // æª¢æŸ¥æ•¸æ“šæœ‰æ•ˆæ€§
            if (!heatmapData || !heatmapData.periods || !heatmapData.users || heatmapData.users.length === 0) {
                console.warn('[Chart] å·¥ä½œè² è¼‰ç†±åŠ›åœ–ç„¡æ•¸æ“š', heatmapData);
                return false;
            }
            
            if (workloadHeatmapChart) {
                workloadHeatmapChart.destroy();
            }

            workloadHeatmapChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: heatmapData.periods,
                    datasets: heatmapData.users.map((user, index) => ({
                        label: user.name,
                        data: user.workloads,
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)', 'rgba(118, 75, 162, 0.8)', 
                            'rgba(240, 147, 251, 0.8)', 'rgba(245, 87, 108, 0.8)',
                            'rgba(79, 172, 254, 0.8)', 'rgba(0, 242, 254, 0.8)', 
                            'rgba(67, 233, 123, 0.8)', 'rgba(56, 249, 215, 0.8)'
                        ][index % 8],
                        borderColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                        ][index % 8],
                        borderWidth: 1
                    }))
                },
                options: {
                    animation: false,  // âš¡ ç¦ç”¨å‹•ç•«
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'æ™‚é–“é€±æœŸ'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ç´¯è¨ˆå·¥ä½œè² è¼‰ (å°æ™‚)'
                            }
                        }
                    }
                }
            });
            
            console.log(`[Chart] âœ… å·¥ä½œè² è¼‰ç†±åŠ›åœ–å·²å‰µå»º`);
            return true;
        }

        // æ”¶é›†äººå“¡å·¥æ™‚æ•¸æ“šï¼ˆå„ªåŒ–ï¼šä½¿ç”¨å…§å­˜å¿«å–ï¼‰
        function collectUserHoursData() {
            const t0 = performance.now();
            const cache = window.__WL_CACHE__;
            
            // å›é€€æ–¹æ¡ˆï¼šå¦‚æœå¿«å–æœªåˆå§‹åŒ–
            if (!cache) {
                console.warn('[Chart] Cache æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨ DOM æŸ¥è©¢ï¼ˆè¼ƒæ…¢ï¼‰');
                return collectUserHoursDataFallback();
            }
            
            const userHours = {};
            
            // âœ… å„ªåŒ–ï¼šç›´æ¥å¾å¿«å–è®€å–ï¼ˆO(n)ï¼Œn = ç”¨æˆ¶æ•¸é‡ï¼‰
            for (const userName in cache.users) {
                const userObj = cache.users[userName];
                if (userObj.checkbox && userObj.checkbox.checked) {
                    const hours = parseFloat(userObj.checkbox.getAttribute('data-hours')) || 0;
                    if (hours > 0) {
                        userHours[userName] = hours;
                    }
                }
            }
            
            if (cache.DEBUG) {
                console.log(`[Perf] collectUserHoursData: ${(performance.now()-t0).toFixed(2)}ms (ä½¿ç”¨å¿«å–)`);
            }
            
            return {
                users: Object.keys(userHours),
                hours: Object.values(userHours)
            };
        }
        
        // å›é€€æ–¹æ¡ˆï¼šä½¿ç”¨ DOM æŸ¥è©¢
        function collectUserHoursDataFallback() {
            const userHours = {};
            const userRows = document.querySelectorAll('tbody tr[data-level="0"]');
            userRows.forEach(row => {
                const userName = row.getAttribute('data-user');
                const checkbox = row.querySelector('input[data-issue="-1"]');
                if (checkbox && checkbox.checked) {
                    const hours = parseFloat(checkbox.getAttribute('data-hours')) || 0;
                    if (hours > 0) {
                        userHours[userName] = hours;
                    }
                }
            });
            return {
                users: Object.keys(userHours),
                hours: Object.values(userHours)
            };
        }

        // æ”¶é›†å°ˆæ¡ˆå·¥æ™‚æ•¸æ“šï¼ˆå„ªåŒ–ï¼šä½¿ç”¨å…§å­˜å¿«å–ï¼‰
        function collectProjectHoursData() {
            const t0 = performance.now();
            const cache = window.__WL_CACHE__;
            
            // å›é€€æ–¹æ¡ˆï¼šå¦‚æœå¿«å–æœªåˆå§‹åŒ–
            if (!cache) {
                console.warn('[Chart] Cache æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨ DOM æŸ¥è©¢ï¼ˆè¼ƒæ…¢ï¼‰');
                return collectProjectHoursDataFallback();
            }
            
            const projectHours = {};
            
            // âœ… å„ªåŒ–ï¼šç›´æ¥å¾å¿«å–è®€å–ï¼ˆO(n)ï¼Œn = å°ˆæ¡ˆæ•¸é‡ï¼‰
            for (const projectKey in cache.projects) {
                const projectObj = cache.projects[projectKey];
                if (projectObj.checkbox && projectObj.checkbox.checked) {
                    const hours = parseFloat(projectObj.checkbox.getAttribute('data-hours')) || 0;
                    if (hours > 0) {
                        const projectName = projectObj.project;
                        if (!projectHours[projectName]) {
                            projectHours[projectName] = 0;
                        }
                        projectHours[projectName] += hours;
                    }
                }
            }
            
            if (cache.DEBUG) {
                console.log(`[Perf] collectProjectHoursData: ${(performance.now()-t0).toFixed(2)}ms (ä½¿ç”¨å¿«å–)`);
            }
            
            return {
                projects: Object.keys(projectHours),
                hours: Object.values(projectHours)
            };
        }
        
        // å›é€€æ–¹æ¡ˆï¼šä½¿ç”¨ DOM æŸ¥è©¢
        function collectProjectHoursDataFallback() {
            const projectHours = {};
            const projectRows = document.querySelectorAll('tbody tr[data-level="1"]');
            projectRows.forEach(row => {
                const projectName = row.getAttribute('data-project');
                const checkbox = row.querySelector('input[data-issue="-2"]');
                if (checkbox && checkbox.checked) {
                    const hours = parseFloat(checkbox.getAttribute('data-hours')) || 0;
                    if (hours > 0) {
                        if (!projectHours[projectName]) {
                            projectHours[projectName] = 0;
                        }
                        projectHours[projectName] += hours;
                    }
                }
            });
            return {
                projects: Object.keys(projectHours),
                hours: Object.values(projectHours)
            };
        }

        // æ”¶é›†å·¥æ™‚è¶¨å‹¢æ•¸æ“šï¼ˆä½¿ç”¨å¿«å–ï¼‰: åªç´å…¥ç›®å‰å‹¾é¸çš„ ISSUEï¼Œéæ¿¾å…¨é›¶ä½¿ç”¨è€…
        function collectWorkloadTrendData() {
            const cache = window.__WL_CACHE__;
            
            // å›é€€æ–¹æ¡ˆï¼šå¦‚æœå¿«å–æœªåˆå§‹åŒ–
            if (!cache) {
                console.warn('[Chart] Cache æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨ DOM æŸ¥è©¢ï¼ˆè¼ƒæ…¢ï¼‰');
                return collectWorkloadTrendDataFallback();
            }
            
            if (!cache.issues || cache.issues.length === 0) {
                console.warn('[Chart] å¿«å–ä¸­æ²’æœ‰è­°é¡Œæ•¸æ“š');
                return { periods: [], users: [] };
            }
            
            const userWorkloads = {};
            let periods = [];
            let periodCount = 0;

            // å–å¾—æˆ–å»ºç«‹ period æ¨™ç±¤ï¼ˆå„ªå…ˆä½¿ç”¨è¡¨é ­ th.date-header æ–‡å­—ï¼‰
            if (!cache.periodLabels) {
                const headerThs = document.querySelectorAll('thead tr:last-child th.date-header');
                const labels = [];
                headerThs.forEach(th => {
                    const txt = th.textContent.trim();
                    if (txt) labels.push(txt);
                });
                cache.periodLabels = labels.length > 0 ? labels : null;
            }

            if (cache.periodLabels && cache.periodLabels.length > 0) {
                periods = cache.periodLabels.slice();
                periodCount = periods.length;
            } else if (cache.issues.length > 0) {
                // å¾Œå‚™ï¼šæ ¹æ“šç¬¬ä¸€å€‹è­°é¡Œçš„ cell æ•¸æ±ºå®šé€±æœŸæ•¸
                const firstIssue = cache.issues[0];
                const firstCells = cache.cellsByIssue[firstIssue.issueId] || [];
                firstCells.forEach(cellObj => {
                    const idx = parseInt(cellObj.periodIndex);
                    if (!isNaN(idx)) periodCount = Math.max(periodCount, idx + 1);
                });
                periods = Array.from({length: periodCount}, (_, i) => `P${i+1}`);
                cache.periodLabels = periods.slice();
            }

            // åƒ…çµ±è¨ˆå‹¾é¸ä¸­çš„è­°é¡Œ
            for (const issue of cache.issues) {
                if (!issue.checkbox || !issue.checkbox.checked) continue;
                const userName = issue.user;
                if (!userWorkloads[userName]) userWorkloads[userName] = new Array(periodCount).fill(0);
                const cells = cache.cellsByIssue[issue.issueId] || [];
                for (const cellObj of cells) {
                    const periodIndex = parseInt(cellObj.periodIndex);
                    if (isNaN(periodIndex) || periodIndex < 0 || periodIndex >= periodCount) continue;
                    const workload = typeof cellObj.originalWorkload === 'number' ? cellObj.originalWorkload : 0;
                    if (workload > 0) userWorkloads[userName][periodIndex] += workload;
                }
            }

            // éæ¿¾æ‰å…¨ 0 çš„ä½¿ç”¨è€…
            const users = Object.keys(userWorkloads).filter(u => {
                return userWorkloads[u].some(v => v > 0);
            }).map(userName => ({ name: userName, workloads: userWorkloads[userName] }));
            
            console.log(`[Chart] è¶¨å‹¢æ•¸æ“š: ${users.length} ä½äººå“¡, ${periods.length} å€‹é€±æœŸ`);
            
            return { periods, users };
        }
        
        // å›é€€æ–¹æ¡ˆï¼šä½¿ç”¨ DOM æŸ¥è©¢
        function collectWorkloadTrendDataFallback() {
            const userWorkloads = {};
            const periods = [];
            
            const headerCells = document.querySelectorAll('thead tr:last-child th');
            headerCells.forEach((cell, index) => {
                if (index > 0) {
                    const text = cell.textContent.trim();
                    if (text && !text.includes('è³‡è¨Š')) {
                        periods.push(text);
                    }
                }
            });
            
            const issueRows = document.querySelectorAll('tbody tr[data-level="2"]');
            issueRows.forEach(row => {
                const userName = row.getAttribute('data-user');
                
                // åœ–è¡¨é¡¯ç¤ºã€Œæ‰€æœ‰ã€ISSUEï¼Œä¸å—å‹¾é¸ç‹€æ…‹å½±éŸ¿
                if (!userWorkloads[userName]) {
                    userWorkloads[userName] = new Array(periods.length).fill(0);
                }
                
                const workloadCells = row.querySelectorAll('td.workload-cell');
                workloadCells.forEach((cell, index) => {
                    const workload = parseFloat(cell.getAttribute('data-original-workload')) || 0;
                    if (index < userWorkloads[userName].length) {
                        userWorkloads[userName][index] += workload;
                    }
                });
            });
            
            const users = Object.keys(userWorkloads).map(userName => ({
                name: userName,
                workloads: userWorkloads[userName]
            }));
            
            return { periods, users };
        }

        // æ”¶é›†å·¥ä½œè² è¼‰ç†±åŠ›åœ–æ•¸æ“š
        function collectWorkloadHeatmapData() {
            // é‡ç”¨è¶¨å‹¢æ•¸æ“šï¼Œä½†ä»¥å †ç–Šæ–¹å¼å‘ˆç¾
            return collectWorkloadTrendData();
        }

        // æ›´æ–°æ‰€æœ‰åœ–è¡¨ï¼ˆç•¶æ•¸æ“šè®ŠåŒ–æ™‚èª¿ç”¨ï¼‰
        function updateCharts() {
            console.log('=== æ›´æ–°åœ–è¡¨ ===');
            
            // å»¶é²æ›´æ–°ä»¥ç¢ºä¿ DOM å·²æ›´æ–°
            setTimeout(() => {
                try {
                    if (userHoursChart) {
                        const userData = collectUserHoursData();
                        userHoursChart.data.labels = userData.users;
                        userHoursChart.data.datasets[0].data = userData.hours;
                        userHoursChart.update();
                    }
                    
                    if (projectHoursChart) {
                        const projectData = collectProjectHoursData();
                        projectHoursChart.data.labels = projectData.projects;
                        projectHoursChart.data.datasets[0].data = projectData.hours;
                        projectHoursChart.update();
                    }
                    
                    if (workloadTrendChart) {
                        const trendData = collectWorkloadTrendData();
                        workloadTrendChart.data.labels = trendData.periods;
                        workloadTrendChart.data.datasets = trendData.users.map((user, index) => ({
                            label: user.name,
                            data: user.workloads,
                            borderColor: [
                                '#667eea', '#764ba2', '#f093fb', '#f5576c',
                                '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                            ][index % 8],
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.1)', 'rgba(118, 75, 162, 0.1)', 
                                'rgba(240, 147, 251, 0.1)', 'rgba(245, 87, 108, 0.1)',
                                'rgba(79, 172, 254, 0.1)', 'rgba(0, 242, 254, 0.1)', 
                                'rgba(67, 233, 123, 0.1)', 'rgba(56, 249, 215, 0.1)'
                            ][index % 8],
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4
                        }));
                        workloadTrendChart.update();
                    }
                    
                    if (workloadHeatmapChart) {
                        const heatmapData = collectWorkloadHeatmapData();
                        workloadHeatmapChart.data.labels = heatmapData.periods;
                        workloadHeatmapChart.data.datasets = heatmapData.users.map((user, index) => ({
                            label: user.name,
                            data: user.workloads,
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)', 'rgba(118, 75, 162, 0.8)', 
                                'rgba(240, 147, 251, 0.8)', 'rgba(245, 87, 108, 0.8)',
                                'rgba(79, 172, 254, 0.8)', 'rgba(0, 242, 254, 0.8)', 
                                'rgba(67, 233, 123, 0.8)', 'rgba(56, 249, 215, 0.8)'
                            ][index % 8],
                            borderColor: [
                                '#667eea', '#764ba2', '#f093fb', '#f5576c',
                                '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                            ][index % 8],
                            borderWidth: 1
                        }));
                        workloadHeatmapChart.update();
                    }
                    
                    console.log('åœ–è¡¨æ›´æ–°å®Œæˆ');
                } catch (error) {
                    console.error('åœ–è¡¨æ›´æ–°å‡ºéŒ¯:', error);
                }
            }, 100);
        }

        // === ç¯©é¸è¡¨å–®ç›¸é—œåŠŸèƒ½ ===
        
        // è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
        async function loadUsers() {
            const groupName = document.getElementById('groupName').value;
            const userSelect = document.getElementById('userFullname');
            
            // ä¿å­˜ç•¶å‰é¸ä¸­çš„ä½¿ç”¨è€…
            const currentSelected = Array.from(userSelect.selectedOptions).map(option => option.value);
            
            // æ¸…ç©ºç¾æœ‰é¸é …ï¼Œä¿ç•™å…¨éƒ¨æˆå“¡é¸é …
            userSelect.innerHTML = '<option value="">ğŸ¢ å…¨éƒ¨æˆå“¡ (æ•´å€‹éƒ¨é–€)</option>';
            
            if (!groupName) {
                return;
            }
            
            try {
                const response = await fetch(`/api/users/${encodeURIComponent(groupName)}`);
                if (response.ok) {
                    const users = await response.json();
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user;
                        option.textContent = user;
                        // å¦‚æœä¹‹å‰å·²é¸ä¸­ï¼Œç¶­æŒé¸ä¸­ç‹€æ…‹
                        if (currentSelected.includes(user)) {
                            option.selected = true;
                        }
                        userSelect.appendChild(option);
                    });
                } else {
                    console.error('è¼‰å…¥ä½¿ç”¨è€…å¤±æ•—:', response.status);
                }
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }
        
        // é‡ç½®è¡¨å–®
        function resetForm() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰ç¯©é¸æ¢ä»¶å—ï¼Ÿ')) {
                document.getElementById('workload2dForm').reset();
                document.getElementById('userFullname').innerHTML = '<option value="">ğŸ¢ å…¨éƒ¨æˆå“¡ (æ•´å€‹éƒ¨é–€)</option>';
            }
        }
        
        // è¡¨å–®æäº¤é©—è­‰
        document.getElementById('workload2dForm').addEventListener('submit', function(e) {
            const groupName = document.getElementById('groupName').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!groupName || !startDate || !endDate) {
                e.preventDefault();
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
                return false;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                e.preventDefault();
                alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸï¼');
                return false;
            }
            
            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            if (window.__WL_CONFIG__ && window.__WL_CONFIG__.enableLoadingOverlay) {
                showLoading('é‡æ–°åˆ†æä¸­...', 'æ­£åœ¨è¼‰å…¥æ–°çš„åˆ†æçµæœ');
            }
        });
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–ä½¿ç”¨è€…åˆ—è¡¨ï¼ˆèˆ‡ç¾æœ‰åˆå§‹åŒ–æ•´åˆï¼‰
        function initializeUserSelect() {
            const groupSelect = document.getElementById('groupName');
            if (groupSelect && groupSelect.value) {
                loadUsers();
            }
        }
        
        // åœ¨çµ±ä¸€çš„é é¢åˆå§‹åŒ–ä¸­åŠ å…¥ä½¿ç”¨è€…é¸å–®åˆå§‹åŒ–
        const originalInitializePage = initializePage;
        initializePage = function() {
            originalInitializePage();
            // åˆå§‹åŒ–ä½¿ç”¨è€…é¸å–®
            setTimeout(initializeUserSelect, 100);
        };
    </script>
</body>
</html>