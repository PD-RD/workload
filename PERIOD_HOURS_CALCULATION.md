# 📊 區間工時計算功能

## 🎯 問題說明

**修改前：**
- workload2d 中的人員總工時顯示的是**整個議題的預估工時**
- 不考慮用戶設定的時間區間（開始日期到結束日期）
- 例如：議題跨越 3 個月但只查詢 1 週，仍顯示 3 個月的工時

**修改後：**
- 人員總工時顯示**用戶設定區間內的實際工時**
- 根據每日/每週/每月的工作量加總計算
- 例如：議題跨越 3 個月但只查詢 1 週，只顯示該週的工時

## 🔧 技術修改

### 1. data-hours 屬性修改

#### 修改前
```html
data-hours=${item.estimatedHours}
```
**問題：**使用整個議題的預估工時，不考慮時間區間

#### 修改後
```html
data-hours=${item.issueId > 0 ? 
    (timeGranularity == 'daily' ? 
        #aggregates.sum(item.dailyWorkloads.![T(java.lang.Double).parseDouble(status)]) :
        #aggregates.sum(item.periodWorkloads.![T(java.lang.Double).parseDouble(status)])
    ) : item.estimatedHours}
```

**改進：**
- **實際議題 (issueId > 0)**：使用區間內工作量加總
- **每日模式**：加總 `dailyWorkloads` 的所有天數
- **每週/每月模式**：加總 `periodWorkloads` 的所有週期
- **總計行 (issueId ≤ 0)**：維持使用 `estimatedHours`

### 2. 總工時顯示修改

#### 使用者總計行
```html
data-original-hours=${timeGranularity == 'daily' ? 
    #aggregates.sum(item.dailyWorkloads.![T(java.lang.Double).parseDouble(status)]) :
    #aggregates.sum(item.periodWorkloads.![T(java.lang.Double).parseDouble(status)])}
```

#### 專案總計行
```html
data-original-hours=${timeGranularity == 'daily' ? 
    #aggregates.sum(item.dailyWorkloads.![T(java.lang.Double).parseDouble(status)]) :
    #aggregates.sum(item.periodWorkloads.![T(java.lang.Double).parseDouble(status)])}
```

### 3. 議題詳細顯示增強

#### 修改前
```html
<span>預估: 120.0 小時</span>
```

#### 修改後
```html
<span>預估: 120.0 小時</span><br/>
<span>區間: 24.0 小時</span>
```

**新增：**
- 顯示議題在設定區間內的實際工時
- 方便用戶比較預估工時 vs 區間工時

## 📊 計算邏輯

### 每日模式 (timeGranularity == 'daily')
```
區間工時 = 議題的每日工作量加總
= dailyWorkloads[0] + dailyWorkloads[1] + ... + dailyWorkloads[n]
```

### 每週模式 (timeGranularity == 'weekly')
```
區間工時 = 議題的每週工作量加總
= periodWorkloads[0] + periodWorkloads[1] + ... + periodWorkloads[n]
```

### 每月模式 (timeGranularity == 'monthly')
```
區間工時 = 議題的每月工作量加總
= periodWorkloads[0] + periodWorkloads[1] + ... + periodWorkloads[n]
```

## 🧪 示例場景

### 場景 1：跨越多個月的議題

**議題資訊：**
- 議題 #123：2025-10-01 ~ 2025-12-31
- 預估工時：120.0 小時
- 每月分配：10月 40hrs、11月 40hrs、12月 40hrs

**查詢條件：**
- 時間區間：2025-10-15 ~ 2025-10-31
- 模式：每日

**修改前顯示：**
```
📋 議題 #123
預估: 120.0 小時
總工時: 120.0 小時  ← 錯誤！顯示整個議題工時
```

**修改後顯示：**
```
📋 議題 #123
預估: 120.0 小時
區間: 25.6 小時     ← 正確！只顯示10/15~10/31的工時
總工時: 25.6 小時   ← 正確！使用區間內工時
```

### 場景 2：短期議題

**議題資訊：**
- 議題 #456：2025-10-20 ~ 2025-10-22
- 預估工時：24.0 小時
- 每日分配：10/20 8hrs、10/21 8hrs、10/22 8hrs

**查詢條件：**
- 時間區間：2025-10-15 ~ 2025-10-31
- 模式：每日

**修改前顯示：**
```
📋 議題 #456
預估: 24.0 小時
總工時: 24.0 小時
```

**修改後顯示：**
```
📋 議題 #456
預估: 24.0 小時
區間: 24.0 小時     ← 一致，因為議題完全在區間內
總工時: 24.0 小時
```

### 場景 3：部分重疊議題

**議題資訊：**
- 議題 #789：2025-10-01 ~ 2025-10-20
- 預估工時：80.0 小時
- 每日分配：4hrs/day × 20天

**查詢條件：**
- 時間區間：2025-10-15 ~ 2025-10-31
- 模式：每日

**修改前顯示：**
```
📋 議題 #789
預估: 80.0 小時
總工時: 80.0 小時  ← 錯誤！
```

**修改後顯示：**
```
📋 議題 #789
預估: 80.0 小時
區間: 24.0 小時    ← 正確！只有10/15~10/20的工時 (6天×4hrs)
總工時: 24.0 小時  ← 正確！
```

## 💡 計算統計的影響

### 成本統計面板
```
修改前：
納入計算: 244.0 hrs  ← 使用預估工時加總
排除計算: 0.0 hrs
總工時: 244.0 hrs

修改後：
納入計算: 73.6 hrs   ← 使用區間工時加總  
排除計算: 0.0 hrs
總工時: 73.6 hrs
```

### 人員總計行
```
修改前：
👤 張三 - 總工時: 120.0 小時

修改後：  
👤 張三 - 總工時: 36.8 小時 (區間內實際工時)
```

### 專案總計行
```
修改前：
📁 專案A - 總工時: 200.0 小時

修改後：
📁 專案A - 總工時: 58.4 小時 (區間內實際工時)
```

## ✅ 優點

### 1. 準確性
- ✅ 總工時反映實際查詢區間
- ✅ 避免誤導性的工時統計
- ✅ 成本計算更精確

### 2. 一致性
- ✅ 工作量單元格 與 總工時 一致
- ✅ 每日/每週/每月 模式都正確
- ✅ 所有計算基於相同的時間範圍

### 3. 實用性
- ✅ 方便短期項目規劃
- ✅ 準確的資源分配評估
- ✅ 更好的工作量預測

### 4. 透明度
- ✅ 同時顯示預估工時和區間工時
- ✅ 用戶可以比較差異
- ✅ 清楚知道計算基礎

## 🧪 測試驗證

### 測試步驟
1. **選擇時間區間**：2025-10-15 ~ 2025-10-31
2. **選擇人員**：劉安元、劉鎧維
3. **檢查議題詳細**：
   - 查看 "預估" vs "區間" 工時差異
   - 確認區間工時 = 各時間段工作量加總
4. **檢查總計行**：
   - 人員總工時 = 該人員所有議題的區間工時加總
   - 專案總工時 = 該專案所有議題的區間工時加總
5. **檢查成本統計**：
   - 總工時 = 所有勾選議題的區間工時加總

### 驗證公式
```
人員區間工時 = Σ(該人員所有議題的區間工時)
專案區間工時 = Σ(該專案所有議題的區間工時)  
總計區間工時 = Σ(所有勾選議題的區間工時)
```

## 🎯 實際效益

### 場景：週報分析
**需求：**查看本週(10/14~10/20)的工作量

**修改前：**
- 顯示包含跨月議題的完整預估工時
- 無法準確評估本週實際工作量
- 容易高估資源需求

**修改後：**
- 只顯示本週實際工作量
- 準確反映當週工作負荷
- 精確的短期規劃參考

### 場景：月度檢討
**需求：**檢討 10 月份的工作成果

**修改前：**
- 包含跨季度議題的全部工時
- 無法區分本月貢獻度
- 績效評估不準確

**修改後：**
- 只計算 10 月份的實際工時
- 準確反映月度貢獻
- 公平的績效評估基礎

## 📈 總結

這次修改讓 workload2d 的工時計算：

1. **更準確** - 基於實際查詢區間
2. **更實用** - 支援短期規劃分析  
3. **更直觀** - 工時與時間段一致
4. **更透明** - 同時顯示預估和區間工時

現在人員總工時真正反映了用戶設定區間內的實際工作量！🎉