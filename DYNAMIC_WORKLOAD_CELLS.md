# 動態更新時間段工作量功能

## 🎯 功能說明

當取消勾選某個 ISSUE 時，會自動更新：
1. ✅ **專案總計行**的每日/每週/每月工作量
2. ✅ **人員總計行**的每日/每週/每月工作量  
3. ✅ **總工時顯示**（已在前一版本實現）
4. ✅ **成本統計面板**（已在前一版本實現）

## 📊 工作量更新邏輯

### 每日模式 (Daily)
取消某個 ISSUE 時：
- 該 ISSUE 的每日工作量從專案和人員的每日總計中扣除
- 只保留已勾選 ISSUE 的工作量總和

### 每週模式 (Weekly)
取消某個 ISSUE 時：
- 該 ISSUE 的每週工作量從專案和人員的每週總計中扣除
- 按週期重新計算工作量總和

### 每月模式 (Monthly)
取消某個 ISSUE 時：
- 該 ISSUE 的每月工作量從專案和人員的每月總計中扣除
- 按月份重新計算工作量總和

## 🔄 完整的更新流程

```
用戶取消勾選 ISSUE
         ↓
更新 checkbox 狀態
         ↓
更新父層狀態 (專案/人員 indeterminate)
         ↓
更新視覺樣式 (排除背景色)
         ↓
更新成本統計面板 (納入/排除工時統計)
         ↓
更新總計行工時顯示 (總工時文字)
         ↓
更新時間段工作量 ← 新增！
  - 重新計算每個時間段的工作量
  - 只累計已勾選的 ISSUE
  - 更新專案總計行的每個單元格
  - 更新人員總計行的每個單元格
  - 動態調整樣式 (顏色高亮)
```

## 💻 技術實現

### HTML 結構增強

為每個工作量單元格添加了數據屬性：

```html
<!-- 每日模式 -->
<td class="workload-cell"
    data-user="張三"
    data-project="專案A"
    data-issue="123"
    data-period-index="0"
    data-original-workload="8.0"
    data-weekend="false"
    data-overdue="false">
    8.0
</td>

<!-- 人員總計行 -->
<td class="workload-cell"
    data-user="張三"
    data-issue="-1"
    data-period-index="0">
    24.0
</td>

<!-- 專案總計行 -->
<td class="workload-cell"
    data-user="張三"
    data-project="專案A"
    data-issue="-2"
    data-period-index="0">
    24.0
</td>
```

### JavaScript 函數

#### 1. `updateWorkloadCells()`
主要功能函數，負責：

**步驟 1: 收集數據**
```javascript
// 掃描所有工作量單元格
// 只處理實際 ISSUE (issueId > 0)
// 檢查對應的 checkbox 是否勾選
```

**步驟 2: 統計工作量**
```javascript
// 按人員和時間段統計
userPeriodData[userName][periodIndex] = 累計已勾選的工作量

// 按專案和時間段統計  
projectPeriodData[projectKey][periodIndex] = 累計已勾選的工作量
```

**步驟 3: 更新顯示**
```javascript
// 更新人員總計行的每個時間段單元格
cell.textContent = newWorkload.toFixed(1)

// 更新專案總計行的每個時間段單元格
cell.textContent = newWorkload.toFixed(1)

// 更新樣式類別
updateWorkloadCellStyle(cell, workload)
```

#### 2. `updateWorkloadCellStyle()`
動態調整樣式類別：

```javascript
if (workload === 0) {
    cell.classList.add('workload-zero');        // 灰色
} else if (workload >= 8.0) {
    cell.classList.add('workload-high');        // 紅色
} else {
    cell.classList.add('workload-normal');      // 綠色
}
```

## 📈 示例場景

### 場景 1: 每日模式

```
初始狀態 (10月15日):
👤 張三 - 總工時: 24.0 小時
  10/15: 8.0 | 10/16: 8.0 | 10/17: 8.0
  
  📁 專案A - 總工時: 24.0 小時
    10/15: 8.0 | 10/16: 8.0 | 10/17: 8.0
    
    ✓ ISSUE #1 (10/15~10/15) - 8 hrs
    ✓ ISSUE #2 (10/16~10/16) - 8 hrs
    ✓ ISSUE #3 (10/17~10/17) - 8 hrs

↓ 取消 ISSUE #2 (10/16 的工作)

更新後:
👤 張三 - 總工時: 16.0 小時 (排除 8.0 小時)
  10/15: 8.0 | 10/16: 0.0 | 10/17: 8.0  ← 10/16 變為 0
  
  📁 專案A [部分選取] - 總工時: 16.0 小時 (排除 8.0 小時)
    10/15: 8.0 | 10/16: 0.0 | 10/17: 8.0  ← 10/16 變為 0
    
    ✓ ISSUE #1 (10/15~10/15) - 8 hrs
    ✗ ISSUE #2 (10/16~10/16) - 8 hrs [排除]
    ✓ ISSUE #3 (10/17~10/17) - 8 hrs
```

### 場景 2: 跨天 ISSUE

```
初始狀態:
👤 張三 - 總工時: 24.0 小時
  10/15: 8.0 | 10/16: 8.0 | 10/17: 8.0
  
  📁 專案A - 總工時: 24.0 小時
    10/15: 8.0 | 10/16: 8.0 | 10/17: 8.0
    
    ✓ ISSUE #1 (10/15~10/17) - 24 hrs
      10/15: 8.0 | 10/16: 8.0 | 10/17: 8.0

↓ 取消 ISSUE #1

更新後:
👤 張三 - 總工時: 0.0 小時 (排除 24.0 小時)
  10/15: 0.0 | 10/16: 0.0 | 10/17: 0.0  ← 所有天數都變為 0
  
  📁 專案A [未選] - 總工時: 0.0 小時 (排除 24.0 小時)
    10/15: 0.0 | 10/16: 0.0 | 10/17: 0.0  ← 所有天數都變為 0
    
    ✗ ISSUE #1 (10/15~10/17) - 24 hrs [排除]
```

### 場景 3: 多個 ISSUE 重疊

```
初始狀態 (10月15日):
👤 張三 - 總工時: 32.0 小時
  10/15: 16.0  ← ISSUE #1 (8hrs) + ISSUE #2 (8hrs)
  
  📁 專案A - 總工時: 32.0 小時
    10/15: 16.0
    
    ✓ ISSUE #1 (10/15~10/15) - 8 hrs
    ✓ ISSUE #2 (10/15~10/16) - 16 hrs → 10/15: 8hrs, 10/16: 8hrs

↓ 取消 ISSUE #1

更新後:
👤 張三 - 總工時: 24.0 小時 (排除 8.0 小時)
  10/15: 8.0   ← 只剩 ISSUE #2 的 8 hrs
  10/16: 8.0   ← ISSUE #2 的另外 8 hrs
  
  📁 專案A [部分選取] - 總工時: 24.0 小時 (排除 8.0 小時)
    10/15: 8.0
    10/16: 8.0
    
    ✗ ISSUE #1 (10/15~10/15) - 8 hrs [排除]
    ✓ ISSUE #2 (10/15~10/16) - 16 hrs
```

## 🎨 視覺效果

### 工作量顏色編碼

| 工作量 | 顏色 | CSS 類別 | 說明 |
|--------|------|----------|------|
| 0.0 | 灰色 | `workload-zero` | 沒有工作 |
| 0.1 - 7.9 | 綠色 | `workload-normal` | 正常工作量 |
| ≥ 8.0 | 紅色 | `workload-high` | 高工作量 |
| 週末 | 淡灰色背景 | `weekend` | 週末日期 |
| 逾期 | 橙色 | `workload-overdue` | 工作逾期 |

### 動態樣式更新

當取消勾選 ISSUE 時：
- 工作量減少 → 顏色可能從**紅色變綠色**
- 工作量變為 0 → 顏色變為**灰色**
- 重新勾選 → 顏色即時恢復

## 🧪 測試步驟

### 測試 1: 單個 ISSUE 取消
1. 開啟 2D 分析頁面（每日模式）
2. 觀察某個專案的每日工作量
3. 取消某個 ISSUE
4. **檢查點**：
   - ✅ 該 ISSUE 涉及的日期工作量減少
   - ✅ 專案總計行對應日期工作量減少
   - ✅ 人員總計行對應日期工作量減少
   - ✅ 顏色可能改變（紅→綠或綠→灰）

### 測試 2: 跨多天 ISSUE
1. 找一個跨越多天的 ISSUE
2. 取消勾選
3. **檢查點**：
   - ✅ 所有涉及的日期工作量都減少
   - ✅ 總計行的多個單元格都更新

### 測試 3: 重疊 ISSUE
1. 找同一天有多個 ISSUE 的情況
2. 取消其中一個
3. **檢查點**：
   - ✅ 該天工作量減少但不為 0
   - ✅ 其他 ISSUE 的工作量保留

### 測試 4: 每週/每月模式
1. 切換到每週或每月模式
2. 取消某個 ISSUE
3. **檢查點**：
   - ✅ 對應週期的工作量減少
   - ✅ 總計行更新正確

### 測試 5: 批量操作
1. 取消某個專案（所有 ISSUE）
2. **檢查點**：
   - ✅ 專案總計行所有時間段變為 0
   - ✅ 人員總計行相應減少
   - ✅ 所有單元格變為灰色

## 📋 數據流向

```
ISSUE Checkbox 狀態
         ↓
收集所有已勾選的 ISSUE
         ↓
按時間段分組統計
  ├─ 人員 × 時間段 → 累計工作量
  └─ 專案 × 時間段 → 累計工作量
         ↓
更新總計行單元格
  ├─ 更新文字內容 (workload.toFixed(1))
  └─ 更新樣式類別 (顏色)
```

## 🔍 除錯資訊

開啟瀏覽器 Console 可以看到：

```javascript
=== updateWorkloadCells 開始 ===
找到工作量單元格數量: 300
人員時間段數據: {
    "張三": {
        "0": 8.0,   // 第 0 個時間段 (10/15)
        "1": 0.0,   // 第 1 個時間段 (10/16) - 被排除
        "2": 8.0    // 第 2 個時間段 (10/17)
    }
}
專案時間段數據: {
    "張三|專案A": {
        "0": 8.0,
        "1": 0.0,
        "2": 8.0
    }
}
更新人員 張三 時段 0: 8.0 -> 8.0
更新人員 張三 時段 1: 8.0 -> 0.0  ← 變化
更新人員 張三 時段 2: 8.0 -> 8.0
更新專案 張三/專案A 時段 0: 8.0 -> 8.0
更新專案 張三/專案A 時段 1: 8.0 -> 0.0  ← 變化
更新專案 張三/專案A 時段 2: 8.0 -> 8.0
=== updateWorkloadCells 完成 ===
```

## ✅ 功能特點

1. **完全前端實現**
   - 不需要重新查詢後端
   - 即時響應用戶操作
   - 基於原始數據重新計算

2. **準確性**
   - 只累計已勾選的 ISSUE
   - 避免重複計算
   - 支持複雜的重疊情況

3. **視覺反饋**
   - 動態顏色變化
   - 清晰的數值顯示
   - 保留週末/逾期樣式

4. **完整性**
   - 同時更新專案和人員
   - 所有時間段都更新
   - 配合其他功能（總工時、成本統計）

5. **性能**
   - 一次掃描所有單元格
   - 批量更新避免重複計算
   - 高效的 DOM 操作

## 🎯 總結

現在取消某個 ISSUE 時，系統會：
1. ✅ 更新 checkbox 狀態和父層狀態
2. ✅ 更新視覺樣式（排除背景色）
3. ✅ 更新成本統計面板（納入/排除工時）
4. ✅ 更新總工時顯示（總計行文字）
5. ✅ **更新每日/每週/每月工作量（所有時間段單元格）** ← 新增！

所有更新都是**即時**且**準確**的，完全在前端實現，確保用戶獲得最佳體驗！
