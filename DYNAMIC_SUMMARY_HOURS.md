# 動態更新總計行工時顯示功能

## 🎯 功能說明

當取消勾選某個 ISSUE 時，會自動更新：
1. ✅ **專案總計行**的工時顯示 - 減去取消 ISSUE 的工時
2. ✅ **人員總計行**的工時顯示 - 減去取消 ISSUE 的工時
3. ✅ **成本統計面板**的數據 - 即時反映變化

## 📊 工時顯示格式

### 全選狀態
```
總工時: 24.0 小時
```

### 部分選取狀態
```
總工時: 16.0 小時 (排除 8.0 小時)
```
- 顯示納入計算的工時
- 括號內顯示被排除的工時

### 全不選狀態
```
總工時: 0.0 小時 (排除 24.0 小時)
```
- 顯示沒有納入任何工時
- 括號內顯示全部被排除的工時

## 🔄 動態更新流程

### 1. 取消單個 ISSUE
```
初始狀態：
👤 張三 - 總工時: 24.0 小時
  📁 專案A - 總工時: 24.0 小時
    ✓ ISSUE #1 - 8 hrs
    ✓ ISSUE #2 - 8 hrs
    ✓ ISSUE #3 - 8 hrs

↓ 取消 ISSUE #2

更新後：
👤 張三 - 總工時: 16.0 小時 (排除 8.0 小時)
  📁 專案A [部分選取] - 總工時: 16.0 小時 (排除 8.0 小時)
    ✓ ISSUE #1 - 8 hrs
    ✗ ISSUE #2 - 8 hrs [排除]
    ✓ ISSUE #3 - 8 hrs
```

### 2. 取消整個專案
```
初始狀態：
👤 張三 - 總工時: 40.0 小時
  📁 專案A - 總工時: 24.0 小時
  📁 專案B - 總工時: 16.0 小時

↓ 取消專案A

更新後：
👤 張三 - 總工時: 16.0 小時 (排除 24.0 小時)
  📁 專案A - 總工時: 0.0 小時 (排除 24.0 小時)
  📁 專案B - 總工時: 16.0 小時
```

### 3. 重新勾選 ISSUE
```
當前狀態：
👤 張三 - 總工時: 16.0 小時 (排除 8.0 小時)
  📁 專案A [部分選取] - 總工時: 16.0 小時 (排除 8.0 小時)
    ✓ ISSUE #1 - 8 hrs
    ✗ ISSUE #2 - 8 hrs [排除]
    ✓ ISSUE #3 - 8 hrs

↓ 重新勾選 ISSUE #2

更新後：
👤 張三 - 總工時: 24.0 小時
  📁 專案A [全選] - 總工時: 24.0 小時
    ✓ ISSUE #1 - 8 hrs
    ✓ ISSUE #2 - 8 hrs
    ✓ ISSUE #3 - 8 hrs
```

## 💻 技術實現

### HTML 結構
為總計行添加了可追蹤的屬性：

```html
<!-- 人員總計行 -->
<span id="user-hours-張三"
      data-user="張三"
      data-original-hours="24.0">
    總工時: 24.0 小時
</span>

<!-- 專案總計行 -->
<span id="project-hours-張三_專案A"
      data-user="張三"
      data-project="專案A"
      data-original-hours="24.0">
    總工時: 24.0 小時
</span>
```

### JavaScript 函數

#### `updateSummaryRowsHours()`
主要功能函數，負責：
1. **收集數據**：掃描所有 ISSUE checkbox
2. **統計工時**：
   - 按人員統計：納入工時、排除工時、總工時
   - 按專案統計：納入工時、排除工時、總工時
3. **更新顯示**：動態更新總計行的文字內容

#### 調用時機
每次 `updateCostStatistics()` 執行時自動調用，確保：
- 取消勾選 ISSUE → 立即更新總計行
- 勾選 ISSUE → 立即更新總計行
- 批量操作（全選/全不選） → 立即更新總計行

### 數據結構
```javascript
// 人員工時數據
userHours = {
    "張三": {
        total: 24.0,        // 總工時
        included: 16.0,     // 納入工時
        excluded: 8.0,      // 排除工時
        totalCount: 3,      // 總 ISSUE 數
        includedCount: 2    // 納入 ISSUE 數
    }
}

// 專案工時數據
projectHours = {
    "張三|專案A": {
        total: 24.0,
        included: 16.0,
        excluded: 8.0,
        totalCount: 3,
        includedCount: 2
    }
}
```

## 🎨 視覺效果

### 總計行狀態變化

1. **全選** (checkbox: ✓)
   - 工時顯示：`總工時: 24.0 小時`
   - 背景色：正常（無特殊樣式）

2. **部分選取** (checkbox: ✓ 但 indeterminate)
   - 工時顯示：`總工時: 16.0 小時 (排除 8.0 小時)`
   - 背景色：正常（無特殊樣式）
   - checkbox 顯示特殊圖示

3. **全不選** (checkbox: ✗)
   - 工時顯示：`總工時: 0.0 小時 (排除 24.0 小時)`
   - 背景色：淡紅色（表示排除）

## 🧪 測試場景

### 場景 1: 逐步取消 ISSUE
1. 開啟 2D 分析頁面，查詢有多個 ISSUE 的專案
2. 取消第一個 ISSUE
   - ✅ 專案工時減少該 ISSUE 的工時
   - ✅ 人員工時減少該 ISSUE 的工時
   - ✅ 顯示格式：`總工時: XX.X 小時 (排除 YY.Y 小時)`
3. 取消第二個 ISSUE
   - ✅ 專案工時繼續減少
   - ✅ 人員工時繼續減少
   - ✅ 排除工時累計增加
4. 取消所有 ISSUE
   - ✅ 專案工時變為 `0.0 小時`
   - ✅ 人員工時變為部分或全部排除

### 場景 2: 多專案情況
1. 查詢有多個專案的人員
2. 取消某個專案下的部分 ISSUE
   - ✅ 該專案工時減少
   - ✅ 人員總工時減少（跨專案統計）
3. 取消整個專案
   - ✅ 該專案工時變為 0
   - ✅ 人員工時反映所有專案的變化

### 場景 3: 重新勾選
1. 重新勾選之前取消的 ISSUE
   - ✅ 專案工時增加
   - ✅ 人員工時增加
   - ✅ 排除工時減少
2. 全部重新勾選
   - ✅ 顯示回到初始狀態：`總工時: XX.X 小時`

## 📋 功能特點

1. **即時響應**
   - 每次 checkbox 狀態改變都立即更新
   - 無需重新查詢後端

2. **準確計算**
   - 只計算實際 ISSUE 的工時
   - 不重複計算總計行
   - 支持跨專案統計

3. **清晰顯示**
   - 全選：只顯示總工時
   - 部分選取：顯示納入和排除工時
   - 全不選：強調全部排除

4. **階層連動**
   - ISSUE 變化 → 專案更新 → 人員更新
   - 專案變化 → 人員更新
   - 所有層級保持同步

## 🔍 除錯資訊

開啟瀏覽器 Console 可以看到：

```
=== updateSummaryRowsHours 開始 ===
人員工時統計: {
    "張三": {
        total: 24,
        included: 16,
        excluded: 8,
        totalCount: 3,
        includedCount: 2
    }
}
專案工時統計: {
    "張三|專案A": {
        total: 24,
        included: 16,
        excluded: 8,
        totalCount: 3,
        includedCount: 2
    }
}
更新人員 張三: 總工時: 24.0 小時 -> 總工時: 16.0 小時 (排除 8.0 小時)
更新專案 張三/專案A: 總工時: 24.0 小時 -> 總工時: 16.0 小時 (排除 8.0 小時)
=== updateSummaryRowsHours 完成 ===
```

## ✅ 完整流程

當用戶操作時：
1. 點擊 checkbox → `toggleCostCalculation()`
2. 更新 checkbox 狀態 → `updateProjectCheckboxState()` / `updateParentCheckboxState()`
3. 更新視覺樣式 → `toggleRowCostExclusion()`
4. **更新成本統計 → `updateCostStatistics()`**
5. **更新總計行工時 → `updateSummaryRowsHours()` ← 新增！**

所有步驟都在前端完成，確保即時響應和準確計算！
